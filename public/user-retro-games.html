<!DOCTYPE html>
<html lang="ko" data-env="production" data-analytics="on">
<head>
  <!--#include file="/partials/head-seo.html" -->

  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />

  <!-- Google AdSense ì†Œìœ ê¶Œ í™•ì¸ ë©”íƒ€ íƒœê·¸ -->
  <meta name="google-adsense-account" content="ca-pub-6713974265397310">

  <title>RETRO GAMES â€“ Neon Home (Logged-in)</title>

  <link rel="icon" type="image/svg+xml" href="/assets/favicon.svg">
  <link rel="alternate icon" href="/favicon.ico">

  <!-- ì‹¤ì œ Google AdSense(ìë™ê´‘ê³ ) ê³µí†µ ì½”ë“œ -->
  <script async
          src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6713974265397310"
          crossorigin="anonymous"></script>

  <!-- ì „ì—­ ìŠ¤í¬ë¦½íŠ¸(App.js ìµœì‹ ë³¸ + Analytics) -->
  <script defer src="/assets/js/app.js"></script>
  <script defer src="/assets/js/analytics.js"></script>

  <style>
    /***********************************************************************
     *
     *  RETRO GAMES â€” user-retro-games.html
     *  ìµœì‹  App.js êµ¬ì¡° ëŒ€ì‘ í†µí•©ë³¸
     *  UI/ë ˆì´ì•„ì›ƒ/ìƒ‰ìƒ/ë¹„ìœ¨ 100% ìœ ì§€
     *  ì„¸ì…˜/HUD/ì§€ê°‘ ì‹œìŠ¤í…œ ì™„ì „ í†µí•©
     *  (Block 1/5 â€” Styling + Header + HUD + Layout)
     *
     ***********************************************************************/

    :root{
      --gold1:#ffdf6e;
      --gold2:#ffb84d;
      --blue1:#2b7bff;
      --blue2:#0048ff;
      --bg:#0b001e;
      --gapY:24px;

      /* ì•ˆì „ ì—¬ë°±(ë…¸ì¹˜) */
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-right: env(safe-area-inset-right, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-left: env(safe-area-inset-left, 0px);
    }

    *{ box-sizing:border-box; }

    html,body{
      height:100%;
      margin:0;
      background:radial-gradient(circle at 40% -10%,#320076,#0b001e 70%);
      font-family:'Segoe UI',system-ui,Apple SD Gothic Neo,sans-serif;
      color:#fff;
      -webkit-text-size-adjust:100%;
      text-size-adjust:100%;
    }

    body{
      padding:var(--safe-top) var(--safe-right)
              var(--safe-bottom) var(--safe-left);
    }

    .wrap{
      min-height:100%;
      display:grid;
      grid-template-rows:auto 1fr auto;
    }

    /***********************************************************************
     * HEADER
     ***********************************************************************/
    header{
      position:relative;
      text-align:center;
      padding:22px 18px;
      display:block;
    }

    .title{
      font-size:clamp(28px,3.2vw,36px);
      font-weight:900;
      letter-spacing:.5px;
      color:var(--gold1);
      text-shadow:0 0 18px var(--gold2);
    }

    .subtitle{
      opacity:.9;
      margin:0;
      text-align:center;
      margin-bottom:6px;
      font-size:clamp(13px,1.6vw,16px);
    }

    .subtitle.user-greeting{
      opacity:.85;
      font-size:clamp(12px,1.4vw,15px);
      margin-top:2px;
      margin-bottom:4px;
    }

    /***********************************************************************
     * HUD â€” ì¢Œì¸¡ Pill ì˜ì—­
     ***********************************************************************/
    .hudTop{
      position:absolute;
      left:40px;
      top:50%;
      transform:translateY(-50%);
      display:flex;
      flex-wrap:wrap;
      gap:8px 8px;
      align-items:center;
      justify-content:flex-start;
      max-width:60vw;
    }

    /* ìš°ì¸¡ ì„¤ì • ë²„íŠ¼ */
    .auth{
      position:absolute;
      right:40px;
      top:50%;
      transform:translateY(-50%);
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
    }
    .authbtn{
      padding:8px 14px;
      border-radius:12px;
      border:1px solid #3e2b7b;
      background:linear-gradient(180deg,#1a2b7a,#0a1a64);
      font-weight:900;
      color:#e9f0ff;
      box-shadow:0 6px 12px #0006;
      cursor:pointer;
      font-size:13px;
      white-space:nowrap;
    }
    .authbtn.alt{ display:none; }

    /***********************************************************************
     * Main ì˜ì—­ + Card List
     ***********************************************************************/
    .content{
      width:100%;
      display:flex;
      justify-content:center;
    }

    main{
      max-width:1200px;
      width:100%;
      margin:0 auto;
      padding:0 22px 12px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      gap:0;
      min-height:0;
    }

    .stack{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      gap:18px;
      transform:translateY(-36px);
      width:100%;
    }

    /* Pill HUD Common */
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:16px;
      background:linear-gradient(180deg,#0c1430,#0a0f26);
      border:1px solid #3857bd;
      box-shadow:0 6px 16px #0008, inset 0 0 18px #102265;
      white-space:nowrap;
    }

    .pill .icon{
      width:22px;
      height:22px;
      display:grid;
      place-items:center;
      border-radius:50%;
      background:radial-gradient(circle at 30% 30%,#8bb3ff,#3a7bff);
      box-shadow:0 0 10px #6fb0ffaa;
      font-size:14px;
    }

    .pill .label{
      font-weight:900;
      letter-spacing:.3px;
    }

    .pill.shop .label,
    .pill.rank .label{
      color:#ffe9a3;
      text-shadow:0 0 8px #ffd86a;
    }

    .amount{
      font-size:18px;
      color:#ffe9a3;
      text-shadow:0 0 8px #ffd86a;
    }

    .unit{
      opacity:.8;
      margin-left:2px;
      font-size:12px;
    }

    .sr-only{
      position:absolute;
      width:1px;
      height:1px;
      padding:0;
      margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      white-space:nowrap;
      border:0;
    }

    /***********************************************************************
     * í™©ê¸ˆ ë²„íŠ¼ (ì˜¤ëŠ˜ì˜ í–‰ìš´ ë½‘ê¸°)
     ***********************************************************************/
    .ctaWrap{
      display:flex;
      justify-content:center;
      margin:0;
      width:100%;
    }

    .goldBtn{
      position:relative;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:22px 64px;
      min-width:min(72vw,720px);
      max-width:100%;
      border:none;
      border-radius:14px;
      cursor:pointer;
      background:radial-gradient(120% 200% at 50% -80%,
        #fff6b0 0%, #ffd24a 38%, #ffb320 68%, #f39a15 100%),
        linear-gradient(180deg,#ffe889 0%,#ffc83d 40%,#ffb020 100%);
      box-shadow:0 10px 18px rgba(0,0,0,.38),
                 inset 0 6px 14px rgba(255,255,255,.55),
                 inset 0 -12px 18px rgba(176,88,0,.45);
      isolation:isolate;
      transform:translateZ(0);
    }

    .goldBtn::before,
    .goldBtn::after{
      content:"";
      position:absolute;
      top:50%;
      width:110px;
      height:34px;
      margin-top:-10px;
      background:linear-gradient(180deg,#ffd870 0%,#f2a41b 85%),
                 linear-gradient(180deg,#ffec9c,#ffcf47);
      box-shadow:0 8px 12px rgba(0,0,0,.25),
                 inset 0 -8px 10px rgba(140,70,0,.35);
      z-index:-1;
    }

    .goldBtn::before{
      left:-64px;
      border-radius:6px 0 6px 6px;
      transform:skewX(-18deg);
    }
    .goldBtn::after{
      right:-64px;
      border-radius:0 6px 6px 6px;
      transform:skewX(18deg);
    }

    .goldBtn span{
      background:linear-gradient(180deg,#fffef2,#fffbe2);
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
      font-weight:900;
      font-size:26px;
      letter-spacing:.3px;
      text-shadow:0 0 12px rgba(255,255,200,.9),
                   0 0 24px rgba(255,230,150,.75);
      white-space:nowrap;
    }

    .goldBtn:hover{
      transform:translateY(-2px);
    }
    .goldBtn:hover,
    .goldBtn:focus-visible{
      box-shadow:
        0 14px 22px rgba(0,0,0,.42),
        inset 0 7px 16px rgba(255,255,255,.6),
        inset 0 -14px 20px rgba(176,88,0,.5);
      outline:2px solid rgba(255,220,120,.6);
      outline-offset:2px;
    }

    /***********************************************************************
     * ì¹´ë“œ ë¦¬ìŠ¤íŠ¸
     ***********************************************************************/
    .rowTop{
      display:flex;
      justify-content:center;
      align-items:stretch;
      gap:28px;
      flex-wrap:nowrap;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      margin-top:8px;
      padding-bottom:6px;
      scrollbar-width:none;
      width:100%;
    }
    .rowTop::-webkit-scrollbar{ display:none; }

    .card{
      flex:0 0 clamp(190px,28vw,220px);
      width:clamp(190px,28vw,220px);
      height:300px;
      display:grid;
      grid-template-rows:120px 44px 1fr 54px;
      background:linear-gradient(180deg,#0a0030,#000);
      border:3px solid #3e2b7b;
      border-radius:22px;
      box-shadow:
        0 0 30px #0008,
        inset 0 0 20px #2a0085;
      padding:16px 14px;
      cursor:pointer;
      transition:box-shadow .14s ease, transform .12s ease;
      text-align:center;
    }
    .card:hover{
      box-shadow:
        0 0 36px #007affaa,
        inset 0 0 26px #001a44;
      transform:translateY(-3px);
    }

    .thumb{
      display:grid;
      place-items:center;
      width:100%;
      height:100%;
    }
    .card h3{
      margin:6px 0 0;
      font-size:18px;
      font-weight:800;
      color:var(--gold1);
      text-shadow:0 0 10px #bf8;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .meta{
      font-size:11px;
      opacity:.85;
      padding:0 6px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
    }
    .btnbar{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .btn{
      flex:1;
      height:38px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius:12px;
      border:1px solid #2d3690;
      background:linear-gradient(180deg,#1a2b7a,#0a1a64);
      font-weight:800;
      color:#e9f0ff;
      box-shadow:0 6px 12px #0006;
      font-size:12px;
    }
    .btn:hover{
      filter:brightness(1.06);
    }

    /***********************************************************************
     * ì¢Œ/ìš° ì„¸ë¡œí˜• ê´‘ê³  ë°°ë„ˆ
     ***********************************************************************/
    .sideAd{
      position:fixed;
      top:50%;
      transform:translateY(-50%);
      width:160px;
      height:600px;
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:5000;
      pointer-events:auto;
    }
    .sideAd-inner{
      width:100%;
      height:100%;
      border-radius:18px;
      border:1px solid #3250c2;
      background:linear-gradient(180deg,#0b1640,#12296f 40%,#1b3ea0 80%,#233fd0);
      box-shadow:
        0 8px 20px rgba(0,0,0,.65),
        0 0 22px rgba(40,120,255,.55);
      box-sizing:border-box;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .sideAd-left{ left:8px; }
    .sideAd-right{ right:8px; }

    @media (max-width:1280px){
      .sideAd{ display:none; }
    }

    /***********************************************************************
     * Footer
     ***********************************************************************/
    footer{
      padding:12px 16px;
      text-align:center;
      color:#aab;
      opacity:.9;
      font-size:12px;
      margin-top:var(--gapY);
    }

    /***********************************************************************
     * Background Canvas
     ***********************************************************************/
    #fx{
      position:fixed;
      inset:0;
      pointer-events:none;
      opacity:.5;
    }

    .divider{
      height:4px;
      width:100%;
      background:linear-gradient(90deg,transparent,rgba(0,136,255,.8),transparent);
      filter:blur(1px);
      box-shadow:0 0 18px #0088ff88;
      margin:0;
    }

    /***********************************************************************
     * ë°˜ì‘í˜•
     ***********************************************************************/
    @media (max-width:1200px){
      .hudTop{ left:18px; gap:8px; }
    }
    @media (max-width:1024px){
      .auth{ right:18px; }
      .rowTop{ gap:24px; }
      .stack{ transform:translateY(-24px); }
      .goldBtn{ min-width:min(84vw,720px); }
    }
    @media (max-width:860px){
      header{
        padding-top:calc(16px + var(--safe-top));
        padding-bottom:16px;
      }
      .hudTop,
      .auth{
        position:static;
        transform:none;
        max-width:100%;
      }
      .hudTop{
        justify-content:center;
        margin-top:10px;
      }
      .auth{
        justify-content:center;
        margin-top:6px;
      }
      .title{
        font-size:clamp(24px,6vw,30px);
      }
      .subtitle{
        margin-top:4px;
      }
    }
    @media (max-width:680px){
      .stack{ transform:translateY(-16px); }
      .goldBtn{
        min-width:min(92vw,640px);
        padding:18px 52px;
      }
      .goldBtn span{
        font-size:22px;
        letter-spacing:.2px;
      }
      .goldBtn::before{
        left:-52px;
        width:90px;
        height:30px;
      }
      .goldBtn::after{
        right:-52px;
        width:90px;
        height:30px;
      }
      .card{
        flex:0 0 72vw;
        width:72vw;
        max-width:260px;
      }
    }
    @media (max-width:480px){
      main{ padding:0 14px 10px; }
      .rowTop{ gap:20px; }
      .card{
        flex:0 0 78vw;
        width:78vw;
      }
      .pill{
        padding:6px 10px;
      }
      .amount{
        font-size:16px;
      }
    }
    @media (min-width:1024px){
      .rowTop{
        display:grid;
        grid-template-columns:repeat(5,minmax(0,1fr));
        gap:28px;
        justify-content:center;
        align-items:stretch;
        overflow:visible;
      }
      .rowTop .card{
        flex:none;
        width:100%;
        max-width:none;
      }
    }

    /***********************************************************************
     * Cookie Banner
     ***********************************************************************/
    .cookie-banner{
      position:fixed;
      left:12px;
      right:12px;
      bottom:12px;
      display:none;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #2b3f8f;
      background:linear-gradient(180deg,#0b1f40,#0a1730);
      box-shadow:0 10px 18px rgba(0,0,0,.45),
                  inset 0 0 18px rgba(255,255,255,.05);
      z-index:10000;
      font-size:12px;
    }
    .cookie-banner .spacer{ flex:1; }
    .cookie-banner button{
      padding:8px 12px;
      border-radius:10px;
      border:1px solid #2d3690;
      background:linear-gradient(180deg,#1a2b7a,#0a1a64);
      font-weight:800;
      color:#e9f0ff;
      cursor:pointer;
    }
    .cookie-banner .agree{
      background:linear-gradient(180deg,#ffdf6e,#ffb84d);
      color:#3a2400;
      border-color:#7a5600;
    }

    /***********************************************************************
     * ë­í‚¹ ëª¨ë‹¬ ìŠ¤íƒ€ì¼
     ***********************************************************************/
    .rank-modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.65);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9000;
    }
    .rank-modal-backdrop.open{ display:flex; }

    .rank-modal{
      width:min(960px,94vw);
      max-height:80vh;
      border-radius:22px;
      background:radial-gradient(circle at 10% -30%,#3c2b80,#050015 70%);
      box-shadow:0 0 40px rgba(0,0,0,.8),
                 0 0 40px rgba(60,100,255,.7);
      border:2px solid #3e2b7b;
      padding:18px 20px 18px;
      display:flex;
      flex-direction:column;
    }
    .rank-modal-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
      gap:12px;
    }
    .rank-modal-title-wrap{ display:flex; flex-direction:column; gap:2px; }

    .rank-modal-title{
      font-size:18px;
      font-weight:900;
      color:var(--gold1);
      text-shadow:0 0 12px #ffdc7a;
      display:flex;
      align-items:center;
      gap:6px;
    }

    .rank-modal-sub{
      font-size:12px;
      opacity:.8;
    }

    .rank-modal-close{
      border-radius:999px;
      border:1px solid #3040a8;
      background:linear-gradient(180deg,#1b2b7f,#0b164f);
      color:#e9f0ff;
      font-size:13px;
      font-weight:800;
      padding:6px 10px;
      cursor:pointer;
      white-space:nowrap;
      box-shadow:0 4px 10px rgba(0,0,0,.5);
    }
    .rank-modal-close:hover{
      filter:brightness(1.05);
    }

    .rank-game-tabs{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-bottom:10px;
    }
    .rank-game-tab{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid #3240a8;
      background:linear-gradient(180deg,#0d1638,#060c24);
      font-size:12px;
      font-weight:700;
      cursor:pointer;
      opacity:.78;
    }
    .rank-game-tab span.code{
      font-weight:800;
      margin-right:4px;
      color:#ffdf6e;
    }
    .rank-game-tab.active{
      background:linear-gradient(180deg,#ffdf6e,#ffb84d);
      color:#321c00;
      border-color:#7a5600;
      text-shadow:0 0 6px rgba(255,240,160,.8);
      opacity:1;
    }

    .rank-table-wrap{
      flex:1;
      min-height:200px;
      margin-top:4px;
      border-radius:14px;
      border:1px solid #263472;
      background:linear-gradient(180deg,#05081b,#050314);
      box-shadow:0 0 18px rgba(0,0,0,.7) inset;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    .rank-table-head,
    .rank-table-body{ width:100%; }

    .rank-table-head{
      border-bottom:1px solid #27336b;
      background:linear-gradient(180deg,#10193a,#090e22);
    }

    .rank-table-row{
      display:grid;
      grid-template-columns:40px 1.4fr .7fr 1fr 1fr 1.5fr;
      align-items:center;
      font-size:11px;
      padding:6px 12px;
      column-gap:6px;
      white-space:nowrap;
    }
    .rank-table-head .rank-table-row{
      font-weight:800;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.3px;
      color:#d6e0ff;
    }

    .rank-table-body{
      flex:1;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
    }

    .rank-table-body .rank-table-row:nth-child(2n){
      background:rgba(255,255,255,.02);
    }

    .rank-table-cell-rank{
      font-weight:800;
      color:#ffdf6e;
      text-shadow:0 0 6px rgba(255,230,150,.7);
    }
    .rank-table-cell-user{
      font-weight:700;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .rank-table-cell-gender{
      text-transform:uppercase;
      opacity:.85;
    }
    .rank-table-cell-score,
    .rank-table-cell-points{
      text-align:right;
      font-variant-numeric:tabular-nums;
    }
    .rank-table-cell-time{
      font-variant-numeric:tabular-nums;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .rank-table-empty{
      padding:16px 14px;
      font-size:12px;
      text-align:center;
      opacity:.85;
    }
    .rank-table-loading{
      padding:16px 14px;
      font-size:12px;
      text-align:center;
      opacity:.9;
      color:#ffd86a;
    }

    .rank-modal-footer{
      margin-top:8px;
      font-size:11px;
      opacity:.75;
      display:flex;
      justify-content:space-between;
      gap:8px;
      flex-wrap:wrap;
    }
    .rank-modal-footer span.badge{
      padding:3px 8px;
      border-radius:999px;
      border:1px solid #3240a8;
      background:linear-gradient(180deg,#0b1337,#05091f);
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.2px;
      opacity:.9;
    }

    @media (max-width:640px){
      .rank-modal{
        padding:14px 12px 14px;
        max-height:86vh;
      }
      .rank-table-row{
        grid-template-columns:32px 1.4fr .7fr 1fr 1fr 1.7fr;
        padding:5px 8px;
        column-gap:4px;
        font-size:10px;
      }
      .rank-table-head .rank-table-row{
        font-size:10px;
      }
    }

    /***********************************************************************
     * ì„¤ì • ëª¨ë‹¬ ìŠ¤íƒ€ì¼
     ***********************************************************************/
    .settings-modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.7);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9500;
    }
    .settings-modal-backdrop.open{ display:flex; }

    .settings-modal{
      width:min(720px,94vw);
      max-height:80vh;
      border-radius:22px;
      background:radial-gradient(circle at 0% -40%,#403090,#050015 70%);
      box-shadow:0 0 40px rgba(0,0,0,.85),
                 0 0 34px rgba(80,140,255,.75);
      border:2px solid #3e2b7b;
      padding:18px 20px 18px;
      display:flex;
      flex-direction:column;
      color:#e4e7ff;
    }

    .settings-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }

    .settings-title-wrap{ display:flex; flex-direction:column; gap:2px; }

    .settings-title{
      font-size:18px;
      font-weight:900;
      color:var(--gold1);
      text-shadow:0 0 12px #ffdc7a;
      display:flex;
      align-items:center;
      gap:6px;
    }

    .settings-sub{
      font-size:12px;
      opacity:.82;
    }

    .settings-close-btn{
      border-radius:999px;
      border:1px solid #3040a8;
      background:linear-gradient(180deg,#1b2b7f,#0b164f);
      color:#e9f0ff;
      font-size:13px;
      font-weight:800;
      padding:6px 10px;
      cursor:pointer;
      white-space:nowrap;
      box-shadow:0 4px 10px rgba(0,0,0,.5);
    }
    .settings-close-btn:hover{ filter:brightness(1.05); }

    .settings-body{
      flex:1;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      padding-right:2px;
    }

    .settings-section{
      border-radius:14px;
      border:1px solid #283474;
      background:linear-gradient(180deg,#070b1f,#060518);
      box-shadow:inset 0 0 18px rgba(0,0,0,.6);
      padding:10px 12px;
      margin-bottom:10px;
    }

    .settings-section-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:6px;
    }

    .settings-section-title{
      font-size:13px;
      font-weight:800;
      color:#ffdf6e;
      text-shadow:0 0 8px rgba(255,220,120,.8);
      display:flex;
      align-items:center;
      gap:4px;
    }

    .settings-section-desc{
      font-size:11px;
      opacity:.8;
    }

    .settings-item-list{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-top:4px;
    }

    .settings-item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      font-size:12px;
    }

    .settings-item-label{
      display:flex;
      flex-direction:column;
      gap:2px;
    }

    .settings-item-label-main{
      font-weight:700;
    }

    .settings-item-label-sub{
      font-size:11px;
      opacity:.78;
    }

    .settings-toggle{
      position:relative;
      width:44px;
      height:22px;
      border-radius:999px;
      border:1px solid #3240a8;
      background:linear-gradient(180deg,#0b1435,#060917);
      box-shadow:inset 0 0 10px rgba(0,0,0,.7);
      cursor:pointer;
      flex-shrink:0;
    }

    .settings-toggle input{
      position:absolute;
      inset:0;
      opacity:0;
      cursor:pointer;
      margin:0;
    }

    .settings-toggle-knob{
      position:absolute;
      top:2px;
      left:2px;
      width:18px;
      height:18px;
      border-radius:50%;
      background:radial-gradient(circle at 30% 30%,#fff8c8,#ffdf6e);
      box-shadow:0 0 10px rgba(255,220,120,.9);
      transition:transform .16s ease;
    }

    .settings-toggle[data-on="true"]{
      background:linear-gradient(180deg,#ffdf6e,#ffb84d);
      border-color:#7a5600;
      box-shadow:0 0 10px rgba(255,220,120,.9);
    }
    .settings-toggle[data-on="true"] .settings-toggle-knob{
      transform:translateX(20px);
      background:radial-gradient(circle at 30% 30%,#fffdf0,#fff1a8);
    }

    .settings-footer{
      margin-top:10px;
      font-size:11px;
      opacity:.76;
      display:flex;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:8px;
    }

    .settings-footer .badge{
      padding:3px 8px;
      border-radius:999px;
      border:1px solid #3240a8;
      background:
        linear-gradient(180deg,#0b1337,#05091f);
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.2px;
      opacity:.9;
    }

    .settings-actions-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:6px;
    }
    .settings-action-btn{
      border-radius:999px;
      border:1px solid #3040a8;
      background:linear-gradient(180deg,#1b2b7f,#0b164f);
      color:#e9f0ff;
      font-size:12px;
      font-weight:700;
      padding:6px 12px;
      cursor:pointer;
      white-space:nowrap;
      box-shadow:0 4px 10px rgba(0,0,0,.5);
    }
    .settings-action-btn.primary{
      background:linear-gradient(180deg,#ffdf6e,#ffb84d);
      color:#3a2400;
      border-color:#7a5600;
      text-shadow:0 0 6px rgba(255,240,170,.85);
    }
    .settings-action-btn:hover{
      filter:brightness(1.05);
    }
    @media (max-width:640px){
      .settings-modal{
        padding:14px 12px 14px;
        max-height:86vh;
      }
    }

    /* ===== SHOP ëª¨ë‹¬ (shop.html ë””ìì¸ì„ íŒì—…ìœ¼ë¡œ ì¬í˜„) ===== */
    .shop-modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.78);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9200;
    }
    .shop-modal-backdrop.open{
      display:flex;
    }
    .shop-modal{
      width:min(1024px,96vw);
      max-height:86vh;
      border-radius:22px;
      background:radial-gradient(circle at 0% -40%,#402890,#050015 70%);
      box-shadow:0 0 40px rgba(0,0,0,.9),0 0 40px rgba(60,120,255,.8);
      border:2px solid #3e2b7b;
      padding:18px 20px 18px;
      display:flex;
      flex-direction:column;
      color:#e4e7ff;
    }
    .shop-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .shop-title-wrap{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .shop-title{
      font-size:18px;
      font-weight:900;
      color:var(--gold1);
      text-shadow:0 0 12px #ffdc7a;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .shop-sub{
      font-size:12px;
      opacity:.85;
    }
    .shop-close-btn{
      border-radius:999px;
      border:1px solid #3040a8;
      background:linear-gradient(180deg,#1b2b7f,#0b164f);
      color:#e4e7ff;
      font-size:13px;
      font-weight:800;
      padding:6px 10px;
      cursor:pointer;
      white-space:nowrap;
      box-shadow:0 4px 10px rgba(0,0,0,.5);
    }
    .shop-close-btn:hover{
      filter:brightness(1.05);
    }
    .shop-top-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
      margin-bottom:8px;
    }
    .shop-counters{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .shop-counter-pill{
      display:flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:14px;
      border:1px solid #3140a8;
      background:linear-gradient(180deg,#0a1436,#050819);
      box-shadow:0 6px 12px rgba(0,0,0,.55),inset 0 0 16px rgba(0,0,0,.7);
      font-size:11px;
    }
    .shop-counter-icon{
      font-size:14px;
    }
    .shop-counter-main{
      font-weight:800;
      font-size:13px;
    }
    .shop-counter-unit{
      font-size:11px;
      opacity:.8;
    }
    .shop-controls{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
    }
    .shop-filters{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .shop-filter-btn{
      padding:5px 10px;
      border-radius:999px;
      border:1px solid #3240a8;
      background:linear-gradient(180deg,#0d1638,#060c24);
      font-size:11px;
      font-weight:700;
      cursor:pointer;
      opacity:.78;
      white-space:nowrap;
    }
    .shop-filter-btn span.tag{
      font-weight:800;
      margin-right:4px;
      color:#ffdf6e;
    }
    .shop-filter-btn.active{
      background:linear-gradient(180deg,#ffdf6e,#ffb84d);
      color:#321c00;
      border-color:#7a5600;
      text-shadow:0 0 6px rgba(255,240,160,.8);
      opacity:1;
    }
    .shop-sort{
      display:flex;
      align-items:center;
      gap:4px;
      font-size:11px;
      opacity:.86;
    }
    .shop-sort select{
      background:linear-gradient(180deg,#0c1432,#05091b);
      border-radius:999px;
      border:1px solid #3240a8;
      padding:4px 8px;
      color:#e4e7ff;
      font-size:11px;
      outline:none;
    }
    .shop-grid{
      flex:1;
      margin-top:8px;
      border-radius:14px;
      border:1px solid #283474;
      background:linear-gradient(180deg,#05081c,#050314);
      box-shadow:inset 0 0 18px rgba(0,0,0,.7);
      padding:10px 10px 8px;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(210px,1fr));
      gap:10px;
    }
    .shop-card{
      position:relative;
      border-radius:14px;
      border:1px solid #3040a8;
      background:radial-gradient(circle at 0% -40%,#27215a,#050015 70%);
      box-shadow:0 8px 18px rgba(0,0,0,.65);
      padding:10px 10px 9px;
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:12px;
    }
    .shop-card-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:6px;
    }
    .shop-card-title-wrap{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .shop-card-title{
      font-size:13px;
      font-weight:800;
    }
    .shop-card-sub{
      font-size:11px;
      opacity:.8;
    }
    .shop-card-badge{
      padding:3px 8px;
      border-radius:999px;
      border:1px solid #ffcf4a;
      background:linear-gradient(180deg,#ffdf6e,#ffb84d);
      color:#321c00;
      font-size:10px;
      font-weight:800;
      text-transform:uppercase;
      box-shadow:0 0 10px rgba(255,220,120,.8);
      white-space:nowrap;
    }
    .shop-card-meta{
      font-size:11px;
      opacity:.85;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:6px;
    }
    .shop-card-meta-left{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .shop-card-tag{
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.2px;
      opacity:.85;
    }
    .shop-card-duration{
      font-size:11px;
      opacity:.9;
    }
    .shop-card-meta-right{
      font-size:10px;
      opacity:.8;
      text-align:right;
    }
    .shop-card-price-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:6px;
      margin-top:4px;
    }
    .shop-card-price-main{
      display:flex;
      flex-direction:column;
      gap:2px;
      font-size:11px;
    }
    .shop-card-price-unit{
      font-size:11px;
      opacity:.82;
    }
    .shop-card-price-value{
      font-size:13px;
      font-weight:800;
      color:#ffdf6e;
      text-shadow:0 0 8px rgba(255,220,120,.8);
    }
    .shop-card-actions{
      display:flex;
      gap:6px;
      align-items:center;
      justify-content:flex-end;
      margin-top:4px;
    }
    .shop-buy-btn{
      border-radius:999px;
      border:1px solid #3040a8;
      background:linear-gradient(180deg,#1b2b7f,#0b164f);
      color:#e4e7ff;
      font-size:11px;
      font-weight:700;
      padding:6px 10px;
      cursor:pointer;
      white-space:nowrap;
      box-shadow:0 4px 10px rgba(0,0,0,.5);
    }
    .shop-buy-btn.primary{
      background:linear-gradient(180deg,#ffdf6e,#ffb84d);
      color:#321c00;
      border-color:#7a5600;
      text-shadow:0 0 6px rgba(255,240,170,.85);
    }
    .shop-buy-btn:hover{
      filter:brightness(1.05);
    }
    .shop-empty{
      grid-column:1/-1;
      text-align:center;
      font-size:12px;
      opacity:.85;
      padding:18px 8px;
    }
    .shop-footer-note{
      margin-top:8px;
      font-size:11px;
      opacity:.78;
      display:flex;
      justify-content:space-between;
      gap:8px;
      flex-wrap:wrap;
    }
    .shop-footer-note span.badge{
      padding:3px 8px;
      border-radius:999px;
      border:1px solid #3240a8;
      background:linear-gradient(180deg,#0b1337,#05091f);
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.2px;
      opacity:.9;
    }

    .shop-toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      max-width:min(420px,90vw);
      padding:10px 14px;
      border-radius:12px;
      border:1px solid #3240a8;
      background:radial-gradient(circle at 0% -40%,#26346f,#050015 70%);
      box-shadow:0 10px 22px rgba(0,0,0,.75);
      font-size:12px;
      z-index:9300;
      display:none;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .shop-toast.show{
      display:flex;
    }
    .shop-toast-message{
      flex:1;
    }
    .shop-toast-close{
      border:none;
      background:transparent;
      color:#e4e7ff;
      font-size:13px;
      cursor:pointer;
    }

    @media (max-width:640px){
      .shop-modal{
        padding:14px 12px 14px;
      }
      .shop-grid{
        grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
      }
      .shop-top-row{
        flex-direction:column;
        align-items:stretch;
      }
      .shop-controls{
        justify-content:flex-start;
      }
    }

    /* layout notes:
       - ê¸°ì¡´ hub ë ˆì´ì•„ì›ƒ/ë””ìì¸/ë¹„ìœ¨ ìœ ì§€
       - shop.html ë ˆì´ì•„ì›ƒì„ ëª¨ë‹¬ ë‚´ë¶€ì—ì„œ ë™ì¼í•˜ê²Œ ì¬í˜„
       - êµ¬ë§¤ëŠ” AJAX(fetch) ê¸°ë°˜ìœ¼ë¡œë§Œ ë™ì‘, í˜ì´ì§€ ì´ë™ ì—†ìŒ */
  </style>
</head>

<body>
  <!-- âœ… ì „ì—­ ë„¤ë¹„ê²Œì´ì…˜: nav-only header partial ì´ ì—¬ê¸°ë¡œë§Œ ì£¼ì…ë¨ -->

  <canvas id="fx"></canvas>

  <!-- ğŸµ í—ˆë¸Œ ì „ìš© ë°°ê²½ ìŒì•… (30% ë³¼ë¥¨, ë°˜ë³µ ì¬ìƒ) -->
  <audio id="hubBgm" src="/assets/music/main-background.mp3" loop preload="auto" aria-hidden="true"></audio>

  <!-- âœ… ì¢Œì¸¡ ì„¸ë¡œí˜• ê´‘ê³  ë°°ë„ˆ -->
  <div class="sideAd sideAd-left" aria-label="ê´‘ê³  ë°°ë„ˆ(ì¢Œì¸¡)">
    <div class="sideAd-inner">
      <ins class="adsbygoogle"
        style="display:block;width:100%;height:100%;"
        data-ad-client="ca-pub-6713974265397310"
        data-ad-slot="4514999077"
        data-ad-format="auto"
        data-full-width-responsive="false"></ins>
      <script>
        try{
          (adsbygoogle = window.adsbygoogle || []).push({});
        }catch(e){
          console.warn("AdSense left vertical render error:", e);
        }
      </script>
    </div>
  </div>

  <!-- âœ… ìš°ì¸¡ ì„¸ë¡œí˜• ê´‘ê³  ë°°ë„ˆ -->
  <div class="sideAd sideAd-right" aria-label="ê´‘ê³  ë°°ë„ˆ(ìš°ì¸¡)">
    <div class="sideAd-inner">
      <ins class="adsbygoogle"
        style="display:block;width:100%;height:100%;"
        data-ad-client="ca-pub-6713974265397310"
        data-ad-slot="4514999077"
        data-ad-format="auto"
        data-full-width-responsive="false"></ins>
      <script>
        try{
          (adsbygoogle = window.adsbygoogle || []).push({});
        }catch(e){
          console.warn("AdSense right vertical render error:", e);
        }
      </script>
    </div>
  </div>

  <div class="wrap">
    <header>
      <!-- ì¢Œì¸¡: HUD (ê³µí†µ HUD DOM ê·œê²©: id="rg-hud" + data-hud="*") -->
        <!-- âœ… ê³µí†µ HUD ì˜ì—­ (ë‹¨ê³„ 2-1 í‘œì¤€ DOM) -->
        <div id="rg-hud" class="hud-bar">
          <span data-hud="level">-</span>
          <span data-hud="exp">0</span>
          <span data-hud="coins">0</span>
          <span data-hud="tickets">0</span>
          <span data-hud="gamesPlayed">0</span>
        </div>
        <span class="sr-only">ê³„ì • ë³´ìƒ HUD</span>

        <!-- Lv. HUD (ì‹ ê·œ) -->
        <div class="pill level hud-item hud-level" title="ê³„ì • ë ˆë²¨">
          <div class="icon">â­</div>
          <div class="label">Lv.</div>
          <div class="amount" id="levelVal" data-hud="level">-</div>
        </div>

        <!-- Coins -->
        <div class="pill coins hud-item hud-coins" title="ë³´ìœ  ì½”ì¸(í¬ì¸íŠ¸)">
          <div class="icon">ğŸª™</div>
          <div class="label">Coins</div>
          <div id="coinVal"
               class="amount"
               data-user-points
               data-hud="coins">0</div>
          <div class="unit">COINS</div>
        </div>

        <!-- EXP -->
        <div class="pill xp hud-item hud-exp" title="ê²½í—˜ì¹˜">
          <div class="icon">ğŸ†</div>
          <div class="label">EXP</div>
          <div id="xpVal"
               class="amount"
               data-user-exp
               data-hud="exp">0</div>
          <div class="unit">XP</div>
          <span id="xpCap" class="sr-only">/ 20K</span>
          <span class="sr-only" aria-hidden="true"><span id="xpBar"></span></span>
        </div>

        <!-- Tickets -->
        <div class="pill tickets hud-item hud-tickets" title="ë³´ìœ  í‹°ì¼“">
          <div class="icon">ğŸŸï¸</div>
          <div class="label">Tickets</div>
          <div id="ticketVal"
               class="amount"
               data-user-tickets
               data-hud="tickets">0</div>
          <div class="unit">TICKETS</div>
        </div>

        <!-- Plays -->
        <div class="pill plays hud-item hud-games" title="ì´ í”Œë ˆì´ ìˆ˜">
          <div class="icon">ğŸ®</div>
          <div class="label">Plays</div>
          <div id="playVal"
               class="amount"
               data-user-plays
               data-hud="gamesPlayed">0</div>
          <div class="unit">PLAYS</div>
        </div>

        <!-- SHOP ë²„íŠ¼: í˜ì´ì§€ ì´ë™ ëŒ€ì‹  íŒì—… ëª¨ë‹¬ ì—´ê¸° (ê¸°ì¡´ ê·¸ëŒ€ë¡œ) -->
        <button class="pill shop" onclick="openShopModal()" title="ìƒì ">
          <div class="icon">ğŸ›ï¸</div>
          <div class="label">SHOP</div>
        </button>
        <button class="pill rank" onclick="openRankingModal()" title="ì‹¤ì‹œê°„ ë­í‚¹">
          <div class="icon">ğŸ…</div>
          <div class="label">RANKING</div>
        </button>
      </div>

      <!-- âœ… HUD ì•„ë˜ ì¸ë¼ì¸ ê´‘ê³  ìŠ¬ë¡¯ -->
      <div class="rg-ad rg-ad-inline" aria-label="ê´‘ê³ (ì¸ë¼ì¸)">
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-6713974265397310"
             data-ad-slot="7668007538"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
        <script>
          (function(){
            try{
              if (window.RG && typeof window.RG.initAds === 'function') {
                window.RG.initAds(document);
              } else {
                (window.adsbygoogle = window.adsbygoogle || []).push({});
              }
            }catch(e){}
          })();
        </script>
      </div>

      <div class="title">ğŸ® RETRO GAMES</div>
      <div class="subtitle">ì˜¤ëŠ˜ì˜ ë¯¸ë‹ˆê²Œì„ì„ ì„ íƒí•˜ì„¸ìš”!</div>
      <div id="userGreeting" class="subtitle user-greeting" aria-live="polite"></div>

      <div class="auth">
        <button class="authbtn" type="button" onclick="openSettingsModal()">âš™ï¸ ì„¤ì •</button>
      </div>
    </header>

    <div class="divider"></div>

    <section class="content">
      <main>
        <div class="stack">
          <div class="ctaWrap">
            <div
              class="goldBtn"
              role="button"
              tabindex="0"
              onclick="goLucky()"
              onkeypress="if(event.key==='Enter') goLucky()"
              aria-label="ì˜¤ëŠ˜ì˜ í–‰ìš´ ë½‘ê¸°"
            >
              <span>ì˜¤ëŠ˜ì˜ í–‰ìš´ ë½‘ê¸°</span>
            </div>
          </div>

          <div class="rowTop">
            <div class="card" onclick="goGame('2048')">
              <div class="thumb">
                <svg width="80" height="80" viewBox="0 0 120 120">
                  <rect x="12" y="12" width="96" height="96" rx="18" fill="#7a9cff"/>
                  <text x="60" y="78" text-anchor="middle" font-size="46" font-family="system-ui,Segoe UI" font-weight="900" fill="#0b1a3f">2048</text>
                </svg>
              </div>
              <h3>2048</h3>
              <div class="meta">ë‚œì´ë„ 1â€“100 Â· ë³´ë“œ 4Ã—4~6Ã—6</div>
              <div class="btnbar"><div class="btn">PLAY</div></div>
            </div>

            <div class="card" onclick="goGame('brick-breaker')">
              <div class="thumb">
                <svg width="90" height="80" viewBox="0 0 130 120">
                  <rect x="14" y="20" width="102" height="18" rx="8" fill="#8ea3ff"/>
                  <rect x="14" y="44" width="102" height="18" rx="8" fill="#c4ceff"/>
                  <rect x="48" y="88" width="60" height="10" rx="5" fill="#70ffa8"/>
                  <circle cx="42" cy="74" r="7" fill="#ffd166"/>
                </svg>
              </div>
              <h3>Brick Breaker</h3>
              <div class="meta">í”„ë¦¬ì…‹/íŠ¹ìˆ˜ë³¼/ë¦¬í”Œë ˆì´</div>
              <div class="btnbar"><div class="btn">PLAY</div></div>
            </div>

            <div class="card" onclick="goGame('brick-match')">
              <div class="thumb">
                <svg width="80" height="80" viewBox="0 0 120 120">
                  <rect x="18" y="22" width="28" height="28" rx="6" fill="#ff9aa6"/>
                  <rect x="46" y="22" width="28" height="28" rx="6" fill="#92ff9a"/>
                  <rect x="74" y="22" width="28" height="28" rx="6" fill="#7ad7ff"/>
                  <rect x="18" y="50" width="28" height="28" rx="6" fill="#ffd17a"/>
                  <rect x="46" y="50" width="28" height="28" rx="6" fill="#caa5ff"/>
                </svg>
              </div>
              <h3>Retro Match</h3>
              <div class="meta">íƒ€ì„ ì–´íƒ Â· íŠ¹ìˆ˜ íƒ€ì¼</div>
              <div class="btnbar"><div class="btn">PLAY</div></div>
            </div>

            <div class="card" onclick="goGame('retro-running')">
              <div class="thumb">
                <svg width="80" height="80" viewBox="0 0 120 120">
                  <rect x="16" y="84" width="88" height="8" fill="#6ec36e"/>
                  <circle cx="52" cy="46" r="10" fill="#ffddea"/>
                  <rect x="40" y="58" width="20" height="18" rx="4" fill="#ffc57a"/>
                </svg>
              </div>
              <h3>Retro Runner</h3>
              <div class="meta">2ë‹¨ ì í”„ Â· ì•„ì´í…œ Â· ë‚®/ë°¤</div>
              <div class="btnbar"><div class="btn">PLAY</div></div>
            </div>

            <div class="card" onclick="goGame('tetris')">
              <div class="thumb">
                <svg width="80" height="80" viewBox="0 0 120 120">
                  <rect x="18" y="60" width="24" height="24" fill="#7ad7ff"/>
                  <rect x="42" y="60" width="24" height="24" fill="#ffe17a"/>
                  <rect x="66" y="60" width="24" height="24" fill="#caa5ff"/>
                  <rect x="42" y="36" width="24" height="24" fill="#92ff9a"/>
                  <rect x="66" y="36" width="24" height="24" fill="#ff9aa6"/>
                </svg>
              </div>
              <h3>Tetris</h3>
              <div class="meta">í™€ë“œ/ë„¥ìŠ¤íŠ¸ Â· ê°€ë¹„ì§€ ë¼ì¸</div>
              <div class="btnbar"><div class="btn">PLAY</div></div>
            </div>
          </div>
        </div>
      </main>
    </section>

    <div class="divider"></div>
    <footer>Â©2025 ì§„ë¹„ì¦ˆ ë§¤ë‹ˆì§€ë¨¼íŠ¸ â”ƒ ê´‘ê³ ë¬¸ì˜ jinbizman@gmail.com â”ƒ RETRO GAMES Â· Neon UI â”ƒ MADE BY ONLY OPEN AI</footer>
  </div>

  <!-- ë­í‚¹ ëª¨ë‹¬ -->
  <div id="rankModalBackdrop" class="rank-modal-backdrop" aria-hidden="true">
    <div class="rank-modal" role="dialog" aria-modal="true" aria-labelledby="rankModalTitle">
      <div class="rank-modal-header">
        <div class="rank-modal-title-wrap">
          <div id="rankModalTitle" class="rank-modal-title">
            <span>ğŸ… ì‹¤ì‹œê°„ ê²Œì„ ë­í‚¹</span>
            <span id="rankModalGameLabel" style="font-size:13px;opacity:.9;"></span>
          </div>
          <div class="rank-modal-sub">
            ê° ê²Œì„ë³„ ìƒìœ„ 1ìœ„ ~ 100ìœ„ê¹Œì§€ ìœ ì € ì•„ì´ë””, ì„±ë³„, ìŠ¤ì½”ì–´, í¬ì¸íŠ¸, ë‹¬ì„± ì‹œê°„ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </div>
        </div>
        <button type="button" class="rank-modal-close" onclick="closeRankingModal()">ë‹«ê¸° âœ•</button>
      </div>

      <div class="rank-game-tabs" id="rankGameTabs" role="tablist" aria-label="ê²Œì„ ì„ íƒ"></div>

      <div class="rank-table-wrap">
        <div class="rank-table-head">
          <div class="rank-table-row">
            <div>#</div>
            <div>ìœ ì € ì•„ì´ë””</div>
            <div>ì„±ë³„</div>
            <div>ìŠ¤ì½”ì–´</div>
            <div>í¬ì¸íŠ¸</div>
            <div>ë‹¬ì„± ì‹œê°„</div>
          </div>
        </div>
        <div class="rank-table-body" id="rankTableBody">
          <div class="rank-table-loading" id="rankTableLoading">ê²Œì„ ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
        </div>
      </div>

      <div class="rank-modal-footer">
        <span class="badge">Top 100</span>
        <span>â€» ë°ì´í„° ì œê³µ: RETRO GAMES ë¦¬ë”ë³´ë“œ API Â· ìƒˆë¡œê³ ì¹¨ ì‹œ ìµœì‹  ì •ë³´ë¡œ ê°±ì‹ ë©ë‹ˆë‹¤.</span>
      </div>
    </div>
  </div>

  <!-- ì„¤ì • ëª¨ë‹¬ -->
  <div id="settingsModalBackdrop" class="settings-modal-backdrop" aria-hidden="true">
    <div class="settings-modal" role="dialog" aria-modal="true" aria-labelledby="settingsModalTitle">
      <div class="settings-header">
        <div class="settings-title-wrap">
          <div id="settingsModalTitle" class="settings-title">
            <span>âš™ï¸ ê¸°ë³¸ ì„¤ì •</span>
          </div>
          <div class="settings-sub">
            ì†Œë¦¬, ì• ë‹ˆë©”ì´ì…˜, ê²Œì„ ë° ê³„ì • ê´€ë ¨ ê¸°ë³¸ ì„¤ì •ì„ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </div>
        </div>
        <button type="button" class="settings-close-btn" onclick="closeSettingsModal()">ë‹«ê¸° âœ•</button>
      </div>

      <div class="settings-body">
        <section class="settings-section" aria-label="ì†Œë¦¬ ì„¤ì •">
          <div class="settings-section-header">
            <div class="settings-section-title">ğŸ”Š ì†Œë¦¬ ì„¤ì •</div>
          </div>
          <div class="settings-section-desc">
            íš¨ê³¼ìŒ ë° ë°°ê²½ ìŒì•… ì‚¬ìš© ì—¬ë¶€ë¥¼ ì„ íƒí•©ë‹ˆë‹¤. ì¼ë¶€ ê²Œì„ì˜ ì„¸ë¶€ ë³¼ë¥¨ ì¡°ì ˆì€ ê° ê²Œì„ ë‚´ ì˜µì…˜ì„ ë”°ë¦…ë‹ˆë‹¤.
          </div>
          <div class="settings-item-list">
            <div class="settings-item">
              <div class="settings-item-label">
                <span class="settings-item-label-main">ì „ì²´ ì‚¬ìš´ë“œ ì‚¬ìš©</span>
                <span class="settings-item-label-sub">íš¨ê³¼ìŒê³¼ BGMì„ í¬í•¨í•œ ì „ì²´ ì†Œë¦¬ë¥¼ ì¼œê±°ë‚˜ ë•ë‹ˆë‹¤.</span>
              </div>
              <label class="settings-toggle" data-setting-key="soundMaster" data-on="true">
                <input type="checkbox" id="settingSoundMaster" />
                <span class="settings-toggle-knob"></span>
              </label>
            </div>
            <div class="settings-item">
              <div class="settings-item-label">
                <span class="settings-item-label-main">ë°°ê²½ ìŒì•… ì‚¬ìš©</span>
                <span class="settings-item-label-sub">ë°°ê²½ ìŒì•…ë§Œ ë³„ë„ë¡œ ì¼œê±°ë‚˜ ëŒ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
              </div>
              <label class="settings-toggle" data-setting-key="bgm" data-on="true">
                <input type="checkbox" id="settingBgm" />
                <span class="settings-toggle-knob"></span>
              </label>
            </div>
          </div>
        </section>

        <section class="settings-section" aria-label="ì• ë‹ˆë©”ì´ì…˜ ì„¤ì •">
          <div class="settings-section-header">
            <div class="settings-section-title">âœ¨ ì• ë‹ˆë©”ì´ì…˜ ì„¤ì •</div>
          </div>
          <div class="settings-section-desc">
            ë°°ê²½ ì´í™íŠ¸ ë° ì¼ë¶€ ì¸í„°ë™ì…˜ ì• ë‹ˆë©”ì´ì…˜ì„ ì¤„ì—¬ ëˆˆì˜ í”¼ë¡œë¥¼ ì¤„ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </div>
          <div class="settings-item-list">
            <div class="settings-item">
              <div class="settings-item-label">
                <span class="settings-item-label-main">ë°°ê²½ ì´í™íŠ¸ ì‚¬ìš©</span>
                <span class="settings-item-label-sub">ë„¤ì˜¨ íŒŒí‹°í´ ë“± ì‹œê° íš¨ê³¼ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.</span>
              </div>
              <label class="settings-toggle" data-setting-key="backgroundFx" data-on="true">
                <input type="checkbox" id="settingBackgroundFx" />
                <span class="settings-toggle-knob"></span>
              </label>
            </div>
            <div class="settings-item">
              <div class="settings-item-label">
                <span class="settings-item-label-main">ì• ë‹ˆë©”ì´ì…˜ ìµœì†Œí™”</span>
                <span class="settings-item-label-sub">ê°€ëŠ¥í•œ ê²½ìš° ì „í™˜ ë° ëª¨ì…˜ì„ ì¤„ì…ë‹ˆë‹¤.</span>
              </div>
              <label class="settings-toggle" data-setting-key="reducedMotion" data-on="false">
                <input type="checkbox" id="settingReducedMotion" />
                <span class="settings-toggle-knob"></span>
              </label>
            </div>
          </div>
        </section>

        <section class="settings-section" aria-label="ê²Œì„ ì„¤ì •">
          <div class="settings-section-header">
            <div class="settings-section-title">ğŸ® ê²Œì„ ì„¤ì •</div>
          </div>
          <div class="settings-section-desc">
            ê²Œì„ ì‹œì‘ ì „ ì•ˆë‚´ ë° íŒíŠ¸ í‘œì‹œ ì—¬ë¶€ë¥¼ ì„ íƒí•©ë‹ˆë‹¤. ê° ê²Œì„ë³„ ê³ ê¸‰ ì˜µì…˜ì€ ì¶”í›„ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.
          </div>
          <div class="settings-item-list">
            <div class="settings-item">
              <div class="settings-item-label">
                <span class="settings-item-label-main">ê²Œì„ ì‹œì‘ ì¹´ìš´íŠ¸ë‹¤ìš´</span>
                <span class="settings-item-label-sub">ê²Œì„ ì‹œì‘ ì‹œ 3Â·2Â·1 ì¹´ìš´íŠ¸ë‹¤ìš´ì„ í‘œì‹œí•©ë‹ˆë‹¤.</span>
              </div>
              <label class="settings-toggle" data-setting-key="gameCountdown" data-on="true">
                <input type="checkbox" id="settingGameCountdown" />
                <span class="settings-toggle-knob"></span>
              </label>
            </div>
            <div class="settings-item">
              <div class="settings-item-label">
                <span class="settings-item-label-main">ê¸°ë³¸ ì¡°ì‘ íŒíŠ¸ í‘œì‹œ</span>
                <span class="settings-item-label-sub">ê²Œì„ ì…ì¥ ì‹œ ì¡°ì‘ ë°©ë²•ì„ ê°„ë‹¨íˆ ì•ˆë‚´í•©ë‹ˆë‹¤.</span>
              </div>
              <label class="settings-toggle" data-setting-key="gameHints" data-on="true">
                <input type="checkbox" id="settingGameHints" />
                <span class="settings-toggle-knob"></span>
              </label>
            </div>
          </div>
        </section>

        <section class="settings-section" aria-label="ê³„ì • ì„¤ì •">
          <div class="settings-section-header">
            <div class="settings-section-title">ğŸ‘¤ ê³„ì • ê´€ë ¨</div>
          </div>
          <div class="settings-section-desc">
            ë‚´ ì •ë³´ ë° ë¡œê·¸ì•„ì›ƒ, ê³„ì • ì „í™˜ ë“±ì˜ ì‘ì—…ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.
          </div>
          <div class="settings-item-list">
            <div class="settings-item">
              <div class="settings-item-label">
                <span class="settings-item-label-main">ë§ˆì´í˜ì´ì§€ ì—´ê¸°</span>
                <span class="settings-item-label-sub">í”„ë¡œí•„, ë³´ìœ  ìì‚°, í”Œë ˆì´ ê¸°ë¡ì„ í™•ì¸í•©ë‹ˆë‹¤.</span>
              </div>
              <button type="button" class="settings-action-btn primary" onclick="openMyPageFromSettings()">
                ë§ˆì´í˜ì´ì§€ ì´ë™
              </button>
            </div>
            <div class="settings-item">
              <div class="settings-item-label">
                <span class="settings-item-label-main">ë¡œê·¸ì•„ì›ƒ</span>
                <span class="settings-item-label-sub">í˜„ì¬ ê³„ì •ì—ì„œ ë¡œê·¸ì•„ì›ƒí•©ë‹ˆë‹¤. (ê²Œì„ ì§„í–‰ ìƒí™©ì€ ì„œë²„ ê¸°ì¤€ìœ¼ë¡œ ìœ ì§€ë©ë‹ˆë‹¤.)</span>
              </div>
              <button type="button" class="settings-action-btn" onclick="logoutFromSettings()">
                ë¡œê·¸ì•„ì›ƒ
              </button>
            </div>
          </div>
        </section>
      </div>

      <div class="settings-footer">
        <span class="badge">Local Only</span>
        <span>â€» ëª¨ë“  ì„¤ì •ì€ ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë˜ë©°, ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œëŠ” ë‹¤ì‹œ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤.</span>
      </div>
    </div>
  </div>

  <!-- âœ… SHOP ëª¨ë‹¬ (shop.htmlì„ ë™ì¼ UIë¡œ íŒì—…í™”) -->
  <div id="shopModalBackdrop" class="shop-modal-backdrop" aria-hidden="true">
    <div class="shop-modal" role="dialog" aria-modal="true" aria-labelledby="shopModalTitle">
      <div class="shop-header">
        <div class="shop-title-wrap">
          <div id="shopModalTitle" class="shop-title">
            <span>ğŸ›ï¸ RETRO SHOP</span>
          </div>
          <div class="shop-sub">
            ë³´ìœ  ì½”ì¸Â·í‹°ì¼“ìœ¼ë¡œ ê´‘ê³  ì œê±°, ê²½í—˜ì¹˜ ë¶€ìŠ¤íŠ¸ ë“± ê°ì¢… ì•„ì´í…œì„ êµ¬ë§¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </div>
        </div>
        <button type="button" class="shop-close-btn" onclick="closeShopModal()">ë‹«ê¸° âœ•</button>
      </div>

      <div class="shop-top-row">
        <div class="shop-counters" aria-label="ë³´ìœ  ì¬í™”">
          <div class="shop-counter-pill">
            <span class="shop-counter-icon">ğŸª™</span>
            <div>
              <div class="shop-counter-main" id="shopCoinsVal">0</div>
              <div class="shop-counter-unit">COINS</div>
            </div>
          </div>
          <div class="shop-counter-pill">
            <span class="shop-counter-icon">ğŸŸï¸</span>
            <div>
              <div class="shop-counter-main" id="shopTicketsVal">0</div>
              <div class="shop-counter-unit">TICKETS</div>
            </div>
          </div>
          <div class="shop-counter-pill">
            <span class="shop-counter-icon">ğŸ†</span>
            <div>
              <div class="shop-counter-main" id="shopXpVal">0</div>
              <div class="shop-counter-unit">XP</div>
            </div>
          </div>
        </div>
        <div class="shop-controls">
          <div class="shop-filters" id="shopFilterRow" role="tablist" aria-label="ì¹´í…Œê³ ë¦¬ ì„ íƒ">
            <button type="button" class="shop-filter-btn active" data-filter="all">
              <span class="tag">ALL</span><span>ì „ì²´</span>
            </button>
            <button type="button" class="shop-filter-btn" data-filter="ads">
              <span class="tag">ADS</span><span>ê´‘ê³  ì œê±°</span>
            </button>
            <button type="button" class="shop-filter-btn" data-filter="xp">
              <span class="tag">XP</span><span>ê²½í—˜ì¹˜ ë¶€ìŠ¤íŠ¸</span>
            </button>
            <button type="button" class="shop-filter-btn" data-filter="coins">
              <span class="tag">COIN</span><span>ì½”ì¸ ì¶©ì „</span>
            </button>
            <button type="button" class="shop-filter-btn" data-filter="tickets">
              <span class="tag">TICKET</span><span>í‹°ì¼“ íŒ¨ìŠ¤</span>
            </button>
            <button type="button" class="shop-filter-btn" data-filter="special">
              <span class="tag">SP</span><span>ìŠ¤í˜ì…œ</span>
            </button>
          </div>
          <div class="shop-sort">
            <span>ì •ë ¬:</span>
            <select id="shopSortSelect" aria-label="ì •ë ¬ ë°©ì‹ ì„ íƒ">
              <option value="recommended">ì¶”ì²œìˆœ</option>
              <option value="priceLow">ê°€ê²© ë‚®ì€ìˆœ</option>
              <option value="priceHigh">ê°€ê²© ë†’ì€ìˆœ</option>
              <option value="duration">ì§€ì†ì‹œê°„ìˆœ</option>
            </select>
          </div>
        </div>
      </div>

      <div id="shopGrid" class="shop-grid" aria-live="polite"></div>

      <div class="shop-footer-note">
        <span class="badge">AJAX ONLY</span>
        <span>â€» ëª¨ë“  êµ¬ë§¤ëŠ” í˜ì´ì§€ ì´ë™ ì—†ì´ ì¦‰ì‹œ ì²˜ë¦¬ë˜ë©°, êµ¬ë§¤ í›„ ì§€ê°‘(/api/wallet) ë° ìƒë‹¨ HUDì— ë°”ë¡œ ë°˜ì˜ë©ë‹ˆë‹¤.</span>
      </div>
    </div>
  </div>

  <!-- SHOP í† ìŠ¤íŠ¸ -->
  <div id="shopToast" class="shop-toast" role="status" aria-live="polite">
    <div id="shopToastMsg" class="shop-toast-message"></div>
    <button type="button" class="shop-toast-close" onclick="hideShopToast()">âœ•</button>
  </div>

  <script>
    const BASE = "/";
    const AUTH_API_BASE = "/api/auth";
    const LEADERBOARD_API_BASE = "/api/leaderboard";
    const WALLET_API_BASE = "/api/wallet";

    const GAME = {
      "2048":           BASE + "games/2048.html",
      "brick-breaker":  BASE + "games/brick-breaker.html",
      "brick-match":    BASE + "games/brick-match.html",
      "retro-running":  BASE + "games/retro-running.html",
      "tetris":         BASE + "games/tetris.html"
    };
    const LUCKY = BASE + "features/today-lucky.html";

    function goGame(slug){
      if (GAME[slug]) window.location.href = GAME[slug];
    }
    function goLucky(){
      window.location.href = LUCKY;
    }
    function goShop(){
      // ìœ ì§€ìš©(ì™¸ë¶€ì—ì„œ í˜¸ì¶œ ê°€ëŠ¥), ì‹¤ì œ ë™ì‘ì€ ëª¨ë‹¬
      openShopModal();
    }

    /* ë³´ìƒ ì§‘ê³„ */
    const NUM = n => Number.isFinite(+n) ? +n : 0;
    const ACCOUNT_TOTALS = {
      coins:   null,
      tickets: null,
      xp:      null,
      xpCap:   null,
      plays:   null,
      userId:  null,
      level:   null,   // âœ… HUD ê³µí†µ DOMìš© ê³„ì • ë ˆë²¨
    };

    // âœ… ìœ ì €ë³„/ê²ŒìŠ¤íŠ¸ë³„ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ prefix
    function getStoragePrefix(){
      const uid = ACCOUNT_TOTALS.userId;
      if (!uid) return "rg_guest";
      return "rg_u_" + String(uid);
    }

    function readTotalsFromLocal(){
      const prefix = getStoragePrefix();
      return {
        coins:   NUM(localStorage.getItem(prefix + '_coins')   || 0),
        tickets: NUM(localStorage.getItem(prefix + '_tickets') || 0),
        xp:      NUM(localStorage.getItem(prefix + '_xp')      || 0),
        xpCap:   NUM(localStorage.getItem(prefix + '_xp_cap')  || 20000)
      };
    }

    function writeTotalsToLocal(t){
      const prefix = getStoragePrefix();
      try{
        localStorage.setItem(prefix + '_coins',   t.coins);
        localStorage.setItem(prefix + '_tickets', t.tickets);
        localStorage.setItem(prefix + '_xp',      t.xp);
        localStorage.setItem(prefix + '_xp_cap',  t.xpCap);
      }catch(e){
        console.warn("[RG] writeTotalsToLocal error:", e);
      }
    }

    function readTotals(){
      const local = readTotalsFromLocal();
      return {
        coins:   ACCOUNT_TOTALS.coins   != null ? ACCOUNT_TOTALS.coins   : local.coins,
        tickets: ACCOUNT_TOTALS.tickets != null ? ACCOUNT_TOTALS.tickets : local.tickets,
        xp:      ACCOUNT_TOTALS.xp      != null ? ACCOUNT_TOTALS.xp      : local.xp,
        xpCap:   ACCOUNT_TOTALS.xpCap   != null ? ACCOUNT_TOTALS.xpCap   : local.xpCap,
      };
    }

    function addReward({coins=0,tickets=0,xp=0}={}){
      const base = readTotalsFromLocal();
      base.coins   += NUM(coins);
      base.tickets += NUM(tickets);
      base.xp      += NUM(xp);
      writeTotalsToLocal(base);

      // âœ… HUD ë‹¨ì¼ ë£¨íŠ¸
      pushHudFromTotals();
      renderShopCounters();
    }

    function fmt(n){ return Number(n||0).toLocaleString('en-US'); }
    // totals â†’ HUD ê°±ì‹  (ì „ì—­)
    function pushHudFromTotals(){
      try{
        const t = readTotals();
        const prefix = getStoragePrefix();
        const localPlays = NUM(localStorage.getItem(prefix + '_plays') || 0);
        const plays = ACCOUNT_TOTALS.plays != null ? ACCOUNT_TOTALS.plays : localPlays;

        applyAccountApiResponseLocal({
          userId: ACCOUNT_TOTALS.userId,
          stats: {
            points: t.coins,
            tickets: t.tickets,
            xp: t.xp,
            xpCap: t.xpCap,
            plays: plays,
            level: ACCOUNT_TOTALS.level
          }
        });
      }catch(e){
        console.warn("[RG] pushHudFromTotals error:", e);
      }
    }

    // âœ… HUD ì „ìš© â€œìˆœìˆ˜ ë Œë” í•¨ìˆ˜â€ (DOMë§Œ ê°±ì‹ , state ê³„ì‚°/ì €ì¥ ê¸ˆì§€)
    function renderHudPure(state){
      const s = state || {};
      const coins   = NUM(s.coins);
      const tickets = NUM(s.tickets);
      const xp      = NUM(s.xp);
      const xpCap   = NUM(s.xpCap || 20000);
      const plays   = NUM(s.plays);
      const lvl     = (s.level != null) ? NUM(s.level) : null;

      const coinEl   = document.getElementById('coinVal');
      const xpEl     = document.getElementById('xpVal');
      const ticketEl = document.getElementById('ticketVal');
      const playEl   = document.getElementById('playVal');

      // ê¸°ì¡´ ID ê¸°ë°˜ HUD ê°±ì‹  (ë””ìì¸/ë™ì‘ ìœ ì§€)
      if (coinEl)   coinEl.textContent   = fmt(coins);
      if (xpEl)     xpEl.textContent     = fmt(xp);
      if (ticketEl) ticketEl.textContent = fmt(tickets);
      if (playEl)   playEl.textContent   = fmt(plays);

      const pct = Math.max(0, Math.min(100, (xp / Math.max(1,xpCap)) * 100));
      const xpBar = document.getElementById('xpBar');
      if (xpBar) xpBar.style.width = pct + "%";
      const xpCapEl = document.getElementById('xpCap');
      if (xpCapEl) xpCapEl.textContent = "/ " + (xpCap >= 1000 ? fmt(xpCap/1000)+"K" : fmt(xpCap));

      // âœ… ê³µí†µ HUD DOM(data-hud="*")ì—ë„ ë™ì¼ ê°’ ì£¼ì…
      document.querySelectorAll('[data-hud="coins"]').forEach(function(el){
        el.textContent = fmt(coins);
      });
      document.querySelectorAll('[data-hud="exp"]').forEach(function(el){
        el.textContent = fmt(xp);
      });
      document.querySelectorAll('[data-hud="tickets"]').forEach(function(el){
        el.textContent = fmt(tickets);
      });
      document.querySelectorAll('[data-hud="gamesPlayed"]').forEach(function(el){
        el.textContent = fmt(plays);
      });
      document.querySelectorAll('[data-hud="level"]').forEach(function(el){
        el.textContent = (lvl != null) ? fmt(lvl) : "-";
      });
    }

    // âœ… HUD ê³„ì‚°(ìƒíƒœ) â†’ ìˆœìˆ˜ ë Œë” í˜¸ì¶œ(ë Œë”ë§Œ)
    function renderHudFromState(){
      const t = readTotals();
      const prefix = getStoragePrefix();
      const localPlays = NUM(localStorage.getItem(prefix + '_plays') || 0);
      const plays = ACCOUNT_TOTALS.plays != null ? ACCOUNT_TOTALS.plays : localPlays;

      renderHudPure({
        coins: t.coins,
        tickets: t.tickets,
        xp: t.xp,
        xpCap: t.xpCap,
        plays: plays,
        level: ACCOUNT_TOTALS.level
      });
    }

    // HUD/ì§€ê°‘/ìŠ¤íƒ¯ ê³µí†µ ë°˜ì˜ (ì „ì—­)
    function applyAccountApiResponseLocal(payload){
      if(!payload) return;

      const current = readTotals();
      const stats   = payload.stats  || {};
      const wallet  = payload.wallet || {};

      let coins   = current.coins;
      let tickets = current.tickets;
      let xp      = current.xp;
      let xpCap   = current.xpCap;
      let plays   = ACCOUNT_TOTALS.plays != null
        ? ACCOUNT_TOTALS.plays
        : NUM(localStorage.getItem(getStoragePrefix() + '_plays') || 0);
      let level   = ACCOUNT_TOTALS.level;

      const coinsSrc =
        stats.points ?? stats.coins ??
        wallet.points ?? wallet.coins ??
        payload.points ?? payload.coins;

      const xpSrc =
        stats.exp ?? stats.xp ??
        wallet.exp ?? wallet.xp ??
        payload.exp ?? payload.xp;

      const ticketsSrc =
        stats.tickets ??
        wallet.tickets ??
        payload.tickets;

      const playsSrc =
        stats.plays ?? stats.play_count ??
        wallet.plays ?? wallet.play_count ??
        payload.plays ?? payload.play_count;

      const xpCapSrc =
        stats.xpCap ?? wallet.xpCap ?? payload.xpCap;

      const levelSrc =
        stats.level ?? stats.lv ??
        wallet.level ??
        payload.level ?? payload.lv;

      if (coinsSrc   != null) coins   = NUM(coinsSrc);
      if (ticketsSrc != null) tickets = NUM(ticketsSrc);
      if (xpSrc      != null) xp      = NUM(xpSrc);
      if (playsSrc   != null) plays   = NUM(playsSrc);
      if (xpCapSrc   != null) xpCap   = NUM(xpCapSrc);
      if (levelSrc   != null) level   = NUM(levelSrc);

      // userId ë™ê¸°í™”
      if (payload.userId != null || payload.user_id != null){
        ACCOUNT_TOTALS.userId = String(payload.userId ?? payload.user_id);
      }

      // totals ë°˜ì˜
      ACCOUNT_TOTALS.coins   = coins;
      ACCOUNT_TOTALS.tickets = tickets;
      ACCOUNT_TOTALS.xp      = xp;
      ACCOUNT_TOTALS.xpCap   = xpCap;
      ACCOUNT_TOTALS.plays   = plays;
      ACCOUNT_TOTALS.level   = level;

      // localStorage ë°˜ì˜
      writeTotalsToLocal({
        coins:   coins,
        tickets: tickets,
        xp:      xp,
        xpCap:   xpCap,
      });

      // âœ… HUDëŠ” ì—¬ê¸°ì„œë§Œ ê°±ì‹ 
      renderHudFromState();
      renderShopCounters();
    }

    // (B) âœ… ì „ì—­ ê³µí†µ í•¨ìˆ˜ ë…¸ì¶œ: ë‹¤ë¥¸ í˜ì´ì§€ê°€ â€œí—ˆë¸Œ í•¨ìˆ˜â€ë¥¼ í˜¸ì¶œí•  ìˆ˜ ìˆê²Œ ë§Œë“¤ê¸°
    if (!window.applyAccountApiResponse) {
      window.applyAccountApiResponse = applyAccountApiResponseLocal;
    }

    // (ì„ íƒ) í˜¸í™˜ìš© ë³„ì¹­ì´ í•„ìš”í•˜ë©´(ë‹¤ë¥¸ íŒŒì¼ë“¤ì´ ì´ ì´ë¦„ì„ ì“´ë‹¤ë©´)
    if (!window.RG_applyAccountApiResponse) {
      window.RG_applyAccountApiResponse = window.applyAccountApiResponse;
    }

    // âœ… ë¡œê·¸ì¸ ì‹¤íŒ¨/ë¡œê·¸ì•„ì›ƒ ì‹œ HUD + ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì´ˆê¸°í™”
    function resetAccountTotalsAndStorage(){
      ACCOUNT_TOTALS.coins   = 0;
      ACCOUNT_TOTALS.tickets = 0;
      ACCOUNT_TOTALS.xp      = 0;
      ACCOUNT_TOTALS.plays   = 0;
      ACCOUNT_TOTALS.xpCap   = 20000;
      ACCOUNT_TOTALS.level   = null;

      try{
        const prefix = getStoragePrefix();
        localStorage.setItem(prefix + '_coins',   '0');
        localStorage.setItem(prefix + '_tickets', '0');
        localStorage.setItem(prefix + '_xp',      '0');
        localStorage.setItem(prefix + '_xp_cap',  '20000');
        localStorage.setItem(prefix + '_plays',   '0');
      }catch(e){
        console.warn("[RG] resetAccountTotalsAndStorage localStorage error:", e);
      }

      // âœ… HUD ë‹¨ì¼ ë£¨íŠ¸
      pushHudFromTotals();
      renderShopCounters();
    }

    // âœ… ì´ˆê¸° HUD ë™ê¸°í™”: ì§ì ‘ renderHUD() í˜¸ì¶œ ê¸ˆì§€
    pushHudFromTotals();
    window.addEventListener('storage', e=>{
      if(!e.key) return;
      // âœ… ìœ ì €ë³„ prefixê°€ ë‹¬ë¼ë„ suffixë§Œ ë§ìœ¼ë©´ HUD ê°±ì‹ 
      if(
        e.key.endsWith('_coins')   ||
        e.key.endsWith('_tickets') ||
        e.key.endsWith('_xp')      ||
        e.key.endsWith('_xp_cap')  ||
        e.key.endsWith('_plays')
      ){
        // âœ… HUD ë‹¨ì¼ ë£¨íŠ¸
        pushHudFromTotals();
        renderShopCounters();
      }
    });

    function redirectToLogin(){
      try{
        const next = encodeURIComponent(location.pathname + location.search);
        window.location.href = BASE + "login.html?next=" + next;
      }catch(e){
        window.location.href = BASE + "login.html";
      }
    }

    function updateUserGreeting(user){
      try{
        const el = document.getElementById("userGreeting");
        if(!el) return;
        if(!user){
          el.textContent = "";
          return;
        }
        const name =
          user.username ||
          user.name ||
          (user.email ? String(user.email).split("@")[0] : "") ||
          "";
        if(!name){
          el.textContent = "";
          return;
        }
        el.textContent = name + " ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!";
      }catch(e){
        console.error("user greeting error", e);
      }
    }

    function applyAccountStatsFromUser(user){
      if(!user) return;
      const stats = user.stats || {};
      applyAccountApiResponseLocal({
        userId: (user.id != null)
          ? user.id
          : (user.user_id != null ? user.user_id : undefined),
        stats
      });
    }

    async function syncWalletFromServer(){
      try{
        const res = await fetch(WALLET_API_BASE + "?summary=1", {
          method: "GET",
          credentials: "include",
          headers: {
            "Accept": "application/json",
            "Cache-Control": "no-store"
          }
        });
        if(!res.ok) return;
        const data = await res.json().catch(()=>null);
        if(!data || !data.wallet) return;

        // âœ… ì§€ê°‘ ì‘ë‹µì€ ì „ë¶€ ê³µí†µ í•¨ìˆ˜ë¡œ ì²˜ë¦¬
        applyAccountApiResponseLocal({ wallet: data.wallet });
      }catch(err){
        console.warn("[RG][wallet] sync from /api/wallet failed:", err);
      }
    }

    window.ensureLoggedIn = async function ensureLoggedIn(){
      try{
        const res = await fetch(AUTH_API_BASE + "/me", {
          method: "GET",
          credentials: "include",
          headers: {
            "Accept": "application/json",
            "Cache-Control": "no-store"
          }
        });

        if(!res.ok){
          ACCOUNT_TOTALS.userId = null;
          updateUserGreeting(null);
          resetAccountTotalsAndStorage();   // âœ… ìƒˆ í•¨ìˆ˜ë¡œ HUD+storage ì´ˆê¸°í™”
          return;
        }

        let data = null;
        try{
          data = await res.json();
        }catch(_){}

        if(!data || !data.ok || !data.user){
          ACCOUNT_TOTALS.userId = null;
          updateUserGreeting(null);
          resetAccountTotalsAndStorage();   // âœ…
          return;
        }

        window.__RG_CURRENT_USER__ = data.user;
        updateUserGreeting(data.user);
        applyAccountStatsFromUser(data.user);

        if (window.RG && typeof window.RG.getSession === "function") {
          window.RG.getSession({ refresh: true }).catch(()=>{});
        }

        syncWalletFromServer().catch(()=>{});
      }catch(err){
        console.error("auth check error", err);
        ACCOUNT_TOTALS.userId = null;
        updateUserGreeting(null);
        resetAccountTotalsAndStorage();  // âœ…
      }
    };

    (function consumeQueryReward(){
      const p = new URLSearchParams(location.search);
      const c = NUM(p.get('coins'));
      const tk = NUM(p.get('tickets'));
      const x = NUM(p.get('xp'));
      if (c || tk || x){
        addReward({coins:c,tickets:tk,xp:x});
        history.replaceState({}, "", location.pathname);
      }
    })();

    (function consumeQueuedReward(){
      const raw = localStorage.getItem('rg_reward');
      if(!raw) return;
      try{
        const r = JSON.parse(raw)||{};
        if (r && (r.coins||r.tickets||r.xp)) addReward(r);
      }catch(e){}
      localStorage.removeItem('rg_reward');
    })();

    (function(){
      const params = new URLSearchParams(location.search);

      // OAuth ì½œë°±(code) ì²˜ë¦¬ ì¤‘ì—ëŠ” ë³„ë„ ì¸ì¦ ê°€ë“œë¥¼ íƒœìš°ì§€ ì•ŠìŒ
      if (params.get("code")) {
        return;
      }

      // ë©”ì¸ ì¸ì¦ ê°€ë“œ
      async function runGuard() {
        // 1) App.js ìª½ì— ì „ì—­ requireAuth ê°€ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ìš°ì„  ì‚¬ìš©
        if (window.RG && typeof window.RG.requireAuth === "function") {
          await window.RG.requireAuth();
          // ì—¬ê¸°ì„œ return í•˜ì§€ ì•Šê³  ì•„ë˜ ensureLoggedIn()ë„ ê°™ì´ íƒœì›€
        }

        // 2) êµ¬ë²„ì „/ëŒ€ì²´ ì „ì—­ ê°€ë“œ
        if (typeof window.requireAuth === "function") {
          window.requireAuth();
          return;
        }

        // 3) fallback: /api/auth/me ê²€ì‚¬ + ì‹¤íŒ¨ ì‹œ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        if (typeof window.ensureLoggedIn === "function") {
          try {
            // ensureLoggedIn() ë‚´ë¶€ì—ì„œ ACCOUNT_TOTALS.userId ë¥¼ ì„¸íŒ…/ì´ˆê¸°í™”í•¨
            await window.ensureLoggedIn();

            // ë¡œê·¸ì¸ ì‹¤íŒ¨(ë˜ëŠ” ê²ŒìŠ¤íŠ¸)ë¼ë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ê°•ì œ ì´ë™
            if (!ACCOUNT_TOTALS.userId) {
              redirectToLogin();
            }
          } catch (e) {
            console.error("ensureLoggedIn failed:", e);
            redirectToLogin();
          }
        } else {
          // ensureLoggedIn ë„ ì—†ìœ¼ë©´ ë°”ë¡œ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
          redirectToLogin();
        }
      }

      // âš  defer ìŠ¤í¬ë¦½íŠ¸(app.js)ê°€ ë¨¼ì € ì‹¤í–‰ëœ ë’¤ì— ê°€ë“œë¥¼ íƒœìš°ê¸° ìœ„í•´
      //    DOMContentLoaded ì‹œì ì— runGuard ì‹¤í–‰
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", runGuard);
      } else {
        runGuard();
      }
    })();

    /* ===== ë­í‚¹ ëª¨ë‹¬ ë¡œì§ ===== */
    const RANK_GAMES = [
      { slug:"2048",          label:"2048" },
      { slug:"brick-breaker", label:"Brick Breaker" },
      { slug:"brick-match",   label:"Brick Match" },
      { slug:"retro-running", label:"Retro Runner" },
      { slug:"tetris",        label:"Tetris" }
    ];

    let currentRankingGame = "2048";
    let rankModalInitialized = false;

    function mapGenderToLabel(g){
      if(!g) return "-";
      const s = String(g).toLowerCase();
      if(["m","male","ë‚¨","ë‚¨ì"].includes(s)) return "ë‚¨";
      if(["f","female","ì—¬","ì—¬ì"].includes(s)) return "ì—¬";
      return s;
    }

    function formatRankTime(value){
      if(!value) return "-";
      try{
        const d = new Date(value);
        if(!Number.isFinite(d.getTime())) return String(value);
        return d.toLocaleString("ko-KR");
      }catch(e){
        return String(value);
      }
    }

    function ensureRankTabs(){
      if(rankModalInitialized) return;
      const tabsWrap = document.getElementById("rankGameTabs");
      if(!tabsWrap) return;
      RANK_GAMES.forEach(game=>{
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "rank-game-tab";
        btn.setAttribute("data-game", game.slug);
        btn.setAttribute("role","tab");
        btn.innerHTML = `<span class="code">${game.label}</span><span>ë­í‚¹</span>`;
        btn.addEventListener("click", ()=>loadRanking(game.slug));
        tabsWrap.appendChild(btn);
      });
      rankModalInitialized = true;
    }

    function setActiveRankTab(slug){
      const tabsWrap = document.getElementById("rankGameTabs");
      if(!tabsWrap) return;
      [...tabsWrap.querySelectorAll(".rank-game-tab")].forEach(btn=>{
        const g = btn.getAttribute("data-game");
        if(g === slug) btn.classList.add("active");
        else btn.classList.remove("active");
      });
    }

    function renderRankingPlaceholder(){
      const body = document.getElementById("rankTableBody");
      const loading = document.getElementById("rankTableLoading");
      if(!body) return;
      body.innerHTML = "";
      const div = document.createElement("div");
      div.className = "rank-table-empty";
      div.textContent = "ë­í‚¹ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.";
      body.appendChild(div);
      if(loading) loading.style.display = "none";
    }

    function renderRankingLoading(){
      const body = document.getElementById("rankTableBody");
      const loading = document.getElementById("rankTableLoading");
      if(!body) return;
      body.innerHTML = "";
      const div = loading || document.createElement("div");
      div.id = "rankTableLoading";
      div.className = "rank-table-loading";
      div.textContent = "ê²Œì„ ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...";
      body.appendChild(div);
    }

    function renderRanking(gameSlug, items){
      const body = document.getElementById("rankTableBody");
      if(!body) return;
      body.innerHTML = "";

      if(!items || !items.length){
        const empty = document.createElement("div");
        empty.className = "rank-table-empty";
        empty.textContent = "ì•„ì§ ë­í‚¹ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ê²Œì„ì„ í”Œë ˆì´í•˜ê³  ìµœê³  ê¸°ë¡ì— ë„ì „í•´ ë³´ì„¸ìš”!";
        body.appendChild(empty);
        return;
      }

      items.slice(0,100).forEach((item, index)=>{
        const row = document.createElement("div");
        row.className = "rank-table-row";

        const rank = item.rank || (index+1);
        const userId = item.userId || item.user_id || item.username || "-";
        const gender = item.gender || item.sex || "-";
        const score = item.score != null ? item.score : (item.bestScore || item.value || 0);
        const points = item.points != null ? item.points : (item.rewardPoints || item.coins || 0);
        const time = item.achievedAt || item.achieved_at || item.updatedAt || item.updated_at || null;

        row.innerHTML = `
          <div class="rank-table-cell-rank">${rank}</div>
          <div class="rank-table-cell-user" title="${userId}">${userId}</div>
          <div class="rank-table-cell-gender">${mapGenderToLabel(gender)}</div>
          <div class="rank-table-cell-score">${fmt(score)}</div>
          <div class="rank-table-cell-points">${fmt(points)}</div>
          <div class="rank-table-cell-time" title="${formatRankTime(time)}">${formatRankTime(time)}</div>
        `;
        body.appendChild(row);
      });
    }

    async function loadRanking(slug){
      currentRankingGame = slug || currentRankingGame || "2048";
      ensureRankTabs();
      setActiveRankTab(currentRankingGame);

      const labelEl = document.getElementById("rankModalGameLabel");
      const gameMeta = RANK_GAMES.find(g=>g.slug===currentRankingGame);
      if(labelEl){
        labelEl.textContent = gameMeta ? `Â· ${gameMeta.label}` : "";
      }

      renderRankingLoading();

      const url = LEADERBOARD_API_BASE +
        "?game=" + encodeURIComponent(currentRankingGame) +
        "&limit=100";

      try{
        const res = await fetch(url, {
          method:"GET",
          headers:{
            "Accept":"application/json",
            "Cache-Control":"no-store"
          },
          credentials:"include"
        });

        if(!res.ok){
          console.warn("leaderboard api error", res.status);
          renderRankingPlaceholder();
          return;
        }

        let data = null;
        try{
          data = await res.json();
        }catch(e){
          console.error("leaderboard json parse error", e);
        }

        let list = [];
        if(data){
          if(Array.isArray(data.items)) list = data.items;
          else if(Array.isArray(data.leaderboard)) list = data.leaderboard;
          else if(Array.isArray(data.data)) list = data.data;
        }

        if(!list || !list.length){
          renderRankingPlaceholder();
          return;
        }

        renderRanking(currentRankingGame, list);
      }catch(err){
        console.error("leaderboard fetch error", err);
        renderRankingPlaceholder();
      }
    }

    function openRankingModal(initialGame){
      const backdrop = document.getElementById("rankModalBackdrop");
      if(!backdrop) return;
      ensureRankTabs();
      backdrop.classList.add("open");
      backdrop.setAttribute("aria-hidden","false");

      if(initialGame) currentRankingGame = initialGame;
      loadRanking(currentRankingGame);

      document.addEventListener("keydown", handleRankModalKeydown);
    }

    function closeRankingModal(){
      const backdrop = document.getElementById("rankModalBackdrop");
      if(!backdrop) return;
      backdrop.classList.remove("open");
      backdrop.setAttribute("aria-hidden","true");
      document.removeEventListener("keydown", handleRankModalKeydown);
    }

    function handleRankBackdropClick(e){
      const backdrop = document.getElementById("rankModalBackdrop");
      if(!backdrop) return;
      if(e.target === backdrop){
        closeRankingModal();
      }
    }

    function handleRankModalKeydown(e){
      if(e.key === "Escape"){
        closeRankingModal();
      }
    }

    (function(){
      const backdrop = document.getElementById("rankModalBackdrop");
      if(backdrop){
        backdrop.addEventListener("click", handleRankBackdropClick);
      }
    })();

    /* ===== ì„¤ì • ëª¨ë‹¬ ë¡œì§ ===== */
    const SETTINGS_STORAGE_KEY = "rg_user_settings";
    const DEFAULT_SETTINGS = {
      soundMaster:   true,
      bgm:           true,
      backgroundFx:  true,
      reducedMotion: false,
      gameCountdown: true,
      gameHints:     true,
    };

    let fxEnabled = true;

    /* ğŸµ í—ˆë¸Œ BGM ì œì–´ìš© í—¬í¼ */
    let bgmAudio = null;
    let hubBgmUnlockBound = false;
    let hubBgmShouldPlay = false;
    function getBgmAudio(){
      if(!bgmAudio){
        bgmAudio = document.getElementById("hubBgm");
        if(bgmAudio){
          bgmAudio.volume = 0.5;
        }
      }
      return bgmAudio;
    }

    function syncBgmWithSettings(settings) {
      const audio = getBgmAudio();
      if (!audio) return;

      const enabled = settings.soundMaster && settings.bgm;
      // í˜„ì¬ ì„¤ì • ìƒíƒœë¥¼ ê¸°ì–µí•´ ë‘ì—ˆë‹¤ê°€, ë‚˜ì¤‘ì— í´ë¦­ìœ¼ë¡œ í’€ ë•Œ ì‚¬ìš©
      hubBgmShouldPlay = enabled;

      // ë„ëŠ” ìª½ì´ë©´ ë°”ë¡œ ì •ì§€
      if (!enabled) {
        try { audio.pause(); } catch (e) {}
        return;
      }

      // 1ì°¨ ì‹œë„: í˜ì´ì§€ ë¡œë“œ ì‹œ ë°”ë¡œ ì¬ìƒ
      try {
        const p = audio.play();
        if (p && typeof p.catch === 'function') {
      p.catch(() => {
        // âŒ ìë™ì¬ìƒì´ ë§‰íŒ ê²½ìš° â†’ ì²« ì‚¬ìš©ì ì…ë ¥ ë•Œ ë‹¤ì‹œ ì‹œë„
        if (hubBgmUnlockBound) return;

        const unlock = () => {
          if (!hubBgmShouldPlay) return;
          try { audio.play(); } catch (e) {}
          window.removeEventListener('click', unlock);
          window.removeEventListener('keydown', unlock);
          window.removeEventListener('touchstart', unlock);
          hubBgmUnlockBound = false;
        };

        hubBgmUnlockBound = true;
        window.addEventListener('click', unlock, { once: true });
        window.addEventListener('keydown', unlock, { once: true });
        window.addEventListener('touchstart', unlock, { once: true, passive: true });
        });
       }
      } catch (e) {
    // ì—ëŸ¬ëŠ” ì¡°ìš©íˆ ë¬´ì‹œ
      }
    }

    function ensureBgmUserStart(){
      const audio = getBgmAudio();
      if(!audio) return;
      if(audio.muted) return;
      if(audio.paused){
        try{
          audio.play().catch(function(){});
        }catch(e){}
      }
    }

    window.addEventListener("click", function(){
      ensureBgmUserStart();
    }, { once:true });

    window.addEventListener("keydown", function(e){
      if(e.key === "Enter" || e.key === " "){
        ensureBgmUserStart();
      }
    }, { once:true });

    function loadSettings(){
      try{
        const raw = localStorage.getItem(SETTINGS_STORAGE_KEY);
        if(!raw) return { ...DEFAULT_SETTINGS };
        const parsed = JSON.parse(raw);
        return { ...DEFAULT_SETTINGS, ...(parsed || {}) };
      }catch(e){
        console.warn("[RG][settings] load failed:", e);
        return { ...DEFAULT_SETTINGS };
      }
    }

    function saveSettings(settings){
      try{
        localStorage.setItem(SETTINGS_STORAGE_KEY, JSON.stringify(settings || {}));
      }catch(e){
        console.warn("[RG][settings] save failed:", e);
      }
    }

    function syncSettingsUI(settings){
      const mapping = [
        ["soundMaster","settingSoundMaster"],
        ["bgm","settingBgm"],
        ["backgroundFx","settingBackgroundFx"],
        ["reducedMotion","settingReducedMotion"],
        ["gameCountdown","settingGameCountdown"],
        ["gameHints","settingGameHints"],
      ];
      mapping.forEach(([key,id])=>{
        const input = document.getElementById(id);
        const toggle = input && input.closest(".settings-toggle");
        if(!input || !toggle) return;
        const val = settings[key] !== false;
        input.checked = val;
        toggle.setAttribute("data-on", val ? "true" : "false");
      });
    }

    function applySettingsToPage(settings){
      fxEnabled = settings.backgroundFx !== false;

      try{
        if(settings.reducedMotion){
          document.documentElement.classList.add("rg-reduced-motion");
        }else{
          document.documentElement.classList.remove("rg-reduced-motion");
        }
      }catch(e){}

      /* ğŸµ ì„¤ì • ë°˜ì˜ ì‹œ BGM on/off ë™ê¸°í™” */
      syncBgmWithSettings(settings);

      try{
        window.RG_HUB = window.RG_HUB || {};
        window.RG_HUB.getSettings = function(){
          return { ...settings };
        };
      }catch(e){}
    }

    let currentSettings = loadSettings();
    applySettingsToPage(currentSettings);

    function openSettingsModal(){
      try{
        const backdrop = document.getElementById("settingsModalBackdrop");
        if(!backdrop) return;
        currentSettings = loadSettings();
        syncSettingsUI(currentSettings);
        applySettingsToPage(currentSettings);

        backdrop.classList.add("open");
        backdrop.setAttribute("aria-hidden","false");

        document.addEventListener("keydown", handleSettingsKeydown);
      }catch(e){
        console.error("[RG][settings] open error:", e);
      }
    }

    function closeSettingsModal(){
      try{
        const backdrop = document.getElementById("settingsModalBackdrop");
        if(!backdrop) return;
        backdrop.classList.remove("open");
        backdrop.setAttribute("aria-hidden","true");
        document.removeEventListener("keydown", handleSettingsKeydown);
      }catch(e){
        console.error("[RG][settings] close error:", e);
      }
    }

    function handleSettingsKeydown(e){
      if(e.key === "Escape"){
        closeSettingsModal();
      }
    }

    function handleSettingsBackdropClick(e){
      const backdrop = document.getElementById("settingsModalBackdrop");
      if(!backdrop) return;
      if(e.target === backdrop){
        closeSettingsModal();
      }
    }

    (function attachSettingsHandlers(){
      const backdrop = document.getElementById("settingsModalBackdrop");
      if(backdrop){
        backdrop.addEventListener("click", handleSettingsBackdropClick);
      }

      const toggles = document.querySelectorAll(".settings-toggle");
      toggles.forEach(function(toggle){
        const input = toggle.querySelector("input[type='checkbox']");
        const key = toggle.getAttribute("data-setting-key");
        if(!input || !key) return;

        const onChange = function(){
          const checked = !!input.checked;
          toggle.setAttribute("data-on", checked ? "true" : "false");
          currentSettings[key] = checked;
          saveSettings(currentSettings);
          applySettingsToPage(currentSettings);
        };

        input.addEventListener("change", onChange);
        toggle.addEventListener("click", function(evt){
          if(evt.target === input) return;
          input.checked = !input.checked;
          onChange();
        });
      });
    })();

    function openMyPageFromSettings(){
      try{
        window.location.href = BASE + "mypage.html";
      }catch(e){}
    }

    function logoutFromSettings(){
      try{
        if(window.RG && typeof window.RG.logout === "function"){
          window.RG.logout().catch(function(){});
        }
      }catch(e){}

      // âœ… HUD + ë¡œì»¬ìŠ¤í† ë¦¬ì§€ë„ ê°™ì´ ì´ˆê¸°í™”
      try{
        ACCOUNT_TOTALS.userId = null;
        resetAccountTotalsAndStorage();
      }catch(e){
        console.warn("[RG] logout reset error:", e);
      }

      try{
        window.location.href = BASE + "logout.html";
      }catch(e){}
    }

    window.openSettingsModal = openSettingsModal;
    window.closeSettingsModal = closeSettingsModal;

    /* ===== SHOP ëª¨ë‹¬ ë¡œì§ (AJAX ìƒì ) ===== */
    const SHOP_API = {
      list: "/specials/shop",
      buy:  "/specials/shop/buy"
    };

    let shopLoaded = false;
    let shopItems = [];
    let shopCurrentFilter = "all";
    let shopCurrentSort = "recommended";
    let shopToastTimer = null;

    const SHOP_FALLBACK_ITEMS = [
      {
        id:"ads_3h",
        category:"ads",
        name:"3ì‹œê°„ ê´‘ê³  ì œê±°",
        desc:"3ì‹œê°„ ë™ì•ˆ RETRO GAMES ë‚´ ë°°ë„ˆ ê´‘ê³ ë¥¼ ìˆ¨ê¹ë‹ˆë‹¤.",
        badge:"HOT",
        priceCoins:150,
        durationLabel:"3ì‹œê°„",
        tag:"ADS Â· ê´‘ê³  ì œê±°",
        sortWeight:10
      },
      {
        id:"ads_1d",
        category:"ads",
        name:"1ì¼ ê´‘ê³  ì œê±°",
        desc:"ì˜¤ëŠ˜ í•˜ë£¨ë§Œí¼ì€ ëª°ì…í•´ì„œ í”Œë ˆì´í•˜ì„¸ìš”.",
        badge:"BEST",
        priceCoins:300,
        durationLabel:"24ì‹œê°„",
        tag:"ADS Â· ê´‘ê³  ì œê±°",
        sortWeight:9
      },
      {
        id:"xp_30m_2x",
        category:"xp",
        name:"XP 2ë°° Â· 30ë¶„",
        desc:"30ë¶„ ë™ì•ˆ íšë“ ê²½í—˜ì¹˜ê°€ 2ë°°ê°€ ë©ë‹ˆë‹¤.",
        badge:"NEW",
        priceCoins:120,
        durationLabel:"30ë¶„",
        tag:"XP Â· ê²½í—˜ì¹˜ ë¶€ìŠ¤íŠ¸",
        sortWeight:8
      },
      {
        id:"xp_90m_2x",
        category:"xp",
        name:"XP 2ë°° Â· 90ë¶„",
        desc:"ê¸´ í”Œë ˆì´ ì„¸ì…˜ì— ì í•©í•œ 2ë°° ê²½í—˜ì¹˜ ë¶€ìŠ¤íŠ¸.",
        badge:"",
        priceCoins:260,
        durationLabel:"90ë¶„",
        tag:"XP Â· ê²½í—˜ì¹˜ ë¶€ìŠ¤íŠ¸",
        sortWeight:7
      },
      {
        id:"xp_3h_3x",
        category:"xp",
        name:"XP 3ë°° Â· 3ì‹œê°„",
        desc:"íŠ¹í›ˆ ëª¨ë“œ! 3ë°° ê²½í—˜ì¹˜ë¡œ ë­í‚¹ì„ ë…¸ë ¤ë³´ì„¸ìš”.",
        badge:"ğŸ”¥",
        priceCoins:420,
        durationLabel:"3ì‹œê°„",
        tag:"XP Â· ê²½í—˜ì¹˜ ë¶€ìŠ¤íŠ¸",
        sortWeight:6
      },
      {
        id:"coin_pack_s",
        category:"coins",
        name:"ì½”ì¸ íŒ¨í‚¤ì§€ Â· S",
        desc:"ì†ŒëŸ‰ì˜ ì½”ì¸ì„ ì¶©ì „í•©ë‹ˆë‹¤.",
        badge:"",
        priceCoins:0,
        rewardCoins:300,
        durationLabel:"ì¦‰ì‹œ ì§€ê¸‰",
        tag:"COINS Â· ì½”ì¸ ì¶©ì „",
        sortWeight:5
      },
      {
        id:"coin_pack_m",
        category:"coins",
        name:"ì½”ì¸ íŒ¨í‚¤ì§€ Â· M",
        desc:"ê°€ì„±ë¹„ ì¢‹ì€ ì½”ì¸ ë²ˆë“¤.",
        badge:"â˜…",
        priceCoins:0,
        rewardCoins:800,
        durationLabel:"ì¦‰ì‹œ ì§€ê¸‰",
        tag:"COINS Â· ì½”ì¸ ì¶©ì „",
        sortWeight:4
      },
      {
        id:"coin_pack_l",
        category:"coins",
        name:"ì½”ì¸ íŒ¨í‚¤ì§€ Â· L",
        desc:"ë­í‚¹ ë„ì „ì„ ìœ„í•œ ëŒ€ìš©ëŸ‰ ì½”ì¸ ë²ˆë“¤.",
        badge:"VALUE",
        priceCoins:0,
        rewardCoins:1800,
        durationLabel:"ì¦‰ì‹œ ì§€ê¸‰",
        tag:"COINS Â· ì½”ì¸ ì¶©ì „",
        sortWeight:3
      },
      {
        id:"ticket_5",
        category:"tickets",
        name:"í‹°ì¼“ 5ì¥ ë²ˆë“¤",
        desc:"í”Œë ˆì´ ì „ìš© í‹°ì¼“ 5ì¥ì„ ì§€ê¸‰í•©ë‹ˆë‹¤.",
        badge:"",
        priceCoins:200,
        rewardTickets:5,
        durationLabel:"ì¦‰ì‹œ ì§€ê¸‰",
        tag:"TICKETS Â· í”Œë ˆì´",
        sortWeight:2
      },
      {
        id:"ticket_15",
        category:"tickets",
        name:"í‹°ì¼“ 15ì¥ ë²ˆë“¤",
        desc:"ìì£¼ í”Œë ˆì´í•˜ëŠ” ìœ ì €ì—ê²Œ ì¶”ì²œ.",
        badge:"BEST",
        priceCoins:500,
        rewardTickets:15,
        durationLabel:"ì¦‰ì‹œ ì§€ê¸‰",
        tag:"TICKETS Â· í”Œë ˆì´",
        sortWeight:1
      },
      {
        id:"special_lucky_3",
        category:"special",
        name:"ì˜¤ëŠ˜ì˜ í–‰ìš´ 3íšŒê¶Œ",
        desc:"ì˜¤ëŠ˜ì˜ í–‰ìš´ ë½‘ê¸°ë¥¼ 3íšŒ ì¶”ê°€ë¡œ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
        badge:"SP",
        priceCoins:260,
        durationLabel:"ë‹¹ì¼ í•œì •",
        tag:"SPECIAL Â· í–‰ìš´ ë½‘ê¸°",
        sortWeight:0
      }
    ];

    function showShopToast(message){
      try{
        const el = document.getElementById("shopToast");
        const msgEl = document.getElementById("shopToastMsg");
        if(!el || !msgEl) return;
        msgEl.textContent = message || "";
        el.classList.add("show");
        if(shopToastTimer) clearTimeout(shopToastTimer);
        shopToastTimer = setTimeout(()=>hideShopToast(), 3200);
      }catch(e){}
    }

    function hideShopToast(){
      try{
        const el = document.getElementById("shopToast");
        if(!el) return;
        el.classList.remove("show");
      }catch(e){}
    }

    function renderShopCounters(){
      try{
        const t = readTotals();
        const coinsEl   = document.getElementById("shopCoinsVal");
        const ticketsEl = document.getElementById("shopTicketsVal");
        const xpEl      = document.getElementById("shopXpVal");
        if(coinsEl)   coinsEl.textContent   = fmt(t.coins);
        if(ticketsEl) ticketsEl.textContent = fmt(t.tickets);
        if(xpEl)      xpEl.textContent      = fmt(t.xp);
      }catch(e){}
    }

    function normalizeShopItem(raw){
      const base = {...raw};
      base.category = (base.category || "special").toLowerCase();
      base.priceCoins = NUM(base.priceCoins ?? base.price ?? base.cost ?? 0);
      base.rewardCoins = NUM(base.rewardCoins ?? base.coins ?? 0);
      base.rewardTickets = NUM(base.rewardTickets ?? base.tickets ?? 0);
      base.durationLabel = base.durationLabel || base.durationText || "";
      base.badge = base.badge || "";
      base.tag = base.tag || "";
      base.sortWeight = NUM(base.sortWeight ?? 0);
      return base;
    }

    function getSortedFilteredItems(){
      let items = shopItems.slice();
      if(shopCurrentFilter && shopCurrentFilter !== "all"){
        items = items.filter(it=>it.category === shopCurrentFilter);
      }
      items.sort((a,b)=>{
        if(shopCurrentSort === "priceLow"){
          const pa = a.priceCoins || 0;
          const pb = b.priceCoins || 0;
          return pa - pb;
        }
        if(shopCurrentSort === "priceHigh"){
          const pa = a.priceCoins || 0;
          const pb = b.priceCoins || 0;
          return pb - pa;
        }
        if(shopCurrentSort === "duration"){
          return (b.sortWeight||0) - (a.sortWeight||0);
        }
        return (a.sortWeight||0) - (b.sortWeight||0);
      });
      return items;
    }

    function renderShopGrid(){
      const grid = document.getElementById("shopGrid");
      if(!grid) return;
      grid.innerHTML = "";

      const items = getSortedFilteredItems();
      if(!items.length){
        const empty = document.createElement("div");
        empty.className = "shop-empty";
        empty.textContent = "í‘œì‹œí•  ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.";
        grid.appendChild(empty);
        return;
      }

      items.forEach(item=>{
        const card = document.createElement("article");
        card.className = "shop-card";
        const badgeHtml = item.badge ? `<span class="shop-card-badge">${item.badge}</span>` : "";
        const tagText = item.tag || (()=> {
          if(item.category === "ads") return "ADS Â· ê´‘ê³  ì œê±°";
          if(item.category === "xp") return "XP Â· ê²½í—˜ì¹˜ ë¶€ìŠ¤íŠ¸";
          if(item.category === "coins") return "COINS Â· ì½”ì¸ ì¶©ì „";
          if(item.category === "tickets") return "TICKETS Â· í”Œë ˆì´";
          return "SPECIAL ì•„ì´í…œ";
        })();

        const priceLabel = item.priceCoins ? `${fmt(item.priceCoins)} ì½”ì¸` :
          (item.rewardCoins ? `ë³´ìƒ ${fmt(item.rewardCoins)} ì½”ì¸` :
          (item.rewardTickets ? `ë³´ìƒ ${fmt(item.rewardTickets)} í‹°ì¼“` : "-"));

        card.innerHTML = `
          <div class="shop-card-header">
            <div class="shop-card-title-wrap">
              <div class="shop-card-title">${item.name}</div>
              <div class="shop-card-sub">${item.desc || ""}</div>
            </div>
            ${badgeHtml}
          </div>
          <div class="shop-card-meta">
            <div class="shop-card-meta-left">
              <div class="shop-card-tag">${tagText}</div>
              <div class="shop-card-duration">${item.durationLabel || ""}</div>
            </div>
            <div class="shop-card-meta-right">
              ${item.category === "coins" && item.rewardCoins ? `+${fmt(item.rewardCoins)} COINS` : ""}
              ${item.category === "tickets" && item.rewardTickets ? `+${fmt(item.rewardTickets)} TICKETS` : ""}
            </div>
          </div>
          <div class="shop-card-price-row">
            <div class="shop-card-price-main">
              <div class="shop-card-price-unit">ê°€ê²©</div>
              <div class="shop-card-price-value">${priceLabel}</div>
            </div>
          </div>
          <div class="shop-card-actions">
            <button type="button" class="shop-buy-btn primary" data-item-id="${item.id}">ì½”ì¸ìœ¼ë¡œ êµ¬ë§¤</button>
          </div>
        `;
        grid.appendChild(card);
      });

      grid.querySelectorAll(".shop-buy-btn").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-item-id");
          const item = shopItems.find(it=>String(it.id) === String(id));
          if(item) buyShopItem(item,"coins");
        });
      });
    }

    async function fetchShopListFromServer(){
      try{
        const token =
          (window.RG && typeof window.RG.getAuthToken === "function")
            ? (window.RG.getAuthToken() || "")
            : (localStorage.getItem("rg_token") || localStorage.getItem("token") || "");

        const headers = {
          "Accept":"application/json",
          "Cache-Control":"no-store"
        };

        if(token){
          headers["Authorization"] = "Bearer " + token;
        }

        const res = await fetch(SHOP_API.list, {
          method:"GET",
          headers,
          credentials:"include"
        });
        if(!res.ok){
          console.warn("[RG][shop] list api error", res.status);
          return null;
        }
        const data = await res.json().catch(()=>null);
        if(!data) return null;
        const items = Array.isArray(data.items) ? data.items :
                      Array.isArray(data.catalog) ? data.catalog :
                      Array.isArray(data.data) ? data.data : null;
        if(!items) return null;
        return items.map(normalizeShopItem);
      }catch(e){
        console.warn("[RG][shop] list api fetch failed:", e);
        return null;
      }
    }

    async function loadShopDataIfNeeded(){
      if(shopLoaded && shopItems.length){
        renderShopCounters();
        renderShopGrid();
        return;
      }
      renderShopCounters();

      const fromServer = await fetchShopListFromServer();
      if(fromServer && fromServer.length){
        shopItems = fromServer;
      }else{
        shopItems = SHOP_FALLBACK_ITEMS.map(normalizeShopItem);
      }
      shopLoaded = true;
      renderShopGrid();
    }

    async function buyShopItem(item, currency){
      if(!item) return;
      const t = readTotals();
      const price = item.priceCoins || 0;

      if(currency === "coins" && price > t.coins){
        showShopToast("ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ê²Œì„ì„ í”Œë ˆì´í•´ì„œ ì½”ì¸ì„ ëª¨ì•„ë³´ì„¸ìš”!");
        return;
      }

      if(!window.confirm(`'${item.name}' ì•„ì´í…œì„ ${fmt(price)} ì½”ì¸ìœ¼ë¡œ êµ¬ë§¤í•˜ì‹œê² ì–´ìš”?`)){
        return;
      }

      try{
      const token =
        (window.RG && typeof window.RG.getAuthToken === "function")
          ? (window.RG.getAuthToken() || "")
          : (localStorage.getItem("rg_token") || localStorage.getItem("token") || "");

      const headers = { "Content-Type":"application/json" };
      if(token){
        headers["Authorization"] = "Bearer " + token;
      }

      const res = await fetch(SHOP_API.buy, {
        method:"POST",
        headers,
        body: JSON.stringify({
          itemId: String(raw.id),
          name: raw.name,
          payWith
        }),
        credentials:"include"
      });

        const data = await res.json().catch(()=>null);

        if(!res.ok || !data || data.ok === false){
          const msg = (data && (data.message || data.error)) || "êµ¬ë§¤ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.";
          showShopToast(msg);
          return;
        }

        showShopToast("êµ¬ë§¤ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");

        // âœ… 1ìˆœìœ„: ì‘ë‹µ ì•ˆì— ì§€ê°‘/ìŠ¤íƒ¯/í¬ì¸íŠ¸ ì •ë³´ê°€ ê°™ì´ ì˜¨ ê²½ìš° â†’ ê³µí†µ í•¨ìˆ˜ë¡œ ë°”ë¡œ ë°˜ì˜
        if(
          data.wallet ||
          data.stats ||
          typeof data.points   !== "undefined" ||
          typeof data.coins    !== "undefined" ||
          typeof data.tickets  !== "undefined" ||
          typeof data.xp       !== "undefined" ||
          typeof data.plays    !== "undefined" ||
          typeof data.level    !== "undefined" ||
          typeof data.xpCap    !== "undefined"
        ){
          applyAccountApiResponseLocal(data);
        }else{
          // âœ… 2ìˆœìœ„: ë³„ë„ í•„ë“œê°€ ì—†ìœ¼ë©´ /api/wallet ìš”ì•½ì„ ë‹¤ì‹œ ë¶ˆëŸ¬ì™€ì„œ ë°˜ì˜
          await syncWalletFromServer().catch(()=>{});
        }

      }catch(e){
        console.error("[RG][shop] buy error:", e);
        showShopToast("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ êµ¬ë§¤ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      }
    }

    function openShopModal(){
      try{
        const backdrop = document.getElementById("shopModalBackdrop");
        if(!backdrop) return;
        backdrop.classList.add("open");
        backdrop.setAttribute("aria-hidden","false");
        document.addEventListener("keydown", handleShopKeydown);
        loadShopDataIfNeeded();
      }catch(e){}
    }

    function closeShopModal(){
      try{
        const backdrop = document.getElementById("shopModalBackdrop");
        if(!backdrop) return;
        backdrop.classList.remove("open");
        backdrop.setAttribute("aria-hidden","true");
        document.removeEventListener("keydown", handleShopKeydown);
      }catch(e){}
    }

    function handleShopBackdropClick(e){
      const backdrop = document.getElementById("shopModalBackdrop");
      if(!backdrop) return;
      if(e.target === backdrop){
        closeShopModal();
      }
    }

    function handleShopKeydown(e){
      if(e.key === "Escape"){
        closeShopModal();
      }
    }

    (function attachShopHandlers(){
      const backdrop = document.getElementById("shopModalBackdrop");
      if(backdrop){
        backdrop.addEventListener("click", handleShopBackdropClick);
      }
      const filterRow = document.getElementById("shopFilterRow");
      if(filterRow){
        filterRow.querySelectorAll(".shop-filter-btn").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const val = btn.getAttribute("data-filter") || "all";
            shopCurrentFilter = val;
            filterRow.querySelectorAll(".shop-filter-btn").forEach(b=>b.classList.remove("active"));
            btn.classList.add("active");
            renderShopGrid();
          });
        });
      }
      const sortSel = document.getElementById("shopSortSelect");
      if(sortSel){
        sortSel.addEventListener("change", ()=>{
          shopCurrentSort = sortSel.value || "recommended";
          renderShopGrid();
        });
      }
    })();

    window.openShopModal = openShopModal;
    window.closeShopModal = closeShopModal;
    window.RG_addReward = addReward;

    /* ===== ê³µí†µ ê²Œì„ ì‹œì‘/ì¢…ë£Œ + ë³´ìƒ ì—°ë™ í—¬í¼ ===== */
    (function attachGlobalGameHooks(){
      /**
       * ê²Œì„ í˜ì´ì§€ì—ì„œ ê³µí†µìœ¼ë¡œ ì‚¬ìš©í•  ë¡œì»¬ ë³´ìƒ íì‰ í•¨ìˆ˜.
       * - ê° ê²Œì„ì—ì„œ window.RG_queueReward({coins,tickets,xp}) í˜¸ì¶œ í›„ í—ˆë¸Œë¡œ ì´ë™í•˜ë©´
       *   í—ˆë¸Œì˜ consumeQueuedReward()ê°€ ì²˜ë¦¬.
       */
      window.RG_queueReward = function(reward){
        try{
          if(!reward) return;
          const payload = {
            coins:   NUM(reward.coins),
            tickets: NUM(reward.tickets),
            xp:      NUM(reward.xp)
          };
          if(!(payload.coins || payload.tickets || payload.xp)) return;
          localStorage.setItem("rg_reward", JSON.stringify(payload));
        }catch(e){
          console.warn("[RG] queueReward failed:", e);
        }
      };

      /**
       * ê²Œì„ ì‹œì‘ í›… (ê° ê²Œì„ íŒŒì¼ì˜ notifyStart()ì—ì„œ í˜¸ì¶œ ê°€ì •)
       * - ì „ì²´ í”Œë ˆì´ ìˆ˜ ì¦ê°€
       * - analytics.jsì— ì •ì˜ëœ analyticsGameStart(slug, meta) ìˆìœ¼ë©´ í˜¸ì¶œ
       */
      if(!window.gameStart){
        window.gameStart = function(slug, meta){
          try{
            const prefix = getStoragePrefix();
            const key = prefix + "_plays";
            const cur = NUM(localStorage.getItem(key) || 0) + 1;
            localStorage.setItem(key, cur);
            ACCOUNT_TOTALS.plays = cur;
            pushHudFromTotals();
          }catch(e){
            console.warn("[RG] gameStart plays update error:", e);
          }
          try{
            if(typeof window.analyticsGameStart === "function"){
              window.analyticsGameStart(slug, meta || {});
            }
          }catch(e){
            console.warn("[RG] analyticsGameStart error:", e);
          }
        };
      }

      /**
       * ê²Œì„ ì¢…ë£Œ í›… (ê° ê²Œì„ íŒŒì¼ì˜ notifyFinish(score, reward)ì—ì„œ í˜¸ì¶œ ê°€ì •)
       * - rewardê°€ í•¨ê»˜ ë„˜ì–´ì˜¤ë©´ ë¡œì»¬ íì— ì €ì¥ (í—ˆë¸Œ ì…ì¥ ì‹œ addRewardë¡œ ë°˜ì˜)
       * - analytics.jsì— ì •ì˜ëœ analyticsGameFinish(slug, payload) ìˆìœ¼ë©´ í˜¸ì¶œ
       * â€» ì‹¤ì œ ì§€ê°‘(/api/wallet) ì ë¦½ì€ ê° ê²Œì„ íŒŒì¼ì—ì„œ ì´ë¯¸ ì²˜ë¦¬í•˜ëŠ” ê²ƒìœ¼ë¡œ ê°€ì •.
       */
      if(!window.gameFinish){
        window.gameFinish = function(slug, payload){
          try{
            const r = payload && payload.reward;
            if(r && (r.coins || r.tickets || r.xp)){
              window.RG_queueReward(r);
            }
          }catch(e){
            console.warn("[RG] gameFinish reward queue error:", e);
          }
          try{
            if(typeof window.analyticsGameFinish === "function"){
              window.analyticsGameFinish(slug, payload || {});
            }
          }catch(e){
            console.warn("[RG] analyticsGameFinish error:", e);
          }
        };
      }
    })();
  </script>

  <div id="cookieBanner" class="cookie-banner" role="dialog" aria-live="polite" aria-label="Analytics consent">
    <div>ì„œë¹„ìŠ¤ í’ˆì§ˆ í–¥ìƒì„ ìœ„í•œ ë¶„ì„(ì¿ í‚¤) ì‚¬ìš©ì— ë™ì˜í•˜ì‹œë‚˜ìš”?</div>
    <div class="spacer"></div>
    <button class="deny" type="button">ê±°ë¶€</button>
    <button class="agree" type="button">ë™ì˜</button>
  </div>

  <script>
    (function(){
      try{
        var KEY='rg_analytics_consent';
        function init(){ if(typeof window.analyticsInit==='function') window.analyticsInit(); }
        var v=null; try{ v=localStorage.getItem(KEY); }catch(e){}
        var el=document.getElementById('cookieBanner');
        if(v==='yes'){ init(); if(el) el.style.display='none'; return; }
        if(!el){ return; }
        el.style.display='flex';
        var agree=el.querySelector('.agree'), deny=el.querySelector('.deny');
        if(agree) agree.addEventListener('click', function(){
          try{ localStorage.setItem(KEY,'yes'); }catch(e){}
          el.style.display='none'; init();
        });
        if(deny) deny.addEventListener('click', function(){
          try{ localStorage.setItem(KEY,'no'); }catch(e){}
          el.style.display='none';
        });
      }catch(e){}
    })();
  </script>

  <!-- RG-OAUTH-CALLBACK-HANDLER -->
  <script>
    (function(){
      try{
        var params = new URLSearchParams(location.search);
        var code = params.get('code');
        if(!code) return;

        var state = params.get('state');
        var provider = (params.get('provider')||'').toLowerCase();
        if(!provider){
          provider = document.referrer.includes('naver') ? 'naver' : 'kakao';
        }

        var endpoint = provider === 'naver'
          ? AUTH_API_BASE + '/oauth/naver/callback'
          : AUTH_API_BASE + '/oauth/kakao/callback';

        fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type':'application/json',
            'Cache-Control':'no-store'
          },
          credentials: 'include',
          body: JSON.stringify({ code: code, state: state })
        }).then(async function(r){
          var data = null;
          try{ data = await r.json(); }catch(e){}
          if(!r.ok || !data || !data.ok){
            console.error('OAuth callback failed', r.status, data);
            redirectToLogin();  // í˜¹ì€ window.location.href = BASE + "login.html";
            return;
          }
          history.replaceState({}, "", location.pathname);
          if (typeof window.ensureLoggedIn === "function") {
            window.ensureLoggedIn();
          }
          try{
            console.log('ë¡œê·¸ì¸ ì™„ë£Œ:', data.user && (data.user.provider+': '+data.user.name));
          }catch(e){}
        }).catch(function(err){
          console.error('OAuth error', err);
        });
      }catch(e){}
    })();
  </script>
</body>
</html>
