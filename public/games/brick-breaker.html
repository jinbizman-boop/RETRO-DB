<!DOCTYPE html>
<html lang="ko" data-env="production" data-analytics="on">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<!-- Google AdSense ì†Œìœ ê¶Œ í™•ì¸ ë©”íƒ€ íƒœê·¸ -->
<meta name="google-adsense-account" content="ca-pub-6713974265397310" />
<title>RETRO Brick Breaker â€“ Arcade Cabinet</title>

<!-- === Common SEO/A11y (auto-inserted) === -->
<link rel="icon" href="/assets/favicon.ico">
<link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/icon-180.png">
<link rel="manifest" href="/site.webmanifest">
<meta name="theme-color" content="#0e1b34">
<meta name="description" content="RETRO Brick Breaker â€“ Arcade Cabinet | ë ˆíŠ¸ë¡œ ê°ì„± ë¯¸ë‹ˆê²Œì„ì„ ì¦ê¸°ëŠ” RETRO GAMES">
<meta name="robots" content="index,follow">
<meta property="og:site_name" content="RETRO GAMES">
<meta property="og:title" content="RETRO Brick Breaker â€“ Arcade Cabinet">
<meta property="og:description" content="RETRO Brick Breaker â€“ Arcade Cabinet | ë ˆíŠ¸ë¡œ ê°ì„± ë¯¸ë‹ˆê²Œì„ì„ ì¦ê¸°ëŠ” RETRO GAMES">
<meta property="og:type" content="website">
<meta property="og:image" content="/assets/og/retro-games-card.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="RETRO Brick Breaker â€“ Arcade Cabinet">
<meta name="twitter:description" content="RETRO Brick Breaker â€“ Arcade Cabinet | ë ˆíŠ¸ë¡œ ê°ì„± ë¯¸ë‹ˆê²Œì„ì„ ì¦ê¸°ëŠ” RETRO GAMES">
<meta name="twitter:image" content="/assets/og/retro-games-card.png">
<script>
  // fixed environment flags for analytics/runtime
  (function(d){
    d.documentElement.dataset.env = 'production';
    d.documentElement.dataset.analytics = 'on';
    window.__ENV__ = 'production';
    window.__ANALYTICS_ON__ = true;
  })(document);
</script>
<!-- === /Common SEO/A11y === -->

<!-- AdSense ê¸€ë¡œë²Œ ìŠ¤ë‹ˆí« (ì²¨ë¶€ëœ ì½”ë“œ ê·¸ëŒ€ë¡œ) -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6713974265397310"
     crossorigin="anonymous"></script>

<style>
  :root{
    --cabinet:#071933; --cabinet2:#0b2a57; --bezel:#0c1e3f; --glow:#0ea5ff; --side:#f4be09;
    --btn:#133262; --btnBorder:#285dd1; --btnFg:#e9f1ff;
    --board:#121a2f; --tile0:#e9eef6; --ink:#111;
    --t2:#e7f4ff; --t4:#d6eaff; --t8:#ffe7c2; --t16:#ffd6a6; --t32:#ffc8a6; --t64:#ffb79c;
    --t128:#fff3a8; --t256:#fff09a; --t512:#ffeb8a; --t1024:#eaff9c; --t2048:#caffb0; --t4096:#b6ffd2; --t8192:#b2fff0;
  }
  *{box-sizing:border-box}
  html,body{
    height:100%;margin:0;color:#fff;
    font-family:'Pretendard',ui-sans-serif,system-ui,"Segoe UI",Roboto,"Apple SD Gothic Neo";
    overflow:hidden;
    background:radial-gradient(circle at 40% -10%,#320076,#0b001e 70%);
  }
  #fx{position:fixed;inset:0;pointer-events:none;z-index:0;opacity:.75}
  .shell{min-height:100vh;display:grid;place-items:center;padding:20px;position:relative;z-index:1;padding-bottom:calc(20px + env(safe-area-inset-bottom,0))}

  /* Cabinet */
  .cabinet{position:relative;width:min(1200px,96vw);background:#0e1b34;border-radius:18px;box-shadow:0 12px 40px rgba(0,0,0,.65),inset 0 0 0 2px #0a1a33;transform-origin:top center}
  .cabinet:before,.cabinet:after{content:"";position:absolute;top:12px;bottom:12px;width:18px;background:linear-gradient(180deg,#ffd34a,#f0b400 60%,#d99a00);filter:drop-shadow(0 0 12px rgba(255,190,0,.55));}
  .cabinet:before{left:12px;border-radius:9px}
  .cabinet:after{right:12px;border-radius:9px}

  .marquee{padding:18px;border-radius:18px 18px 0 0;background:linear-gradient(180deg,#173763,#0b2548);border-bottom:1px solid #0c2b59;box-shadow:inset 0 -6px 26px rgba(0,0,0,.35)}
  .title{display:flex;align-items:center;justify-content:center;gap:12px;flex-wrap:wrap}
  .title h1{margin:0;font-weight:900;letter-spacing:2px;color:#eaf3ff;text-shadow:0 0 12px rgba(62,142,255,.55);font-size:clamp(18px,4.4vw,28px)}
  .subtitle{opacity:.75;letter-spacing:.2em;font-size:clamp(10px,2.7vw,12px);text-align:center}

  /* HUD */
  .hud{display:flex;gap:12px;padding:12px;justify-content:center;flex-wrap:wrap}
  .chip,.pill,.hud .btnMini{
    position:relative;min-width:128px;height:46px;padding:0 16px;border-radius:14px;border:1px solid #1e63ff;color:#fff;font-weight:900;display:inline-flex;align-items:center;justify-content:center;letter-spacing:.3px;
    background:linear-gradient(180deg,#8fe0ff 0%,#49a8ff 26%,#2f84ff 58%,#1560f2 100%),radial-gradient(140% 120% at 20% -40%,rgba(255,255,255,.65),rgba(255,255,255,0) 55%);
    box-shadow:0 12px 18px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.5), inset 0 -8px 14px rgba(0,0,0,.28);
    touch-action:manipulation;
  }
  .chip b{color:#fff;font-weight:900;padding-left:6px;text-shadow:0 1px 0 rgba(0,0,0,.25)}
  .pill{min-width:260px;gap:12px}
  .pill .icon{width:28px;height:28px;display:grid;place-items:center;border-radius:50%;background:radial-gradient(circle at 30% 30%,#ffffff,#d8f1ff);color:#0b2a57;box-shadow:inset 0 -4px 8px rgba(0,0,0,.25), 0 0 10px rgba(255,255,255,.65)}
  .points .bar,.tickets .bar{height:8px;border-radius:999px;background:#1a2548;overflow:hidden;border:1px solid #2b3f8f;width:120px}
  .points .bar>span,.tickets .bar>span{display:block;height:100%;width:0%;background:linear-gradient(90deg,#b86cff,#6af0ff);box-shadow:0 0 10px #8ad7ff}
  .points .nums,.tickets .nums{display:flex;align-items:baseline;gap:8px;font-weight:900}
  .points .nums .big,.tickets .nums .big{font-size:18px;color:#ffe9a3;text-shadow:0 0 8px #ffd86a}
  .points .nums .cap,.tickets .nums .cap{opacity:.8;font-size:12px}
  .playCount{font-size:12px;opacity:.85;margin-left:6px}

  /* Screen */
  .play{position:relative;margin:10px 18px;border-radius:16px;background:linear-gradient(180deg,#0a1530,#031125);box-shadow:inset 0 0 0 1px #0b2a57,inset 0 0 60px rgba(0,0,0,.55)}
  .screen{aspect-ratio:16/9;display:grid;place-items:center;padding:18px}
  .bezel{width:100%;height:100%;border-radius:14px;background:radial-gradient(120% 200% at 50% -60%,rgba(255,255,255,.07),rgba(255,255,255,0) 40%),linear-gradient(180deg,#0a1c39,#0a1326);box-shadow:inset 0 0 0 1px #132a59,inset 0 0 60px rgba(0,0,0,.65);display:grid;place-items:center;position:relative;overflow:hidden}
  .canvasWrap{width:min(92%,980px);max-height:85%;display:grid;place-items:center}
  canvas#game{width:100%;height:auto;aspect-ratio:16/10;background:#000;border-radius:18px;border:1px solid #1b2b45;box-shadow:inset 0 0 40px rgba(0,0,0,.25)}

  /* Overlay */
  .overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(5,0,20,.55);backdrop-filter:blur(2px);z-index:5}
  .overlay .msg{font-weight:900;letter-spacing:.2em;text-align:center;filter:drop-shadow(0 6px 20px rgba(0,0,0,.6));
    font-size:clamp(28px,5vw,68px);color:#ffe166;text-shadow:0 0 16px rgba(255,225,102,.45),0 0 40px rgba(14,165,255,.25)}
  .overlay .sub{margin-top:10px;font-size:clamp(12px,2.2vw,16px);opacity:.9;color:#dfe9ff;text-align:center}

  /* Deck */
  .deck{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;padding:14px 18px 22px;border-top:1px solid #0a2b57;background:linear-gradient(180deg,#0b1f40,#0a1730)}
  .deck .btn,.deck select,.deck input[type=range]{font-weight:900;color:#dff1ff;background:linear-gradient(180deg,#1b3a7a,#102a66);border:1px solid #224aa8;border-radius:12px;padding:10px 14px;box-shadow:0 10px 18px rgba(0,0,0,.45),inset 0 0 18px rgba(255,255,255,.05);cursor:pointer;touch-action:manipulation}
  .deck .btn:hover,.deck select:hover{filter:brightness(1.06)}
  .deck label{display:flex;align-items:center;gap:8px}
  .deck input[type=range]{width:140px;height:12px;accent-color:#5fb0ff}

  /* Records Modal */
  #recModal{display:none;position:fixed;inset:0;background:rgba(5,0,20,.55);backdrop-filter:blur(4px);align-items:center;justify-content:center;z-index:999}
  /* Ad Modal */
  #adModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.65);backdrop-filter:blur(2px);align-items:center;justify-content:center;z-index:1000}
  #adBox{width:min(680px,92vw);min-height:280px;background:radial-gradient(circle at 50% -60%,#1f0d48,#0c0626 70%);border:2px solid #3e2b7b;border-radius:20px;box-shadow:0 30px 60px #000a,inset 0 0 24px #2a0085;padding:18px;display:flex;flex-direction:column;gap:10px}
  #adHead{display:flex;justify-content:space-between;align-items:center}
  #adClose{border:0;background:#1b2b7a;color:#fff;border-radius:10px;padding:6px 10px;cursor:pointer}
  .adPlaceholder{display:grid;place-items:center;height:220px;border-radius:14px;background:linear-gradient(135deg,#18224a,#0e1636);border:1px dashed #3952c3}

  /* ===== Mobile Responsive ===== */
  @media (max-width: 980px){
    .shell{padding:12px;padding-bottom:calc(12px + env(safe-area-inset-bottom,0))}
    .cabinet{width:100vw;border-radius:0}
    .marquee{padding:12px;border-radius:0}
    .play{margin:8px 12px}
    .screen{padding:10px}
    .hud{gap:8px;padding:10px}
    .chip,.pill,.hud .btnMini{min-width:112px;height:42px;padding:0 12px}
    .pill{min-width:220px}
    .deck{gap:8px;padding:10px 12px 16px}
    .deck .btn,.deck select,.deck input[type=range]{padding:10px 12px}
  }
  @media (max-width: 640px){
    .hud{padding:8px}
    .chip,.pill,.hud .btnMini{height:40px}
    .points .nums .big,.tickets .nums .big{font-size:16px}
    .points .bar,.tickets .bar{width:96px}
    .deck{justify-content:flex-start;overflow:auto;-webkit-overflow-scrolling:touch}
    .deck > *{flex:0 0 auto}
  }

  .cookie-banner{position:fixed;left:12px;right:12px;bottom:12px;
    display:none;align-items:center;gap:10px;padding:10px 12px;border-radius:12px;
    border:1px solid #2b3f8f;background:linear-gradient(180deg,#0b1f40,#0a1730);
    box-shadow:0 10px 18px rgba(0,0,0,.45),inset 0 0 18px rgba(255,255,255,.05);
    z-index:10000;font-size:12px}
  .cookie-banner .spacer{flex:1}
  .cookie-banner button{padding:8px 12px;border-radius:10px;border:1px solid #2d3690;
    background:linear-gradient(180deg,#1a2b7a,#0a1a64);font-weight:800;color:#e9f0ff;cursor:pointer}
  .cookie-banner .agree{background:linear-gradient(180deg,#ffdf6e,#ffb84d);color:#3a2400;border-color:#7a5600}

</style>
</head>

<!-- ì „ì—­ ìŠ¤í¬ë¦½íŠ¸(ëª¨ë“ˆ ì•„ë‹˜) -->
<script defer src="assets/js/app.js"></script>
<script defer src="assets/js/analytics.js"></script>

<body>
  <div id="site-header"></div>
  <canvas id="fx"></canvas>
  <div class="shell">
    <section class="cabinet" aria-label="retro arcade cabinet">
      <header class="marquee">
        <div class="title">
          <h1>RETRO BRICK BREAKER</h1>
          <div class="subtitle">MOUSE Â· TOUCH Â· ARROWS</div>
        </div>
      </header>

      <!-- HUD -->
      <div class="hud">
        <div class="chip">ì ìˆ˜ <b id="score">0</b></div>
        <div class="chip">ìµœê³  <b id="best">0</b></div>
        <div class="chip">ì´ë™ <b id="moves">0</b></div>

        <!-- Points -->
        <div class="pill points" aria-label="ì‚¬ìš©ì í¬ì¸íŠ¸">
          <div class="icon">ğŸ…</div>
          <div>
            <div class="nums"><span class="big" id="pointsAmt">0</span><span class="cap">/ <span id="pointsCap">5,000</span></span></div>
            <div class="bar"><span id="pointsBar"></span></div>
          </div>
        </div>

        <!-- Tickets -->
        <div class="pill tickets" aria-label="í‹°ì¼“ ì§„í–‰">
          <div class="icon">ğŸŸï¸</div>
          <div>
            <div class="nums"><span class="big" id="ticketsAmt">0</span><span class="cap">í‹°ì¼“</span></div>
            <div class="bar"><span id="ticketsBar"></span></div>
          </div>
          <div class="playCount" id="ticketsCap">0 / 10</div>
        </div>

        <button class="btnMini" id="recordsBtn" aria-label="ë‚´ ê²Œì„ ê¸°ë¡">MY RECORDS</button>
      </div>

      <main class="play">
        <div class="screen">
          <div class="bezel">
            <div class="canvasWrap" id="canvasWrap">
              <canvas id="game"></canvas>
            </div>
            <div id="gameOver" class="overlay" aria-live="polite" role="alert">
              <div>
                <div class="msg">GAME OVER</div>
                <div class="sub">N: ìƒˆ ê²Œì„ Â· Enter: ë‹¤ì‹œ ì‹œì‘</div>
              </div>
            </div>
          </div>
        </div>
      </main>

      <!-- Control deck -->
      <div class="deck">
        <button class="btn" id="homeBtn">HOME</button>
        <button class="btn" id="newBtn">ìƒˆ ê²Œì„ (N)</button>
        <button class="btn" id="undoBtn">ì¼ì‹œì •ì§€/ì¬ê°œ (U)</button>
        <label>ëª¨ë“œ
          <select id="tier">
            <option value="beginner">ì´ˆê¸‰ (1â€“10)</option>
            <option value="intermediate">ì¤‘ê¸‰ (11â€“20)</option>
            <option value="advanced">ê³ ê¸‰ (21â€“30)</option>
            <option value="hell">ì§€ì˜¥ (40)</option>
            <option value="doom">íŒŒë©¸ (50)</option>
            <option value="insane">ê·¹ì•…ë¬´ë„ (100)</option>
          </select>
        </label>
        <label>ë ˆë²¨ <input id="lvlRange" type="range" min="1" max="100" value="1" step="1"></label>
        <label>ë³´ë“œ
          <select id="sizeSel">
            <option value="12">ë³´í†µ</option>
            <option value="14">ë„“ìŒ</option>
            <option value="10">ì¢ìŒ</option>
          </select>
        </label>
        <button class="btn" id="endBtn">ê²Œì„ ì¢…ë£Œ</button>
      </div>
    </section>
  </div>

  <!-- Records Modal -->
  <div id="recModal">
    <div style="width:min(640px,94vw);background:radial-gradient(circle at 50% -60%,#1f0d48,#0c0626 70%);border:2px solid #3e2b7b;border-radius:20px;box-shadow:0 30px 60px #000a,inset 0 0 24px #2a0085;padding:22px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><h3 style="margin:0;color:#ffdf6e">ë‚´ ê²Œì„ ê¸°ë¡</h3><button id="recClose" style="border:0;background:transparent;color:#fff;font-size:22px;cursor:pointer">Ã—</button></div>
      <div id="recBody" style="max-height:60vh;overflow:auto;border:1px solid #2a3a89;border-radius:12px;padding:8px"></div>
    </div>
  </div>

  <!-- Ad Modal -->
  <div id="adModal" role="dialog" aria-modal="true" aria-labelledby="adTitle">
    <div id="adBox">
      <div id="adHead">
        <h3 id="adTitle" style="margin:0;color:#ffdf6e">ê´‘ê³ </h3>
        <button id="adClose">ë‹«ê¸°</button>
      </div>
      <div id="adContainer" class="adPlaceholder">
        <div style="text-align:center;opacity:.9">
          <div style="font-weight:900;margin-bottom:6px">ì—¬ê¸°ì— ê´‘ê³ ê°€ í‘œì‹œë©ë‹ˆë‹¤</div>
          <div style="font-size:12px;opacity:.8">ê°œë°œ/í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œëŠ” í”Œë ˆì´ìŠ¤í™€ë”ê°€ ë³´ì…ë‹ˆë‹¤</div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ================= AdSense ================= */
/* âš ï¸ ì‹¤ì œ ê´‘ê³  ë…¸ì¶œì„ ìœ„í•´:
 *  1) AD_CLIENT ëŠ” ë©”íƒ€/ê¸€ë¡œë²Œ ìŠ¤ë‹ˆí«ê³¼ ë™ì¼í•œ ca-pub ID ì‚¬ìš© (ì´ë¯¸ ì¼ì¹˜)
 *  2) AD_SLOT ì— AdSense ì½˜ì†”ì—ì„œ ìƒì„±í•œ ê´‘ê³  ìœ ë‹› IDë¥¼ ë„£ì–´ì£¼ì„¸ìš”.
 */
const AD_CLIENT = 'ca-pub-6713974265397310';
const AD_SLOT   = ''; // ì˜ˆ: '1234567890' í˜•íƒœì˜ ê´‘ê³  ë‹¨ìœ„ ID (AdSense ì½˜ì†”ì—ì„œ ë³µì‚¬í•´ì„œ ë„£ê¸°)

function fallbackAdHTML(){
  return '<div class="adPlaceholder" style="height:220px;display:grid;place-items:center"><div style="text-align:center"><div style="font-weight:900;margin-bottom:6px">Ad Placeholder</div><div style="font-size:12px;opacity:.8">AdSense ì„¤ì • í›„ ì‹¤ì œ ê´‘ê³ ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div></div></div>';
}
function showInterstitialAd(){
  const box=document.getElementById('adContainer'); box.innerHTML='';
  const ins=document.createElement('ins');
  ins.className='adsbygoogle'; ins.style.display='block';
  ins.setAttribute('data-ad-client', AD_CLIENT);
  if(AD_SLOT) ins.setAttribute('data-ad-slot', AD_SLOT);
  ins.setAttribute('data-ad-format','auto');
  ins.setAttribute('data-full-width-responsive','true');
  box.appendChild(ins);
  try{ (window.adsbygoogle=window.adsbygoogle||[]).push({}); }
  catch(e){ console.warn(e); box.innerHTML=fallbackAdHTML(); }
  document.getElementById('adModal').style.display='flex';
}
let _afterAd=null;
function showAdThen(fn){ _afterAd = (typeof fn==='function') ? fn : null; showInterstitialAd(); }
document.getElementById('adClose').addEventListener('click',()=>{
  document.getElementById('adModal').style.display='none';
  const f=_afterAd; _afterAd=null; if(f) try{ f(); }catch(e){ console.error(e); }
});

/* ================= Neon FX ================= */
(function(){ const c=document.getElementById('fx'); if(!c) return; const g=c.getContext('2d');
  function fit(){const d=window.devicePixelRatio||1; c.width=innerWidth*d; c.height=innerHeight*d; g.setTransform(d,0,0,d,0,0);} fit(); addEventListener('resize',fit,{passive:true});
  const N=80; const pts=new Array(N).fill(0).map(()=>({x:Math.random()*innerWidth,y:Math.random()*innerHeight*0.9,r:Math.random()*2+0.5,s:Math.random()*0.6+0.2,ph:Math.random()*6.283}));
  function loop(t){ g.clearRect(0,0,c.width,c.height); for(const p of pts){ g.beginPath(); g.arc(p.x,p.y,p.r,0,Math.PI*2); const a=0.3+Math.sin(t*0.002+p.ph)*0.25; g.fillStyle=`rgba(43,123,255,${a})`; g.fill(); p.y+=p.s; if(p.y>innerHeight){p.y=-10; p.x=Math.random()*innerWidth;} } requestAnimationFrame(loop);} requestAnimationFrame(loop);
})();

/* ================= Helpers & Storage ================= */
const $=sel=>document.querySelector(sel);
const DPR=()=> Math.min(2, window.devicePixelRatio||1);
const clamp=(n,a,b)=> Math.max(a, Math.min(b,n));
const fmt=n=> n.toLocaleString('ko-KR');

/* â˜… ë¸Œë¦­ë¸Œë ˆì´ì»¤ ì „ìš© í‚¤(ë‹¤ë¥¸ ê²Œì„ê³¼ ê¸°ë¡ ë¶„ë¦¬) */
const LS_KEYS={plays:'plays_brick',tickets:'tickets_brick',records:'records_brick',best:'best_brick'};

function loadJSON(k,def){try{const v=localStorage.getItem(k); return v? JSON.parse(v): def;}catch{ return def; }}
function saveJSON(k,v){localStorage.setItem(k, JSON.stringify(v));}
function updateTicketUI(){
  const plays= +localStorage.getItem(LS_KEYS.plays)||0;
  const tickets= +localStorage.getItem(LS_KEYS.tickets)||0;
  $('#ticketsAmt').textContent=tickets;
  $('#ticketsCap').textContent=`${plays%10} / 10`;
  $('#ticketsBar').style.width = ((plays%10)/10*100).toFixed(1)+'%';
}
function addPlay(){
  let plays= +localStorage.getItem(LS_KEYS.plays)||0; plays++;
  let tickets= +localStorage.getItem(LS_KEYS.tickets)||0; if(plays%10===0) tickets++;
  localStorage.setItem(LS_KEYS.plays, String(plays));
  localStorage.setItem(LS_KEYS.tickets, String(tickets));
  updateTicketUI();
  /* âœ… 3íšŒ í”Œë ˆì´ë§ˆë‹¤ ê´‘ê³  ë…¸ì¶œ */
  if(plays % 3 === 0){ showInterstitialAd(); }
}
function addRecord(score, points){
  const recs=loadJSON(LS_KEYS.records,[]);
  const now=new Date(); recs.unshift({ts:now.toISOString(), score, points});
  saveJSON(LS_KEYS.records,recs.slice(0,200));
}
function showRecords(){
  const recs=loadJSON(LS_KEYS.records,[]);
  const wrap=$('#recBody');
  wrap.innerHTML = `<table style="width:100%;border-collapse:collapse;font-size:13px">
    <thead><tr><th style='text-align:left;padding:8px;border-bottom:1px solid #314099'>ë‚ ì§œ/ì‹œê°„</th><th style='text-align:right;padding:8px;border-bottom:1px solid #314099'>ì ìˆ˜</th><th style='text-align:right;padding:8px;border-bottom:1px solid #314099'>í¬ì¸íŠ¸</th></tr></thead>
    <tbody>
      ${recs.map(r=>{ const d=new Date(r.ts); const date=d.toLocaleString('ko-KR');
        return `<tr><td style='padding:6px 8px;border-bottom:1px solid #233077'>${date}</td><td style='padding:6px 8px;text-align:right;border-bottom:1px solid #233077'>${fmt(r.score||0)}</td><td style='padding:6px 8px;text-align:right;border-bottom:1px solid #233077'>${fmt(r.points||0)}</td></tr>`}).join('')}
    </tbody>
  </table>`;
  $('#recModal').style.display='flex';
}
$('#recordsBtn').addEventListener('click',showRecords);
$('#recClose').addEventListener('click',()=> $('#recModal').style.display='none');
$('#recModal').addEventListener('click',e=>{ if(e.target.id==='recModal') $('#recModal').style.display='none'; });

/* ================= Wallet API & RG_addReward ì—°ë™ ================= */
/**
 * WALLET API ìŠ¤í™ (Cloudflare Pages Functions ê¸°ì¤€ ì˜ˆì‹œ)
 *
 * 1) GET /api/wallet/me
 *    - ì‘ë‹µ: {
 *        ok: boolean,
 *        wallet?: { coins: number, xp: number, tickets: number }
 *      }
 *
 * 2) POST /api/wallet/reward
 *    - ìš”ì²­ JSON:
 *      {
 *        game: "brick-breaker",
 *        delta: { coins: number, xp: number, tickets: number },
 *        meta:  { score: number, points: number, level: number }
 *      }
 *    - ì‘ë‹µ:
 *      {
 *        ok: boolean,
 *        wallet?: { coins: number, xp: number, tickets: number },
 *        error?: string
 *      }
 */
const WALLET_API_BASE = '/api/wallet';

async function postWalletReward(payload){
  try{
    const res = await fetch(WALLET_API_BASE + '/reward', {
      method: 'POST',
      headers: {
        'Content-Type':'application/json',
        'Accept':'application/json',
        'Cache-Control':'no-store'
      },
      credentials: 'include',
      body: JSON.stringify(payload)
    });
    if(!res.ok){
      console.warn('wallet/reward http error', res.status);
      return null;
    }
    const data = await res.json().catch(()=>null);
    if(!data || !data.ok){
      console.warn('wallet/reward logical error', data);
      return null;
    }
    return data.wallet || null;
  }catch(err){
    console.warn('wallet/reward failed', err);
    return null;
  }
}

/* ê²Œì„ ì„¸ì…˜ ë³´ìƒ â†’ ê¸€ë¡œë²Œ HUD(RG_addReward) + ì„œë²„ ì§€ê°‘ ë™ì‹œ ì—…ë°ì´íŠ¸ */
function applyGlobalRewardAndSyncWallet(gameCode, delta, meta){
  if(!delta) return;
  const coins   = Number(delta.coins)   || 0;
  const xp      = Number(delta.xp)      || 0;
  const tickets = Number(delta.tickets) || 0;
  if(!(coins || xp || tickets)) return;

  // 1) í™ˆ(user-retro-games.html)ì˜ HUDì™€ localStorage ê°±ì‹ 
  try{
    if(typeof window.RG_addReward === 'function'){
      window.RG_addReward({ coins, tickets, xp });
    }
  }catch(e){
    console.warn('RG_addReward error', e);
  }

  // 2) ì„œë²„ ì§€ê°‘ API í˜¸ì¶œ
  postWalletReward({
    game: gameCode,
    delta: { coins, xp, tickets },
    meta: {
      score:  meta && meta.score  || 0,
      points: meta && meta.points || 0,
      level:  meta && meta.level  || 0
    }
  });
}

/* ì ìˆ˜/í¬ì¸íŠ¸ë¥¼ RETRO GAMES ì§€ê°‘ ë³´ìƒìœ¼ë¡œ ë³€í™˜í•˜ëŠ” ê·œì¹™ */
function calcReward(score, points, level){
  const s  = Math.max(0, score|0);
  const p  = Math.max(0, points|0);
  const lv = Math.max(1, level|0);

  // 200ì ë‹¹ 1ì½”ì¸, ë‚œì´ë„ ê³„ìˆ˜ ì†Œí­ ì ìš©
  const diffMult = 1 + ((lv-1) * 0.002);
  const coinsBase = s / 200 * diffMult;
  const coins = Math.floor(coinsBase);

  // í¬ì¸íŠ¸ëŠ” XPë¡œ 1:4 ë¹„ìœ¨, ìƒí•œ 2,000
  const xp = Math.min(2000, p * 4);

  // ë¸Œë¦­ë¸Œë ˆì´ì»¤ëŠ” í‹°ì¼“ì€ ë³„ë„(í”Œë ˆì´ ì¹´ìš´íŠ¸)ì—ì„œ ê´€ë¦¬, ì—¬ê¸°ì„œëŠ” 0
  const tickets = 0;

  return { coins, xp, tickets };
}

/* ================= ë‚œì´ë„ ë°°ìœ¨ ================= */
function difficultyMult(){
  const val=$('#tier')?.value||'beginner';
  return {beginner:1.00, intermediate:1.15, advanced:1.35, hell:1.50, doom:1.60, insane:1.85}[val]||1.0;
}

/* ================= ë¸Œë¦­ë¸Œë ˆì´ì»¤ íŒŒë¼ë¯¸í„° ================= */
let _colsPreset=12;
function paramsForLevel(lv){
  const baseSpeed = 220 + lv*7.5;
  const paddleW = clamp(180 - lv*1.4, 56, 180);
  const rows = lv<8? 5 : lv<15? 6 : lv<25? 7 : lv<35? 8 : lv<50? 9 : 10;
  const cols = _colsPreset;
  const brickHpBase = lv<15? 1 : lv<30? 1.3 : lv<40? 1.6 : lv<50? 2.0 : lv<80? 2.6 : 3.4;
  const powerRate = lv<15? 0.18 : lv<30? 0.14 : lv<50? 0.10 : lv<80? 0.08 : 0.05;
  const chaosEvery = lv>=40? (lv>=80? 6 : 9) : null;
  const unbreakableRate = lv>=100? 0.10 : lv>=80? 0.04 : 0;
  const fallBrickRate = lv>=50? 0.03 : 0;
  const comboWindow = clamp(1.2 - lv*0.004, 0.35, 1.2);
  return {baseSpeed,paddleW,rows,cols,brickHpBase,powerRate,chaosEvery,unbreakableRate,fallBrickRate,comboWindow};
}
const POWER = {EXPAND:'E', SLOW:'S', MULTI:'M', LIFE:'L', DEBUFF:'D', LASER:'R', PIERCE:'P', EXPLODE:'X'};

/* ================= ê°„ë‹¨ SFX ================= */
var SFX=(function(){ let ctx; const ensure=()=> ctx||(ctx=new (window.AudioContext||window.webkitAudioContext)()); function beep(freq=440,dur=0.08,type='square',gain=0.06){ const ac=ensure(); const o=ac.createOscillator(); const g=ac.createGain(); o.type=type; o.frequency.value=freq; g.gain.value=gain; o.connect(g); g.connect(ac.destination); const t=ac.currentTime; o.start(t); o.stop(t+dur); g.gain.setTargetAtTime(0,t+dur*0.6,0.03); } return {hit:()=>beep(680,0.05,'square',0.05), brick:()=>beep(540,0.07,'square',0.05), power:()=>beep(820,0.1,'triangle',0.06), lose:()=>beep(180,0.3,'sawtooth',0.08), laser:()=>beep(1200,0.05,'triangle',0.04)}; })();

/* ================= ê²Œì„ ë³¸ì²´ ================= */
class BrickBreaker{
  constructor(canvas){
    this.c=canvas; this.ctx=canvas.getContext('2d');
    this.best= +(localStorage.getItem(LS_KEYS.best)||0);
    this.level=1; this._resizeRAF=null; this._fitRAF=null;
    this._initResizeObserver();
    this.reset(1);
    this.bind();
    this.resize();
    this.last=0; requestAnimationFrame(t=>this.loop(t));

    /* âœ… ì„œë²„ ì„¸ì…˜ ì‹œì‘ ì•Œë¦¼ (slug ê³ ì •: 'brick-breaker') */
    notifyStart();
  }
  _initResizeObserver(){
    const bezel = this.c.closest('.bezel') || document.body;
    const ro = new ResizeObserver(()=>{ if(this._resizeRAF) cancelAnimationFrame(this._resizeRAF); this._resizeRAF = requestAnimationFrame(()=> this.resize()); });
    ro.observe(bezel); this._ro=ro;
    window.addEventListener('orientationchange', ()=>{ if(this._resizeRAF) cancelAnimationFrame(this._resizeRAF); this._resizeRAF=requestAnimationFrame(()=> this.resize()); }, {passive:true});
  }
  _targetSize(){
    const bezel = this.c.closest?.('.bezel') || this.c.parentElement || document.scrollingElement || document.body;
    let rect;
    try{ rect = (typeof bezel.getBoundingClientRect==='function') ? bezel.getBoundingClientRect() : {width: this.c.clientWidth||640, height: this.c.clientHeight||400}; }
    catch(e){ rect = {width: this.c.clientWidth||640, height: this.c.clientHeight||400}; }
    const availW = Math.max(0, (rect.width||640) - 24);
    const availH = Math.max(0, (rect.height||400) - 24);
    const aspect = 16/10;
    let cssW = Math.min(availW, availH*aspect);
    let cssH = cssW/aspect;
    if(!isFinite(cssW) || cssW<=0){ cssW = 640; cssH = 400; }
    return {cssW:Math.floor(cssW), cssH:Math.floor(cssH)};
  }
  resize(){
    const d=DPR(); const {cssW, cssH} = this._targetSize();
    const styleW = parseInt(this.c.style.width||0,10); const styleH = parseInt(this.c.style.height||0,10);
    if(styleW!==cssW || styleH!==cssH){
      this.c.style.width = cssW+'px'; this.c.style.height = cssH+'px';
      this.c.width = Math.max(10, Math.floor(cssW*d)); this.c.height = Math.max(10, Math.floor(cssH*d));
      if(this.paddle){ this.paddle.y = this.c.height - 28*d; this.paddle.x = clamp(this.paddle.x, this.paddle.w*0.5, this.c.width - this.paddle.w*0.5); }
      if(this.balls){ for(const b of this.balls){ b.x = clamp(b.x, b.r, this.c.width-b.r); b.y = clamp(b.y, b.r, this.c.height-b.r); } }
      this.draw();
    }
    if(this._fitRAF) cancelAnimationFrame(this._fitRAF); this._fitRAF = requestAnimationFrame(()=> fitCabinet());
  }
  bind(){
    const tier=$('#tier'), lvl=$('#lvlRange');
    const applyTier=t=>{ let lv={beginner:1,intermediate:11,advanced:21,hell:40,doom:50,insane:100}[t]||1; lvl.value=lv; this.setLevel(lv); };
    tier.addEventListener('change',()=>applyTier(tier.value));
    lvl.addEventListener('input',()=> this.setLevel(+lvl.value));
    $('#sizeSel').addEventListener('change',e=>{ _colsPreset=+e.target.value||12; this.setLevel(this.level); });
    $('#newBtn').addEventListener('click',()=> this.reset(this.level));
    $('#undoBtn').addEventListener('click',()=>{ this.paused=!this.paused; });

    /* HOME: ê´‘ê³  í›„ ë¡œê·¸ì¸ ìƒíƒœ í™ˆ(user-retro-games.html)ìœ¼ë¡œ ì´ë™ (ì ˆëŒ€ê²½ë¡œ) */
    $('#homeBtn').addEventListener('click',()=> 
      showAdThen(()=> window.location.href = '/user-retro-games.html')
    );

    $('#endBtn').addEventListener('click',()=> showAdThen(()=> this.manualEnd()));

    // í¬ì¸í„° ë§¤í•‘
    const mapX = (clientX)=>{ const r=this.c.getBoundingClientRect(); const scaleX = this.c.width / r.width; return (clientX - r.left) * scaleX; };
    this.c.addEventListener('mousemove',e=>{ this.mouseX=mapX(e.clientX); });
    this.c.addEventListener('touchmove',e=>{ this.mouseX=mapX(e.touches[0].clientX); e.preventDefault(); },{passive:false});

    document.addEventListener('keydown',e=>{
      if(e.code==='KeyN'){ this.reset(this.level); }
      if(e.code==='KeyU' || e.code==='Space'){ this.paused=!this.paused; }
      if(e.code==='Enter'){ this.reset(this.level); }
      if(!this.running||this.paused) return;
      if(e.code==='ArrowLeft'){ this.paddle.x += (this.reverse?-1:1)*-24*DPR(); }
      if(e.code==='ArrowRight'){ this.paddle.x += (this.reverse?-1:1)*24*DPR(); }
    });
  }
  setLevel(lv){ this.reset(lv); }

  /* í¬ì¸íŠ¸ ëª¨ë¸ */
  awardPoints(base){
    const mult = difficultyMult();
    const v = Math.max(0, Math.floor(base * mult));
    this.points = Math.min(5000, (this.points||0) + v);
    this.updateHUD();
  }

  reset(lv){
    const d=DPR();
    this.level=lv||1; this.params=paramsForLevel(this.level);
    this.score=0; this.points=0;
    this.lives=3; this.eventsAcc=0; this.reverse=false;
    this.slowTimer=0; this.expandTimer=0; this.combo=1; this.comboTimer=0;
    this.stageDeaths=0; this.paddleHitStreak=0;
    this.laserTimer=0; this.pierceTimer=0; this.explodeTimer=0;
    this.particles=[]; this.lasers=[]; this.powers=[]; this.balls=[];
    this.running=true; this.paused=false; this._ended=false;
    const _ov=document.getElementById('gameOver'); if(_ov) _ov.style.display='none';
    const W=this.c.width, H=this.c.height;
    this.preset='classic'; this.paddle={x:W*0.5, y:H-28*d, w:this.params.paddleW*d, h:12*d};
    this.makeLevel(); this.spawnBall(); this.updateHUD(); this.draw();
  }

  manualEnd(){
    if(this._ended) return;
    this._ended=true; this.running=false; this.paused=false;
    addRecord(this.score, this.points||0);
    addPlay();
    document.getElementById('gameOver').style.display='flex';
    /* âœ… ì„œë²„ ì„¸ì…˜ ì¢…ë£Œ(ìµœì¢… ì ìˆ˜ ë³´ê³ ) */
    notifyFinish(this.score|0);

    /* âœ… ì„¸ì…˜ ì¢…ë£Œ ì‹œ RETRO GAMES ì§€ê°‘/í™ˆ HUDì— ë³´ìƒ ë°˜ì˜ */
    try{
      const delta = calcReward(this.score||0, this.points||0, this.level||1);
      applyGlobalRewardAndSyncWallet('brick-breaker', delta, {
        score:  this.score||0,
        points: this.points||0,
        level:  this.level||1
      });
    }catch(e){
      console.error('reward sync error', e);
    }
  }

  updateHUD(){
    $('#score').textContent=this.score|0;
    if(this.score>this.best){ this.best=this.score|0; localStorage.setItem(LS_KEYS.best, String(this.best)); }
    $('#best').textContent=this.best|0;
    $('#moves').textContent=(Math.max(0,this.level-1))|0;
    $('#pointsAmt').textContent=fmt(this.points|0);
    const cap=5000; $('#pointsBar').style.width=Math.min(100,(this.points/cap*100)).toFixed(1)+'%';
    updateTicketUI();
  }

  spawnBall(px){
    const speed=this.params.baseSpeed*DPR();
    const angle = -Math.PI/3 + (Math.random()*Math.PI/6);
    const x = px|| this.paddle.x; const y = this.paddle.y - 12*DPR();
    this.balls.push({x,y,r:6*DPR(), vx: Math.cos(angle)*speed, vy: Math.sin(angle)*speed, pierce:false, explode:false});
  }

  makeLevel(){
    const p=this.params; const rows=p.rows, cols=p.cols, brickHpBase=p.brickHpBase, unbreakableRate=p.unbreakableRate;
    const pad=16*DPR(); const W=this.c.width- pad*2; const bw=W/cols; const bh=20*DPR();
    this.bricks=[];
    for(let r=0;r<rows;r++){
      for(let c=0;c<cols;c++){
        let hp=Math.max(1, Math.round(brickHpBase + (Math.random()*0.8-0.4)));
        let steel=Math.random()<unbreakableRate;
        const x=pad+c*bw+2, y=pad+r*(bh+4), w=bw-4, h=bh;
        this.bricks.push({x,y,w,h,hp: steel?9999:hp, steel});
      }
    }
  }

  addPower(x,y){
    const r=Math.random(); let kind=POWER.EXPAND;
    if(r<0.18) kind=POWER.EXPAND;
    else if(r<0.34) kind=POWER.SLOW;
    else if(r<0.48) kind=POWER.MULTI;
    else if(r<0.6) kind=POWER.LIFE;
    else if(r<0.72) kind=POWER.PIERCE;
    else if(r<0.84) kind=POWER.EXPLODE;
    else if(r<0.94) kind=POWER.LASER;
    else kind=POWER.DEBUFF;
    this.powers.push({x,y,vy:60*DPR(),kind});
  }
  applyPower(kind){
    SFX.power();
    if(kind===POWER.EXPAND){ this.expandTimer=8; this.paddle.w *= 1.35; }
    if(kind===POWER.SLOW){ this.slowTimer=6; this.balls.forEach(b=>{ b.vx*=0.7; b.vy*=0.7; }); }
    if(kind===POWER.MULTI){
      const extra=Math.min(3, 1+Math.floor(this.level/30));
      const clones=[];
      for(let i=0;i<extra;i++){
        const b=this.balls[i%this.balls.length]; if(!b) break;
        const nb={x:b.x,y:b.y,r:b.r,vx:b.vx,vy:b.vy,pierce:b.pierce,explode:b.explode};
        const ang=(-0.6 + i*(1.2/Math.max(1,extra-1))); const sp=Math.hypot(nb.vx,nb.vy);
        nb.vx=Math.cos(ang)*sp; nb.vy=Math.sin(ang)*sp; clones.push(nb);
      }
      this.balls.push(...clones);
    }
    if(kind===POWER.LIFE){ this.lives++; }
    if(kind===POWER.DEBUFF){ if(Math.random()<0.5){ this.paddle.w*=0.75; } else { this.balls.forEach(b=>{ b.vx*=1.2; b.vy*=1.2; }); } }
    if(kind===POWER.LASER){ this.laserTimer=6; }
    if(kind===POWER.PIERCE){ this.pierceTimer=8; this.balls.forEach(b=> b.pierce=true); }
    if(kind===POWER.EXPLODE){ this.explodeTimer=8; this.balls.forEach(b=> b.explode=true); }
  }

  chaosEvent(){ const r=Math.random(); if(r<0.33){ this.reverse=true; setTimeout(()=> this.reverse=false, 4000); } else if(r<0.66){ this.balls.forEach(b=>{ b.vx*=1.25; b.vy*=1.25; }); setTimeout(()=> this.balls.forEach(b=>{ b.vx*=0.8; b.vy*=0.8; }), 3000); } }

  ballBrickCollision(b, br){
    const nx=clamp(b.x, br.x, br.x+br.w); const ny=clamp(b.y, br.y, br.y+br.h);
    const dx=b.x-nx, dy=b.y-ny;
    if(dx*dx+dy*dy <= b.r*b.r){
      if(!b.pierce){ if(Math.abs(dx)>Math.abs(dy)) b.vx*=-1; else b.vy*=-1; }
      if(!br.steel){
        br.hp--;
        this.score += 10*this.combo;
        if(br.hp<=0){
          br.remove=true;
          this.awardPoints(3); // ë¸”ë¡ íŒŒê´´ ë³´ìƒ
          if(Math.random()<this.params.powerRate) this.addPower(br.x+br.w/2, br.y+br.h/2);
        }
      }
      if(b.explode){ this.explode(br.x+br.w/2, br.y+br.h/2, 48*DPR()); }
      this.combo++; this.comboTimer=this.params.comboWindow;
      SFX.brick(); return true;
    }
    return false;
  }

  explode(cx,cy,r){
    for(const br of this.bricks){
      if(br.remove||br.steel) continue;
      const bx=clamp(cx, br.x, br.x+br.w); const by=clamp(cy, br.y, br.y+br.h);
      const dx=cx-bx, dy=cy-by;
      if(dx*dx+dy*dy < r*r){
        br.hp-=2; if(br.hp<=0){ br.remove=true; this.awardPoints(3); }
        this.score+=5;
      }
    }
  }

  fireLaser(){ if(this.laserTimer<=0) return; SFX.laser(); this.lasers.push({x:this.paddle.x, y:this.paddle.y-6*DPR(), vy:-480*DPR()}); }

  tick(dt){
    if(!this.running||this.paused) return;
    const W=this.c.width, H=this.c.height;
    if(this.mouseX!=null){ this.paddle.x = clamp(this.mouseX, this.paddle.w*0.5, W-this.paddle.w*0.5); }

    if(this.expandTimer>0){ this.expandTimer-=dt; if(this.expandTimer<=0) this.paddle.w/=1.35; }
    if(this.slowTimer>0){ this.slowTimer-=dt; }
    if(this.laserTimer>0){ this.laserTimer-=dt; this.fireLaser(); }
    if(this.pierceTimer>0){ this.pierceTimer-=dt; if(this.pierceTimer<=0) this.balls.forEach(b=> b.pierce=false); }
    if(this.explodeTimer>0){ this.explodeTimer-=dt; if(this.explodeTimer<=0) this.balls.forEach(b=> b.explode=false); }
    if(this.params.chaosEvery){ this.eventsAcc+=dt; if(this.eventsAcc>=this.params.chaosEvery){ this.eventsAcc=0; this.chaosEvent(); } }
    if(this.comboTimer>0){ this.comboTimer-=dt; if(this.comboTimer<=0) this.combo=1; }

    // lasers
    for(let i=this.lasers.length-1;i>=0;i--){
      const L=this.lasers[i]; L.y += L.vy*dt;
      for(const br of this.bricks){
        if(br.remove||br.steel) continue;
        if(L.y<br.y+br.h && L.y>br.y && Math.abs(L.x-(br.x+br.w/2))<br.w/2){
          br.hp-=2; this.score+=4; if(br.hp<=0){ br.remove=true; this.awardPoints(3); }
        }
      }
      if(L.y<0) this.lasers.splice(i,1);
    }

    // powers
    for(let i=0;i<this.powers.length;i++){ this.powers[i].y += this.powers[i].vy*dt; }
    for(let i=this.powers.length-1;i>=0;i--){
      const p=this.powers[i];
      if(p.y>this.paddle.y-10 && Math.abs(p.x-this.paddle.x)<this.paddle.w*0.5){ this.applyPower(p.kind); this.powers.splice(i,1);}
      else if(p.y>H+20) this.powers.splice(i,1);
    }

    // balls
    for(let i=this.balls.length-1;i>=0;i--){
      const b=this.balls[i]; b.x += b.vx*dt; b.y += b.vy*dt;
      if(b.x<b.r){ b.x=b.r; b.vx*=-1; SFX.hit(); }
      if(b.x>W-b.r){ b.x=W-b.r; b.vx*=-1; SFX.hit(); }
      if(b.y<b.r){ b.y=b.r; b.vy*=-1; SFX.hit(); }
      if(b.y>H+20){ this.balls.splice(i,1); continue; }

      // íŒ¨ë“¤ ì¶©ëŒ
      if(b.y+b.r>=this.paddle.y && Math.abs(b.x - this.paddle.x) <= this.paddle.w*0.5 && b.vy>0){
        b.y=this.paddle.y - b.r;
        const hitRatio = (b.x - this.paddle.x)/(this.paddle.w*0.5);
        const speed = Math.hypot(b.vx,b.vy)*(this.slowTimer>0?0.9:1.02);
        const angle = (-Math.PI/3) + hitRatio*(Math.PI/2.2);
        b.vx = Math.cos(angle)*speed; b.vy = Math.sin(angle)*speed;
        SFX.hit();

        // ì½¤ë³´: ì—°ì† íŒ¨ë“¤ ë°˜ì‚¬ 20íšŒë§ˆë‹¤ +20P
        this.paddleHitStreak++;
        if(this.paddleHitStreak>0 && this.paddleHitStreak%20===0){ this.awardPoints(20); }
      }
    }

    // ê³µ ì†Œì§„
    if(this.balls.length===0){
      this.lives--; this.stageDeaths++; this.paddleHitStreak=0;
      SFX.lose();
      if(this.lives<=0) return this.gameOver();
      this.spawnBall();
    }

    // ë²½ëŒ ì¶©ëŒ/ì •ë¦¬
    for(const br of this.bricks){ if(br.remove) continue; for(const b of this.balls){ this.ballBrickCollision(b, br); } }
    this.bricks = this.bricks.filter(b=> !b.remove);

    // ìŠ¤í…Œì´ì§€ í´ë¦¬ì–´
    if(this.bricks.length===0){
      this.awardPoints(80);                // í´ë¦¬ì–´ ë³´ë„ˆìŠ¤
      if(this.stageDeaths===0){ this.awardPoints(30); } // ë…¸ë°ë¯¸ì§€ ë³´ë„ˆìŠ¤
      this.level = Math.min(100, this.level+1);
      this.params=paramsForLevel(this.level);
      this.makeLevel(); this.spawnBall();
      this.stageDeaths=0; this.paddleHitStreak=0;
    }

    this.updateHUD();
  }

  gameOver(){
    if(this._ended) return;
    this._ended=true; this.running=false; this.paused=false;
    if(this.score>this.best){ this.best=this.score|0; localStorage.setItem(LS_KEYS.best, String(this.best)); }
    addRecord(this.score, this.points||0); addPlay();
    document.getElementById('gameOver').style.display='flex';
    /* âœ… ì„œë²„ ì„¸ì…˜ ì¢…ë£Œ(ìµœì¢… ì ìˆ˜ ë³´ê³ ) */
    notifyFinish(this.score|0);

    /* âœ… ì„¸ì…˜ ì¢…ë£Œ ì‹œ RETRO GAMES ì§€ê°‘/í™ˆ HUDì— ë³´ìƒ ë°˜ì˜ */
    try{
      const delta = calcReward(this.score||0, this.points||0, this.level||1);
      applyGlobalRewardAndSyncWallet('brick-breaker', delta, {
        score:  this.score||0,
        points: this.points||0,
        level:  this.level||1
      });
    }catch(e){
      console.error('reward sync error', e);
    }
  }

  draw(){
    const ctx=this.ctx; const d=DPR();
    ctx.clearRect(0,0,this.c.width,this.c.height);
    const g=ctx.createLinearGradient(0,0,0,this.c.height); g.addColorStop(0,'#0b1440'); g.addColorStop(1,'#070c22'); ctx.fillStyle=g; ctx.fillRect(0,0,this.c.width,this.c.height);
    ctx.save(); ctx.globalAlpha=0.18; ctx.fillStyle='#cfd6ff';
    for(let i=0;i<70;i++){ const x=(i*97)%this.c.width; const y=(i*53)%this.c.height*0.6; ctx.fillRect((x+this.level*3)%this.c.width,y,1*d,1*d); }
    ctx.restore();

    // ë ˆì´ì €
    ctx.strokeStyle='#7ad7ff'; ctx.lineWidth=2*d;
    for(const L of this.lasers){ ctx.beginPath(); ctx.moveTo(L.x,L.y); ctx.lineTo(L.x, L.y-20*d); ctx.stroke(); }

    // íŒ¨ë“¤
    ctx.fillStyle='#8ea3ff'; const px=this.paddle.x-this.paddle.w*0.5, py=this.paddle.y; ctx.fillRect(px,py,this.paddle.w,this.paddle.h);

    // ë³¼
    for(const ball of this.balls){
      const gr=ctx.createRadialGradient(ball.x-2*d,ball.y-2*d,1,ball.x,ball.y,ball.r);
      gr.addColorStop(0,'#fff'); gr.addColorStop(1, ball.pierce?'#88ffd8': ball.explode?'#ff9aa6':'#ffd36b');
      ctx.fillStyle=gr; ctx.beginPath(); ctx.arc(ball.x,ball.y,ball.r,0,Math.PI*2); ctx.fill();
    }

    // ë²½ëŒ
    for(const br of this.bricks){
      ctx.fillStyle= br.steel? '#556' : (br.hp>=3?'#ff6b6b': br.hp===2? '#ffd166':'#70ffa8');
      ctx.fillRect(br.x,br.y,br.w,br.h); ctx.strokeStyle='#0005'; ctx.strokeRect(br.x,br.y,br.w,br.h);
    }

    // íŒŒì›Œì—…
    for(const p of this.powers){
      ctx.fillStyle= p.kind==='D'? '#ff6b6b': p.kind==='R'? '#7ad7ff': p.kind==='P'? '#88ffd8': p.kind==='X'? '#ff9aa6':'#70ffa8';
      ctx.fillRect(p.x-10*d,p.y-10*d,20*d,20*d);
      ctx.fillStyle='#001'; ctx.font=(12*d)+'px ui-sans-serif'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(p.kind,p.x,p.y+1);
    }

    // CRT ìŠ¤ìº”ë¼ì¸
    ctx.globalAlpha=0.12; ctx.fillStyle='#000'; for(let sy=0;sy<this.c.height;sy+=2*d){ ctx.fillRect(0,sy,this.c.width,1*d); } ctx.globalAlpha=1;
  }

  loop(ts){
    const dt=(ts-(this.last||ts))/1000; this.last=ts;
    if(this.running && !this.paused){ this.tick(Math.min(dt,0.033)); this.draw(); } else { this.draw(); }
    requestAnimationFrame(t=>this.loop(t));
  }
}

/* ================= Cabinet fit ================= */
function fitCabinet(){
  const cab = document.querySelector('.cabinet'); if(!cab) return;
  const margin = 16; cab.style.transform='none';
  const w=cab.offsetWidth, h=cab.offsetHeight;
  const vw=window.innerWidth, vh=window.innerHeight;
  const needScale = (w > vw - margin*2) || (h > vh - margin*2);
  const scale = needScale ? Math.min(1, (vw - margin*2)/w, (vh - margin*2)/h) : 1;
  cab.style.transform = `scale(${scale})`;
}
window.addEventListener('resize', ()=> requestAnimationFrame(fitCabinet), {passive:true});
window.addEventListener('orientationchange', ()=> requestAnimationFrame(fitCabinet), {passive:true});
setTimeout(fitCabinet, 0);

/* ================= ì„œë²„ ì„¸ì…˜ ì—°ë™ (ì•ˆì „ ë˜í¼) =================
   - assets/js/app.js ë‚´ë¶€ì—ì„œ window.gameStart / window.gameFinish ë¥¼ export í•˜ì§€ ì•ŠëŠ” ê²½ìš°ë„
     ìˆìœ¼ë¯€ë¡œ, ì¡´ì¬ ì—¬ë¶€ë¥¼ ê²€ì‚¬í•´ì„œ ì¡°ìš©íˆ ë™ì‘í•˜ë„ë¡ ì²˜ë¦¬í•©ë‹ˆë‹¤. */
function notifyStart(){ try{ if (typeof window.gameStart === 'function') window.gameStart('brick-breaker'); }catch(e){} }
function notifyFinish(finalScore){ try{ if (typeof window.gameFinish === 'function') window.gameFinish('brick-breaker', finalScore|0); }catch(e){} }

/* ê°€ì‹œì„± ì´ë²¤íŠ¸ í›… (í•„ìš” ì‹œ ì¼ì‹œì •ì§€/ë¡œê¹… ì²˜ë¦¬) */
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    // ì˜ˆ: this.paused = true; ë“± (í˜„ì¬ëŠ” ë””ìì¸/ë™ì‘ ë³´ì¡´ ìœ„í•´ í‘œì‹œë§Œ)
  }
});

/* ================= Sanity Tests ================= */
(function runTests(){
  const p1=paramsForLevel(1), p40=paramsForLevel(40), p100=paramsForLevel(100);
  console.assert(p40.baseSpeed>p1.baseSpeed, 'speed increases');
  console.assert(p40.paddleW<=p1.paddleW, 'paddle width non-increasing');
  console.assert(p100.unbreakableRate>=p40.unbreakableRate, 'steel rate monotonic');
  // _targetSize ì•ˆì „ì„±
  const cv=document.createElement('canvas'); cv.width=640; cv.height=400; const g=new BrickBreaker(cv); let ok=true; try{ const s=g._targetSize(); ok = Number.isFinite(s.cssW)&&Number.isFinite(s.cssH); }catch(e){ ok=false; } console.assert(ok, '_targetSize finite');
})();

/* ================= Bootstrap ================= */
const game=new BrickBreaker(document.getElementById('game'));
(function initUI(){
  const tier=$('#tier'), lvl=$('#lvlRange');
  const applyTier=t=>{ let lv={beginner:1,intermediate:11,advanced:21,hell:40,doom:50,insane:100}[t]||1; lvl.value=lv; game.setLevel(lv); };
  applyTier(tier.value);
  lvl.addEventListener('input',()=> game.setLevel(+lvl.value));
  updateTicketUI();
})();
</script>


  <div id="cookieBanner" class="cookie-banner" role="dialog" aria-live="polite" aria-label="Analytics consent">
    <div>ì„œë¹„ìŠ¤ í’ˆì§ˆ í–¥ìƒì„ ìœ„í•œ ë¶„ì„(ì¿ í‚¤) ì‚¬ìš©ì— ë™ì˜í•˜ì‹œë‚˜ìš”?</div>
    <div class="spacer"></div>
    <button class="deny" type="button">ê±°ë¶€</button>
    <button class="agree" type="button">ë™ì˜</button>
  </div>


  <script>
  (function(){
    try{
      var KEY='rg_analytics_consent';
      function init(){ if(typeof window.analyticsInit==='function') window.analyticsInit(); }
      var v=null; try{ v=localStorage.getItem(KEY); }catch(e){}
      var el=document.getElementById('cookieBanner');
      if(v==='yes'){ init(); if(el) el.style.display='none'; return; }
      if(!el){ return; } // no banner -> do not init
      el.style.display='flex';
      var agree=el.querySelector('.agree'), deny=el.querySelector('.deny');
      if(agree) agree.addEventListener('click', function(){
        try{ localStorage.setItem(KEY,'yes'); }catch(e){}
        el.style.display='none'; init();
      });
      if(deny) deny.addEventListener('click', function(){
        try{ localStorage.setItem(KEY,'no'); }catch(e){}
        el.style.display='none';
      });
    }catch(e){ /* no-op */ }
  })();
  </script>

  <div id="site-footer"></div>
</body>
</html>
