<!DOCTYPE html>
<html lang="ko" data-env="prod">
<head>
  <!--#include file="/partials/head-seo.html" -->

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RETRO GAMES â€“ Shop</title>

  <!-- âœ… Google AdSense (ì„¸ë¡œí˜• ë°°ë„ˆ ê³µí†µ ì½”ë“œ) -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6713974265397310"
    crossorigin="anonymous"></script>

  <style>
    :root{--gold1:#ffdf6e;--gold2:#ffb84d;--blue1:#2b7bff;--blue2:#0048ff;--bg:#0b001e;--gapY:24px}
    *{box-sizing:border-box}
    html,body{
      height:100%;
      margin:0;
      background:radial-gradient(circle at 40% -10%,#320076,#0b001e 70%);
      font-family:'Segoe UI',system-ui,Apple SD Gothic Neo,sans-serif;
      color:#fff
    }
    .wrap{min-height:100%;display:grid;grid-template-rows:auto 1fr auto}

    /* Header */
    header{position:relative;text-align:center;padding:22px 12px}
    .title{font-size:36px;font-weight:900;letter-spacing:.5px;color:var(--gold1);text-shadow:0 0 18px var(--gold2)}
    .subtitle{opacity:.9;margin:0;text-align:center;margin-bottom:6px}

    /* ì¢Œì¸¡ HUD (íƒ€ì´í‹€ ë†’ì´ ì •ë ¬) */
    .hudTop{
      position:absolute;left:40px;top:50%;transform:translateY(-50%);
      display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:flex-start;max-width:48vw;
    }
    .pill{
      display:flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:16px;
      background:linear-gradient(180deg,#0c1430,#0a0f26);
      border:1px solid #3857bd;
      box-shadow:0 6px 16px #0008,inset 0 0 18px #102265;
      white-space:nowrap
    }
    .pill .icon{
      width:22px;height:22px;display:grid;place-items:center;
      border-radius:50%;
      background:radial-gradient(circle at 30% 30%,#8bb3ff,#3a7bff);
      box-shadow:0 0 10px #6fb0ffaa
    }
    .amount{font-size:18px;color:#ffe9a3;text-shadow:0 0 8px #ffd86a}
    .unit{opacity:.8;margin-left:2px;font-size:12px}
    .label{font-weight:900;letter-spacing:.3px}

    /* ìš°ì¸¡ ì•¡ì…˜ */
    .actions{
      position:absolute;right:40px;top:50%;transform:translateY(-50%);
      display:flex;gap:10px
    }
    .btn-top{
      padding:8px 14px;border-radius:12px;
      border:1px solid #3e2b7b;
      background:linear-gradient(180deg,#1a2b7a,#0a1a64);
      font-weight:900;color:#e9f0ff;
      box-shadow:0 6px 12px #0006;
      cursor:pointer
    }
    .btn-top.alt{
      background:linear-gradient(180deg,var(--gold1),var(--gold2));
      color:#3a2400
    }

    .divider{
      height:4px;width:100%;
      background:linear-gradient(90deg,transparent,rgba(0,136,255,.8),transparent);
      filter:blur(1px);
      box-shadow:0 0 18px #0088ff88;
      margin:0
    }

    /* Main content */
    main{max-width:1100px;margin:0 auto;padding:18px 22px 28px}
    .shopHeader{
      display:flex;align-items:center;justify-content:space-between;
      gap:12px;margin:4px 0 14px
    }
    .shopHeader h2{margin:0;font-size:22px;color:var(--gold1);text-shadow:0 0 10px #ffd991}
    .hint{opacity:.85}

    /* â–¶ í•­ìƒ ê°€ë¡œ 3ê°œ(ë„“ì€ í™”ë©´ ê¸°ì¤€) */
    .grid{
      display:grid;
      grid-template-columns:repeat(3, minmax(0,1fr));
      gap:14px
    }
    @media (max-width:960px){
      .grid{grid-template-columns:repeat(2, minmax(0,1fr))}
    }
    @media (max-width:560px){
      .grid{grid-template-columns:minmax(0,1fr)}
    }

    .card{
      background:linear-gradient(180deg,#0a0030,#000);
      border:2px solid #3e2b7b;border-radius:16px;
      box-shadow:0 0 20px #0008,inset 0 0 16px #2a0085;
      padding:12px;
      display:grid;grid-template-rows:auto auto 1fr auto;gap:8px;
    }
    .card h3{margin:0;font-size:16px;color:#ffdf6e;text-shadow:0 0 8px #ffd580}
    .desc{opacity:.9;font-size:12px}
    .badgeRow{display:flex;gap:8px;flex-wrap:wrap}
    .price{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 8px;border-radius:12px;
      border:1px solid #2d3690;
      background:linear-gradient(180deg,#1a2b7a,#0a1a64);
      box-shadow:0 6px 12px #0006;
      font-weight:800;font-size:12px
    }
    .price .k{opacity:.8}
    .active{font-size:12px;color:#9efff3}
    .actOK{color:#8aff98}
    .buyRow{display:flex;gap:8px}
    .buy{
      flex:1;padding:10px 12px;border-radius:12px;
      border:1px solid #2d3690;
      background:linear-gradient(180deg,#1a2b7a,#0a1a64);
      font-weight:800;color:#e9f0ff;
      cursor:pointer
    }
    .buy.alt{
      background:linear-gradient(180deg,#ffd86e,#ffb84d);
      color:#3a2400;border-color:#a86b00
    }

    footer{
      padding:12px 16px;text-align:center;
      color:#aab;opacity:.9;font-size:12px;
      margin-top:var(--gapY)
    }
    #fx{position:fixed;inset:0;pointer-events:none;opacity:.5}

    /* Toast */
    .toast{
      position:fixed;left:50%;bottom:24px;
      transform:translateX(-50%);
      background:#04102a;border:1px solid #3857bd;
      border-radius:12px;padding:10px 14px;
      box-shadow:0 10px 18px #0008,inset 0 0 18px #102265;
      display:none;z-index:1000
    }
    .toast.show{display:block;animation:fade 2.2s ease}
    @keyframes fade{
      0%{opacity:0;transform:translate(-50%,20px)}
      10%,90%{opacity:1;transform:translate(-50%,0)}
      100%{opacity:0;transform:translate(-50%,20px)}
    }

    /* Responsive header paddings */
    @media (max-width:1200px){
      .hudTop{left:16px}
      .actions{right:16px}
    }

    .cookie-banner{
      position:fixed;left:12px;right:12px;bottom:12px;
      display:none;align-items:center;gap:10px;
      padding:10px 12px;border-radius:12px;
      border:1px solid #2b3f8f;
      background:linear-gradient(180deg,#0b1f40,#0a1730);
      box-shadow:0 10px 18px rgba(0,0,0,.45),inset 0 0 18px rgba(255,255,255,.05);
      z-index:10000;font-size:12px
    }
    .cookie-banner .spacer{flex:1}
    .cookie-banner button{
      padding:8px 12px;border-radius:10px;
      border:1px solid #2d3690;
      background:linear-gradient(180deg,#1a2b7a,#0a1a64);
      font-weight:800;color:#e9f0ff;cursor:pointer
    }
    .cookie-banner .agree{
      background:linear-gradient(180deg,#ffdf6e,#ffb84d);
      color:#3a2400;border-color:#7a5600
    }

    /* âœ… ì¢Œ/ìš° ì„¸ë¡œí˜• ê´‘ê³  ë°°ë„ˆ */
    .sideAd{
      position:fixed;
      top:50%;transform:translateY(-50%);
      width:160px;height:600px;
      display:flex;align-items:center;justify-content:center;
      z-index:5000;pointer-events:auto;
    }
    .sideAd-inner{
      width:100%;height:100%;
      border-radius:18px;border:1px solid #3250c2;
      background:linear-gradient(180deg,#0b1640,#12296f 40%,#1b3ea0 80%,#233fd0);
      box-shadow:0 8px 20px rgba(0,0,0,.65),0 0 22px rgba(40,120,255,.55);
      box-sizing:border-box;
      display:flex;align-items:center;justify-content:center;
      overflow:hidden;
    }
    .sideAd-left{left:8px}
    .sideAd-right{right:8px}
    /* ì¢ì€ í™”ë©´ì—ì„œëŠ” ì„¸ë¡œ ë°°ë„ˆ ìˆ¨ê¹€ ì²˜ë¦¬ */
    @media (max-width:1280px){
      .sideAd{display:none;}
    }
  </style>

</head>

<!-- ì „ì—­ API(ì„¸ì…˜/ê°€ë“œ/í”„ë¡œí•„ ë“±)ë¥¼ ì œê³µ -->
<script defer src="assets/js/app.js"></script>
<script defer src="assets/js/analytics.js"></script>

<body>
  <!--#include file="/partials/header.html" -->
  <canvas id="fx"></canvas>

  <!-- âœ… ì¢Œì¸¡ ì„¸ë¡œí˜• ê´‘ê³  ë°°ë„ˆ -->
  <div class="sideAd sideAd-left" aria-label="ê´‘ê³  ë°°ë„ˆ(ì¢Œì¸¡)">
    <div class="sideAd-inner">
      <ins class="adsbygoogle"
           style="display:block;width:100%;height:100%;"
           data-ad-client="ca-pub-6713974265397310"
           data-ad-slot=""
           data-ad-format="auto"
           data-full-width-responsive="false"></ins>
      <script>
        try{
          (adsbygoogle = window.adsbygoogle || []).push({});
        }catch(e){
          console.warn("AdSense left vertical render error:", e);
        }
      </script>
    </div>
  </div>

  <!-- âœ… ìš°ì¸¡ ì„¸ë¡œí˜• ê´‘ê³  ë°°ë„ˆ -->
  <div class="sideAd sideAd-right" aria-label="ê´‘ê³  ë°°ë„ˆ(ìš°ì¸¡)">
    <div class="sideAd-inner">
      <ins class="adsbygoogle"
           style="display:block;width:100%;height:100%;"
           data-ad-client="ca-pub-6713974265397310"
           data-ad-slot=""
           data-ad-format="auto"
           data-full-width-responsive="false"></ins>
      <script>
        try{
          (adsbygoogle = window.adsbygoogle || []).push({});
        }catch(e){
          console.warn("AdSense right vertical render error:", e);
        }
      </script>
    </div>
  </div>

  <div class="wrap">
    <header>
      <!-- ì¢Œì¸¡ HUD -->
      <div class="hudTop" aria-label="ë³´ìƒ í˜„í™©">
        <div class="pill">
          <div class="icon">ğŸª™</div>
          <div id="coinVal" class="amount">0</div>
          <div class="unit">COINS</div>
        </div>
        <div class="pill">
          <div class="icon">ğŸŸï¸</div>
          <div id="ticketVal" class="amount">0</div>
          <div class="unit">TICKETS</div>
        </div>
        <div class="pill">
          <div class="icon">ğŸ†</div>
          <div id="xpVal" class="amount">0</div>
          <div class="unit">XP</div>
        </div>
      </div>

      <div class="title">ğŸ® RETRO GAMES</div>
      <div class="subtitle">SHOP</div>

      <!-- ìš°ì¸¡: í™ˆìœ¼ë¡œ -->
      <div class="actions">
        <button class="btn-top" onclick="goHome()">í™ˆìœ¼ë¡œ</button>
      </div>
    </header>
    <div class="divider"></div>

    <main>
      <div class="shopHeader">
        <h2>ğŸ›ï¸ ìƒì </h2>
        <div class="hint">êµ¬ë§¤ ì¦‰ì‹œ ì ìš© Â· ì‹œê°„ì´ ìˆëŠ” ìƒí’ˆì€ ì”ì—¬ ì‹œê°„ì´ ëˆ„ì ë©ë‹ˆë‹¤</div>
      </div>

      <section id="shopGrid" class="grid"><!-- JSë¡œ ë Œë”ë§ --></section>
    </main>

    <div class="divider"></div>
    <footer>Â©2025 ì§„ë¹„ì¦ˆ ë§¤ë‹ˆì§€ë¨¼íŠ¸ â”ƒ ê´‘ê³ ë¬¸ì˜ jinbizman@gmail.com â”ƒ RETRO GAMES Â· Neon UI â”ƒ MADE BY ONLY OPEN AI</footer>
  </div>

<script>
  /* ========= 0) ê³µí†µ ê²½ë¡œ & í™ˆ ì´ë™ ========= */
  const BASE = "/";

  // âœ… í™ˆ ë²„íŠ¼: ë¡œê·¸ì¸ ì—¬ë¶€ í™•ì¸ í›„, ë¡œê·¸ì¸í•œ ê³„ì • ê¸°ì¤€ ë©”ì¸ í—ˆë¸Œë¡œ ì´ë™
  async function goHome(){
    try{
      // 1) RG ì„¸ì…˜ ê¸°ë°˜ìœ¼ë¡œ ë¡œê·¸ì¸ ìƒíƒœ ìš°ì„  í™•ì¸
      if (window.RG && typeof window.RG.getSession === "function"){
        const session = await window.RG.getSession({ refresh: true }).catch(()=>null);
        if (session && session.user){
          // ì´ë¯¸ ë¡œê·¸ì¸ ìƒíƒœ â†’ ë¡œê·¸ì¸ í›„ ë©”ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™
          window.location.href = BASE + "user-retro-games.html";
          return;
        }
      }
    }catch(e){
      console.warn("[SHOP] getSession error:", e);
    }

    // 2) ë¡œê·¸ì¸ ì•ˆ ë˜ì–´ ìˆìœ¼ë©´, ë¡œê·¸ì¸ í›„ ë©”ì¸ í—ˆë¸Œë¡œ ëŒì•„ì˜¤ë„ë¡ next íŒŒë¼ë¯¸í„° ë¶€ì—¬
    try{
      const next = encodeURIComponent(BASE + "user-retro-games.html");
      window.location.href = BASE + "login.html?next=" + next;
    }catch(e){
      window.location.href = BASE + "login.html";
    }
  }

  /* ========= 1) ì„œë²„ ì—°ë™ ìœ í‹¸ ========= */
  async function jfetch(url, init){
    try{
      const res = await fetch(url, {
        credentials:'include',
        headers:{'Content-Type':'application/json'},
        ...init
      });
      const data = await res.json().catch(()=>null);
      if(!res.ok){
        throw Object.assign(
          new Error((data && (data.error||data.message)) || `HTTP_${res.status}`),
          {status:res.status, body:data}
        );
      }
      return data;
    }catch(e){
      return Promise.reject(e);
    }
  }

  const API = {
    list: async () => jfetch('/specials/shop'),
    buyByItemId: async (itemId, qty=1) =>
      jfetch('/specials/shop/buy', {
        method:'POST',
        body: JSON.stringify({ itemId, qty })
      }),
  };

  /* ========= 2) HUD ìƒíƒœ (ì„œë²„ ìš°ì„ , ì‹¤íŒ¨ ì‹œ ë¡œì»¬ í´ë°±) ========= */
  const NUM = n => Number.isFinite(+n) ? +n : 0;

  function readTotals(){
    return {
      coins:   NUM(localStorage.getItem('rg_coins')   || 0),
      tickets: NUM(localStorage.getItem('rg_tickets') || 0),
      xp:      NUM(localStorage.getItem('rg_xp')      || 0),
      xpCap:   NUM(localStorage.getItem('rg_xp_cap')  || 20000),
      adsUntil:   NUM(localStorage.getItem('rg_ads_until')   || 0),
      xpUntil:    NUM(localStorage.getItem('rg_boost_xp_until') || 0),
      coinUntil:  NUM(localStorage.getItem('rg_boost_coin_until') || 0),
      luckyUntil: NUM(localStorage.getItem('rg_lucky_until') || 0),
      retryTokens:NUM(localStorage.getItem('rg_retry_tokens') || 0),
    };
  }

  function writeTotals(t){
    localStorage.setItem('rg_coins',   t.coins);
    localStorage.setItem('rg_tickets', t.tickets);
    localStorage.setItem('rg_xp',      t.xp);
    localStorage.setItem('rg_xp_cap',  t.xpCap);
    localStorage.setItem('rg_ads_until',   t.adsUntil);
    localStorage.setItem('rg_boost_xp_until',  t.xpUntil);
    localStorage.setItem('rg_boost_coin_until',t.coinUntil);
    localStorage.setItem('rg_lucky_until',     t.luckyUntil);
    localStorage.setItem('rg_retry_tokens',    t.retryTokens);
  }

  // âœ… ì„œë²„ì˜ í˜„ì¬ ë¡œê·¸ì¸ ìœ ì € ê¸°ì¤€ìœ¼ë¡œ HUD ê°’ ë™ê¸°í™”
  async function refreshHUDFromServer(){
    try{
      if (window.RG && typeof window.RG.refreshProfile === "function"){
        const me = await window.RG.refreshProfile();
        if (me && typeof me.coins === 'number'){
          const t = readTotals();
          t.coins   = me.coins   ?? t.coins;
          t.tickets = me.tickets ?? t.tickets;
          t.xp      = me.xp      ?? t.xp;
          writeTotals(t);
        }
      }
    }catch{
      /* í´ë°±: ë¡œì»¬ ê°’ ìœ ì§€ */
    }
  }

  function renderHUD(){
    const t = readTotals();
    const coinEl   = document.getElementById('coinVal');
    const ticketEl = document.getElementById('ticketVal');
    const xpEl     = document.getElementById('xpVal');

    if (coinEl)   coinEl.textContent   = t.coins.toLocaleString('en-US');
    if (ticketEl) ticketEl.textContent = t.tickets.toLocaleString('en-US');
    if (xpEl)     xpEl.textContent     = t.xp.toLocaleString('en-US');
  }

  /* ========= 3) ì¹´íƒˆë¡œê·¸ (ì„œë²„ ìš°ì„ , ì‹¤íŒ¨ ì‹œ í´ë°±) ========= */
  const H = 3600e3, D = 24*H;

  const fallbackCatalog = [
    {id:'ad_1h',  name:'ê´‘ê³  ì œê±° 1ì‹œê°„',   desc:'ëª¨ë“  ê´‘ê³  ë¹„í™œì„±í™”', coin:250,  dur:1*H,   kind:'ad'},
    {id:'ad_3h',  name:'ê´‘ê³  ì œê±° 3ì‹œê°„',   desc:'ëª¨ë“  ê´‘ê³  ë¹„í™œì„±í™”', coin:600,  dur:3*H,   kind:'ad'},
    {id:'ad_5h',  name:'ê´‘ê³  ì œê±° 5ì‹œê°„',   desc:'ëª¨ë“  ê´‘ê³  ë¹„í™œì„±í™”', coin:900,  dur:5*H,   kind:'ad'},
    {id:'ad_8h',  name:'ê´‘ê³  ì œê±° 8ì‹œê°„',   desc:'ëª¨ë“  ê´‘ê³  ë¹„í™œì„±í™”', coin:1200, dur:8*H,   kind:'ad'},
    {id:'ad_1d',  name:'ê´‘ê³  ì œê±° 1ì¼',     desc:'ëª¨ë“  ê´‘ê³  ë¹„í™œì„±í™”', coin:2000, dur:1*D,   kind:'ad'},
    {id:'ad_3d',  name:'ê´‘ê³  ì œê±° 3ì¼',     desc:'ëª¨ë“  ê´‘ê³  ë¹„í™œì„±í™”', coin:4800, dur:3*D,   kind:'ad'},
    {id:'ad_5d',  name:'ê´‘ê³  ì œê±° 5ì¼',     desc:'ëª¨ë“  ê´‘ê³  ë¹„í™œì„±í™”', coin:7000, dur:5*D,   kind:'ad'},
    {id:'ad_8d',  name:'ê´‘ê³  ì œê±° 8ì¼',     desc:'ëª¨ë“  ê´‘ê³  ë¹„í™œì„±í™”', coin:9600, dur:8*D,   kind:'ad'},
    {id:'xp2x',   name:'ê²½í—˜ì¹˜ ë¶€ìŠ¤í„° 2ë°°', desc:'íšë“ XP 2ë°°',       coin:600, ticket:1, dur:30*60*1000, kind:'xp'},
    {id:'coin2x', name:'ì½”ì¸ ë¶€ìŠ¤í„° 2ë°°',   desc:'íšë“ ì½”ì¸ 2ë°°',     coin:700, ticket:1, dur:30*60*1000, kind:'coin'},
    {id:'lucky',  name:'ëŸ­í‚¤ ë¶€ìŠ¤í„°',       desc:'í–‰ìš´ë½‘ê¸° í¬ê·€ë„ â†‘',  coin:1500, ticket:2, dur:1*D,       kind:'lucky'},
    {id:'retry',  name:'ë¦¬íŠ¸ë¼ì´ í† í° Ã—1',  desc:'ì¦‰ì‹œ ì¬ë„ì „ 1íšŒ',    coin:300,             kind:'retry'}
  ];

  let catalog = []; // { id/name/desc/coin/ticket/dur/kind, __serverId? }

  function mapServerItem(row){
    // ì„œë²„ ë ˆì½”ë“œ ì˜ˆì‹œ: { id, name, price_coins, stock, metadata }
    const m = row.metadata || {};
    return {
      id: m.client_id || row.id,
      name: row.name,
      desc: m.desc || (m.effect_key ? `${m.effect_key} x${m.effect_value}` : 'ìƒì  ì•„ì´í…œ'),
      coin: Number(row.price_coins || 0),
      ticket: m.ticket || 0,
      dur: m.duration_ms || 0,
      kind: m.kind || 'cosmetic',
      __serverId: row.id
    };
  }

  async function loadCatalog(){
    try{
      const data = await API.list(); // { items: [...] }
      if (Array.isArray(data?.items) && data.items.length){
        catalog = data.items.map(mapServerItem);
        return;
      }
      catalog = fallbackCatalog.slice();
    }catch{
      catalog = fallbackCatalog.slice();
    }
  }

  /* ========= 4) ë Œë”ë§ ========= */
  function msLeft(until){ return Math.max(0, until - Date.now()); }

  function fmtTime(ms){
    if(ms<=0) return 'ë¹„í™œì„±';
    const s=Math.ceil(ms/1000);
    const d=Math.floor(s/86400);
    const h=Math.floor((s%86400)/3600);
    const m=Math.floor((s%3600)/60);
    if(d>0) return `${d}ì¼ ${h}ì‹œê°„`;
    if(h>0) return `${h}ì‹œê°„ ${m}ë¶„`;
    return `${m}ë¶„`;
  }

  function priceBadges(it){
    let html =
      `<span class="price">ğŸª™ <b>${(it.coin||0).toLocaleString()}</b> <span class="k">COINS</span></span>`;
    if(it.ticket){
      html += `<span class="price">ğŸŸï¸ <b>${it.ticket}</b> <span class="k">TICKET</span></span>`;
    }
    return html;
  }

  function activeFor(t, it){
    if(it.kind==='ad')   return msLeft(t.adsUntil);
    if(it.kind==='xp')   return msLeft(t.xpUntil);
    if(it.kind==='coin') return msLeft(t.coinUntil);
    if(it.kind==='lucky')return msLeft(t.luckyUntil);
    if(it.kind==='retry')return t.retryTokens;
    return 0;
  }

  /* âœ… ë Œë” ìŠ¤ì¼€ì¤„ëŸ¬(ì¤‘ë³µ í˜¸ì¶œ ì½”ì–¼ë ˆì‹±) */
  let _shopRenderScheduled = false;
  function queueRenderShop(){
    if (_shopRenderScheduled) return;
    _shopRenderScheduled = true;
    requestAnimationFrame(()=>{
      _shopRenderScheduled = false;
      renderShop();
    });
  }

  function renderShop(){
    const t = readTotals();
    const grid = document.getElementById('shopGrid');
    grid.innerHTML = catalog.map(it=>{
      const a = activeFor(t,it);
      const activeLine = (it.kind==='retry')
        ? `<div class="active">ë³´ìœ : <b class="actOK">${a}</b> ê°œ</div>`
        : `<div class="active">ë‚¨ì€ì‹œê°„: <b class="actOK">${fmtTime(a)}</b></div>`;
      return `
        <article class="card" data-id="${it.id}">
          <h3>${it.name}</h3>
          <div class="desc">
            ${it.desc}${it.dur?` Â· <span style="opacity:.8">${fmtTime(it.dur)} ì§€ì†</span>`:''}
          </div>
          <div class="badgeRow">${priceBadges(it)}</div>
          ${activeLine}
          <div class="buyRow">
            <button class="buy" onclick="buy('${it.id}','coin')">ğŸª™ ì½”ì¸ ê²°ì œ</button>
            ${it.ticket
              ? `<button class="buy alt" onclick="buy('${it.id}','ticket')">ğŸŸï¸ í‹°ì¼“ ê²°ì œ</button>`
              : ''}
          </div>
        </article>`;
    }).join('');
  }

  /* ========= 5) êµ¬ë§¤ (ì„œë²„ ìš°ì„ , ì‹¤íŒ¨ ì‹œ ë¡œì»¬ í´ë°±) ========= */
  function toast(msg){
    let el=document.getElementById('toast');
    if(!el){
      el=document.createElement('div');
      el.id='toast';
      el.className='toast';
      document.body.appendChild(el);
    }
    el.textContent=msg;
    el.classList.remove('show');
    void el.offsetWidth;
    el.classList.add('show');
    setTimeout(()=>el.classList.remove('show'),2200);
  }

  function extendUntil(current, addMs){
    const base = current>Date.now()? current : Date.now();
    return base + addMs;
  }

  async function buy(id, pay){
    const it = catalog.find(x=>String(x.id)===String(id));
    if(!it) return;

    // âœ… ì¸ì¦ ê°€ë“œ(ì „ì—­ requireAuthê°€ ìˆìœ¼ë©´ ì‚¬ìš©)
    if (window.requireAuth){
      const ok = await window.requireAuth();
      if (!ok) return;
    }

    // â”€â”€â”€â”€â”€ 1) ì„œë²„ êµ¬ë§¤ ì‹œë„ (itemId ê¸°ë°˜) â”€â”€â”€â”€â”€
    try{
      if (it.__serverId && pay==='coin'){
        const out = await API.buyByItemId(it.__serverId, 1);
        // ì„œë²„ ì„±ê³µ â†’ HUD ë™ê¸°í™”
        await refreshHUDFromServer();
        renderHUD();
        queueRenderShop();
        toast(`${it.name} êµ¬ë§¤ ì™„ë£Œ! (ì„œë²„)`);
        return;
      }
    }catch(e){
      toast((e.body?.error || e.message || 'êµ¬ë§¤ ì‹¤íŒ¨') + ' â€” ë¡œì»¬ í´ë°± ì‹œë„');
    }

    // â”€â”€â”€â”€â”€ 2) ë¡œì»¬ í´ë°± (ê¸°ì¡´ ë™ì‘ ìœ ì§€) â”€â”€â”€â”€â”€
    const t = readTotals();

    if(pay==='coin'){
      if(t.coins < (it.coin||0)){
        toast('ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.');
        return;
      }
      t.coins -= (it.coin||0);
    }else{
      if(!it.ticket){
        toast('ì´ ìƒí’ˆì€ í‹°ì¼“ ê²°ì œê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      if(t.tickets < it.ticket){
        toast('í‹°ì¼“ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.');
        return;
      }
      t.tickets -= it.ticket;
    }

    if(it.kind==='ad')    t.adsUntil   = extendUntil(t.adsUntil, it.dur||0);
    if(it.kind==='xp')    t.xpUntil    = extendUntil(t.xpUntil, it.dur||0);
    if(it.kind==='coin')  t.coinUntil  = extendUntil(t.coinUntil, it.dur||0);
    if(it.kind==='lucky') t.luckyUntil = extendUntil(t.luckyUntil, it.dur||0);
    if(it.kind==='retry') t.retryTokens = NUM(t.retryTokens) + 1;

    writeTotals(t);
    renderHUD();
    queueRenderShop();

    const paid = (pay==='coin')
      ? `ì½”ì¸ ${(it.coin||0).toLocaleString()}ê°œ`
      : `í‹°ì¼“ ${it.ticket}ì¥`;
    toast(`${it.name} êµ¬ë§¤ ì™„ë£Œ! (${paid})`);
  }

  /* ========= 6) ì´ˆê¸° ë¡œë“œ & ë™ê¸°í™” ========= */
  async function init(){
    // âœ… í˜„ì¬ ë¡œê·¸ì¸í•œ ìœ ì € ê¸°ì¤€ìœ¼ë¡œ HUD ê°’ ë™ê¸°í™”
    await refreshHUDFromServer();
    renderHUD();

    await loadCatalog();
    queueRenderShop();
  }

  window.addEventListener('storage', e=>{
    if([
      'rg_coins','rg_tickets','rg_xp','rg_xp_cap',
      'rg_ads_until','rg_boost_xp_until','rg_boost_coin_until',
      'rg_lucky_until','rg_retry_tokens'
    ].includes(e.key)){
      renderHUD();
      queueRenderShop();
    }
  });

  init();

  /* ========= 7) ë°°ê²½ íŒŒí‹°í´ ========= */
  const c=document.getElementById('fx')
    || (()=>{const cv=document.createElement('canvas');cv.id='fx';document.body.appendChild(cv);return cv;})();
  const g=c.getContext('2d');

  function fit(){
    const d=window.devicePixelRatio||1;
    c.width=innerWidth*d;
    c.height=innerHeight*d;
    g.setTransform(d,0,0,d,0,0);
  }
  fit();
  addEventListener('resize',fit);

  let pts=[];
  for(let i=0;i<80;i++){
    pts.push({
      x:Math.random()*innerWidth,
      y:Math.random()*innerHeight*0.9,
      r:Math.random()*2+0.5,
      s:Math.random()*0.6+0.2
    });
  }

  function loop(){
    g.clearRect(0,0,c.width,c.height);
    for(const p of pts){
      g.beginPath();
      g.arc(p.x,p.y,p.r,0,Math.PI*2);
      g.fillStyle=`rgba(43,123,255,${0.3+Math.sin(Date.now()*0.002+p.x)*0.25})`;
      g.fill();
      p.y+=p.s;
      if(p.y>innerHeight){
        p.y=-10;
        p.x=Math.random()*innerWidth;
      }
    }
    requestAnimationFrame(loop);
  }
  loop();
</script>

  <div id="cookieBanner" class="cookie-banner" role="dialog" aria-live="polite" aria-label="Analytics consent">
    <div>ì„œë¹„ìŠ¤ í’ˆì§ˆ í–¥ìƒì„ ìœ„í•œ ë¶„ì„(ì¿ í‚¤) ì‚¬ìš©ì— ë™ì˜í•˜ì‹œë‚˜ìš”?</div>
    <div class="spacer"></div>
    <button class="deny" type="button">ê±°ë¶€</button>
    <button class="agree" type="button">ë™ì˜</button>
  </div>

  <script>
  (function(){
    try{
      var KEY='rg_analytics_consent';
      function init(){ if(typeof window.analyticsInit==='function') window.analyticsInit(); }
      var v=null; try{ v=localStorage.getItem(KEY); }catch(e){}
      var el=document.getElementById('cookieBanner');
      if(v==='yes'){
        init();
        if(el) el.style.display='none';
        return;
      }
      if(!el){ return; } // no banner -> do not init
      el.style.display='flex';
      var agree=el.querySelector('.agree'), deny=el.querySelector('.deny');
      if(agree) agree.addEventListener('click', function(){
        try{ localStorage.setItem(KEY,'yes'); }catch(e){}
        el.style.display='none'; init();
      });
      if(deny) deny.addEventListener('click', function(){
        try{ localStorage.setItem(KEY,'no'); }catch(e){}
        el.style.display='none';
      });
    }catch(e){ /* no-op */ }
  })();
  </script>
  <script defer src="/assets/js/consent.js"></script>
  <!--#include file="/partials/footer.html" -->
</body>
</html>
