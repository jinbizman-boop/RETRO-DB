<!DOCTYPE html>
<html lang="ko" data-env="production" data-analytics="on">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ì˜¤ëŠ˜ì˜ í–‰ìš´ ìŠ¬ë¡¯ â€“ RETRO GAMES</title>

<!-- Google AdSense ì†Œìœ ê¶Œ í™•ì¸ ë©”íƒ€ íƒœê·¸ -->
<meta name="google-adsense-account" content="ca-pub-6713974265397310" />

<!-- === Common SEO/A11y (auto-inserted) === -->
<link rel="icon" href="/assets/favicon.ico">
<link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/icon-180.png">
<link rel="manifest" href="/site.webmanifest">
<meta name="theme-color" content="#0e1b34">
<meta name="description" content="ì˜¤ëŠ˜ì˜ í–‰ìš´ ìŠ¬ë¡¯ | ë ˆíŠ¸ë¡œ ê°ì„± ë¯¸ë‹ˆê²Œì„ì„ ì¦ê¸°ëŠ” RETRO GAMES">
<meta name="robots" content="index,follow">
<meta property="og:site_name" content="RETRO GAMES">
<meta property="og:title" content="ì˜¤ëŠ˜ì˜ í–‰ìš´ ìŠ¬ë¡¯">
<meta property="og:description" content="ì˜¤ëŠ˜ì˜ í–‰ìš´ ìŠ¬ë¡¯ | ë ˆíŠ¸ë¡œ ê°ì„± ë¯¸ë‹ˆê²Œì„ì„ ì¦ê¸°ëŠ” RETRO GAMES">
<meta property="og:type" content="website">
<meta property="og:image" content="/assets/og/retro-games-card.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="ì˜¤ëŠ˜ì˜ í–‰ìš´ ìŠ¬ë¡¯">
<meta name="twitter:description" content="ì˜¤ëŠ˜ì˜ í–‰ìš´ ìŠ¬ë¡¯ | ë ˆíŠ¸ë¡œ ê°ì„± ë¯¸ë‹ˆê²Œì„ì„ ì¦ê¸°ëŠ” RETRO GAMES">
<meta name="twitter:image" content="/assets/og/retro-games-card.png">
<script>
  // fixed environment flags for analytics/runtime
  (function(d){
    d.documentElement.dataset.env = 'production';
    d.documentElement.dataset.analytics = 'on';
    window.__ENV__ = 'production';
    window.__ANALYTICS_ON__ = true;
  })(document);
</script>
<!-- === /Common SEO/A11y === -->

<!-- âœ… Google AdSense (ìš”ì²­í•˜ì‹  ì‹¤ì œ ì½”ë“œ: ëª¨ë“  í˜ì´ì§€ ê³µí†µ ì‚½ì…ìš©) -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6713974265397310"
        crossorigin="anonymous"></script>

<style>
  :root {--gold1:#ffdf6e;--gold2:#ffb84d;--blue1:#2b7bff;--blue2:#0048ff;--bg:#0b001e}
  html,body{
    height:100%;margin:0;
    background:radial-gradient(circle at 40% -10%,#320076,#0b001e 70%);
    font-family:'Segoe UI',system-ui,Apple SD Gothic Neo,sans-serif;
    color:#fff;overflow:hidden
  }
  .machine{
    position:relative;width:960px;height:700px;
    margin:24px auto;
    background:linear-gradient(180deg,#0a0030,#000);
    border-radius:30px;border:6px solid #3e2b7b;
    box-shadow:0 0 40px #0009,inset 0 0 30px #2a0085
  }
  .header{
    text-align:center;padding-top:14px;
    font-weight:900;font-size:28px;
    color:var(--gold1);text-shadow:0 0 10px #ffb84d
  }
  .stats-row{
    display:flex;justify-content:center;gap:60px;
    margin-top:10px;font-weight:700;font-size:16px;
    color:#fff;text-shadow:0 0 6px #000
  }
  canvas{
    position:absolute;top:130px;left:50%;
    transform:translateX(-50%);
    width:860px;height:380px;
    background:#071726;border:8px solid #0048ff;
    border-radius:16px;
    box-shadow:0 0 20px #0048ffbb,inset 0 0 15px #001a44
  }
  .panel{
    position:absolute;bottom:0;width:100%;height:140px;
    background:linear-gradient(180deg,#0b0050,#00002a);
    border-top:3px solid #4a2a88;border-radius:0 0 24px 24px;
    display:flex;align-items:center;justify-content:center;gap:32px
  }
  .panel button{
    border:none;border-radius:12px;
    font-size:20px;font-weight:900;
    padding:14px 42px;color:#fff;cursor:pointer;
    box-shadow:0 5px 10px #0008;transition:.1s
  }
  .panel button:active{transform:scale(.95)}
  #betBtn{background:linear-gradient(180deg,#4da8ff,#0048ff)}
  #spinBtn{
    background:linear-gradient(180deg,var(--gold1),var(--gold2));
    color:#4a2a00;box-shadow:0 0 20px #ffb84dcc
  }
  #stopBtn{
    background:linear-gradient(180deg,#2b7bff,#0048ff);
    box-shadow:0 0 20px #0077ffcc
  }
  #homeBtn{
    background:linear-gradient(180deg,#4b5563,#111827);
    color:#f9fafb
  }

  /* ì¿ í‚¤ ë°°ë„ˆ (ê³µí†µ) */
  .cookie-banner{
    position:fixed;left:12px;right:12px;bottom:12px;
    display:none;align-items:center;gap:10px;
    padding:10px 12px;border-radius:12px;
    border:1px solid #2b3f8f;
    background:linear-gradient(180deg,#0b1f40,#0a1730);
    box-shadow:0 10px 18px rgba(0,0,0,.45),
               inset 0 0 18px rgba(255,255,255,.05);
    z-index:10000;font-size:12px
  }
  .cookie-banner .spacer{flex:1}
  .cookie-banner button{
    padding:8px 12px;border-radius:10px;
    border:1px solid #2d3690;
    background:linear-gradient(180deg,#1a2b7a,#0a1a64);
    font-weight:800;color:#e9f0ff;cursor:pointer
  }
  .cookie-banner .agree{
    background:linear-gradient(180deg,#ffdf6e,#ffb84d);
    color:#3a2400;border-color:#7a5600
  }

  /* ê´‘ê³  ëª¨ë‹¬ (ì¸í„°ìŠ¤í‹°ì…œ ìš©) */
  #adModal{
    display:none;position:fixed;inset:0;
    background:rgba(0,0,0,.65);backdrop-filter:blur(2px);
    align-items:center;justify-content:center;z-index:9999
  }
  #adBox{
    width:min(680px,92vw);min-height:280px;
    border:2px solid #3e2b7b;border-radius:20px;
    box-shadow:0 30px 60px #000a,inset 0 0 24px #2a0085;
    padding:18px;display:flex;flex-direction:column;gap:10px;
    background:radial-gradient(circle at 50% -60%,#1f0d48,#0c0626 70%)
  }
  #adHead{display:flex;justify-content:space-between;align-items:center}
  #adClose{
    border:0;background:#1b2b7a;
    color:#fff;border-radius:10px;
    padding:6px 10px;cursor:pointer
  }
  .adPlaceholder{
    display:grid;place-items:center;
    height:220px;border-radius:14px;
    border:1px dashed #3952c3;
    background:linear-gradient(135deg,#18224a,#0e1636)
  }
</style>
</head>

<!-- í”„ë¡œì íŠ¸ ìŠ¤í¬ë¦½íŠ¸(ê²½ë¡œ ì ˆëŒ€ ê²½ë¡œë¡œ ìœ ì§€) -->
<script defer src="/assets/js/app.js"></script>
<script defer src="/assets/js/analytics.js"></script>

<body>
  <div id="site-header"></div>

  <div class="machine" role="application" aria-label="ì˜¤ëŠ˜ì˜ í–‰ìš´ ìŠ¬ë¡¯ ë¨¸ì‹ ">
    <div class="header">ì˜¤ëŠ˜ì˜ í–‰ìš´ì„ í™•ì¸í•´ë³´ì„¸ìš”!</div>
    <div class="stats-row" aria-live="polite">
      <div>POINTS: <span id="bank">10000</span></div>
      <div>BET: <span id="bet">100</span></div>
      <div>WIN: <span id="win">0</span></div>
    </div>

    <canvas id="slot" aria-label="ìŠ¬ë¡¯ ë¦´"></canvas>

    <div class="panel">
      <button id="homeBtn" title="RETRO GAMES í™ˆìœ¼ë¡œ ì´ë™">HOME</button>
      <button id="betBtn" title="ì°¸ì—¬í•˜ê¸°(í‹°ì¼“ 5ì¥ ì†Œëª¨)">ì°¸ì—¬í•˜ê¸°</button>
      <button id="spinBtn">í–‰ìš´ì˜ ë£°ë ›</button>
      <button id="stopBtn">í–‰ìš´ í™•ì¸í•˜ê¸°</button>
    </div>
  </div>

  <!-- ì¸í„°ìŠ¤í‹°ì…œ ê´‘ê³  ëª¨ë‹¬ -->
  <div id="adModal" role="dialog" aria-modal="true" aria-labelledby="adTitle">
    <div id="adBox">
      <div id="adHead">
        <h3 id="adTitle" style="margin:0;color:#ffdf6e">ê´‘ê³ </h3>
        <button id="adClose">ë‹«ê¸°</button>
      </div>
      <div id="adContainer" class="adPlaceholder">
        <div style="text-align:center;opacity:.9">
          <div style="font-weight:900;margin-bottom:6px">ì—¬ê¸°ì— ê´‘ê³ ê°€ í‘œì‹œë©ë‹ˆë‹¤</div>
          <div style="font-size:12px;opacity:.8">ê°œë°œ/í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œëŠ” í”Œë ˆì´ìŠ¤í™€ë”ê°€ ë³´ì…ë‹ˆë‹¤</div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ------------------------------------------------------------------
 *  ê³µí†µ ìƒìˆ˜ (AUTH / BASE ê²½ë¡œ)
 * ------------------------------------------------------------------ */
const BASE = "/";
const AUTH_API_BASE = "/api/auth";

/* ------------------------------------------------------------------
 *  ğŸ”Š ì˜¤ëŠ˜ì˜ í–‰ìš´ ì „ìš© BGM
 *  - /assets/music/today-lucky-background.mp3
 *  - ê¸°ë³¸ ë³¼ë¥¨ 30%, loop ì¬ìƒ
 *  - rg_user_settings(soundMaster / bgm)ì™€ ì—°ë™
 * ------------------------------------------------------------------ */
const BGM_SRC_TODAY_LUCKY = "/assets/music/today-lucky-background.mp3";
let bgmLuckyEl = null;
let bgmLuckyReady = false;

function loadRgSettings(){
  try{
    const raw = localStorage.getItem("rg_user_settings");
    if(!raw){
      return {
        soundMaster:true,
        bgm:true,
        backgroundFx:true,
        reducedMotion:false,
        gameCountdown:true,
        gameHints:true
      };
    }
    const parsed = JSON.parse(raw) || {};
    return {
      soundMaster: parsed.soundMaster !== false,
      bgm:         parsed.bgm         !== false,
      backgroundFx:parsed.backgroundFx !== false,
      reducedMotion:!!parsed.reducedMotion,
      gameCountdown: parsed.gameCountdown !== false,
      gameHints:     parsed.gameHints     !== false
    };
  }catch(e){
    return {
      soundMaster:true,
      bgm:true,
      backgroundFx:true,
      reducedMotion:false,
      gameCountdown:true,
      gameHints:true
    };
  }
}
function shouldPlayLuckyBgm(){
  const s = loadRgSettings();
  return !!(s.soundMaster && s.bgm);
}
function ensureLuckyBgm(){
  if(bgmLuckyEl) return bgmLuckyEl;
  bgmLuckyEl = document.createElement("audio");
  bgmLuckyEl.src = BGM_SRC_TODAY_LUCKY;
  bgmLuckyEl.loop = true;
  bgmLuckyEl.volume = 0.3; // ğŸ”Š 30%
  bgmLuckyEl.setAttribute("preload","auto");
  bgmLuckyEl.style.display = "none";
  document.body.appendChild(bgmLuckyEl);
  return bgmLuckyEl;
}
async function tryPlayLuckyBgm(){
  const audio = ensureLuckyBgm();
  if(!shouldPlayLuckyBgm()){
    try{ audio.pause(); }catch(_){}
    return;
  }
  try{
    await audio.play();
    bgmLuckyReady = true;
  }catch(e){
    // ìë™ì¬ìƒ ì°¨ë‹¨ ì‹œ: ì‚¬ìš©ì ì¸í„°ë™ì…˜ ì´í›„ ì¬ì‹œë„
    bgmLuckyReady = false;
  }
}
function handleLuckyBgmUserGesture(){
  if(bgmLuckyReady) return;
  tryPlayLuckyBgm();
}
document.addEventListener("click", handleLuckyBgmUserGesture, { once:true });
document.addEventListener("keydown", handleLuckyBgmUserGesture, { once:true });
window.addEventListener("storage", function(e){
  if(e.key === "rg_user_settings"){
    tryPlayLuckyBgm();
  }
});
document.addEventListener("DOMContentLoaded", function(){
  // DOM ì¤€ë¹„ í›„ ì•½ê°„ì˜ ë”œë ˆì´ ë’¤ì— ì²« ì¬ìƒ ì‹œë„
  setTimeout(tryPlayLuckyBgm, 300);
});

/* ------------------------------------------------------------------
 *  AdSense ì—°ë™ (ì¸í„°ìŠ¤í‹°ì…œ ê´‘ê³ : níšŒ ìŠ¤í•€ë§ˆë‹¤ ë…¸ì¶œ)
 *  - headì— ì‚½ì…ëœ auto-ads ì½”ë“œ + ì—¬ê¸°ì„œ ins íƒœê·¸ë¡œ ìˆ˜ë™ ìŠ¬ë¡¯ í˜¸ì¶œ
 * ------------------------------------------------------------------ */
const AD_CLIENT = 'ca-pub-6713974265397310'; // âœ… ì‹¤ì œ í´ë¼ì´ì–¸íŠ¸ ID
const AD_SLOT   = ''; // í•„ìš” ì‹œ ê°œë³„ ê´‘ê³  ìœ ë‹› slot ID ì„¤ì •

function fallbackAdHTML(){
  return '<div class="adPlaceholder" style="height:220px;display:grid;place-items:center">' +
           '<div style="text-align:center">' +
             '<div style="font-weight:900;margin-bottom:6px">Ad Placeholder</div>' +
             '<div style="font-size:12px;opacity:.8">AdSense ì„¤ì • í›„ ì‹¤ì œ ê´‘ê³ ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>' +
           '</div>' +
         '</div>';
}

function showInterstitialAd(){
  const box = document.getElementById('adContainer');
  if(!box) return;
  box.innerHTML = '';
  const ins = document.createElement('ins');
  ins.className = 'adsbygoogle';
  ins.style.display = 'block';
  ins.setAttribute('data-ad-client', AD_CLIENT);
  if(AD_SLOT) ins.setAttribute('data-ad-slot', AD_SLOT);
  ins.setAttribute('data-ad-format', 'auto');
  ins.setAttribute('data-full-width-responsive', 'true');
  box.appendChild(ins);

  try{
    (window.adsbygoogle = window.adsbygoogle || []).push({});
  }catch(e){
    console.warn('[AdSense] push error:', e);
    box.innerHTML = fallbackAdHTML();
  }
  document.getElementById('adModal').style.display = 'flex';
}

let _afterAd = null;
function showAdThen(fn){
  _afterAd = (typeof fn === 'function') ? fn : null;
  showInterstitialAd();
}

document.getElementById('adClose').addEventListener('click', ()=>{
  document.getElementById('adModal').style.display = 'none';
  const f = _afterAd;
  _afterAd = null;
  if(f){
    try{ f(); }catch(e){ console.error(e); }
  }
});

/* ------------------------------------------------------------------
 *  Canvas setup
 * ------------------------------------------------------------------ */
const c = document.getElementById('slot');
const g = c.getContext('2d');
function resize(){
  const d = window.devicePixelRatio || 1;
  c.width  = Math.floor(860*d);
  c.height = Math.floor(380*d);
  g.setTransform(d,0,0,d,0,0);
  g.imageSmoothingEnabled = false;
}
resize();
addEventListener('resize', resize, {passive:true});

/* ------------------------------------------------------------------
 *  Tickets (5ì¥ ì†Œëª¨, ê³µìš© í‚¤)
 *  - user-retro-games.htmlê³¼ ë™ì¼ í‹°ì¼“ í’€ì„ ê³µìœ í•˜ê¸° ìœ„í•´ ê¸°ì¡´ í‚¤ ì‚¬ìš©
 * ------------------------------------------------------------------ */
const TICKET_KEY = 'tickets2048';
const TICKETS_PER_ENTRY = 5;
const getTickets = ()=> +(localStorage.getItem(TICKET_KEY)||0);
const setTickets = n => localStorage.setItem(TICKET_KEY, String(Math.max(0, n|0)));

/* ------------------------------------------------------------------
 *  Bank / Bet / Win (ì§€ì† ì €ì¥)
 * ------------------------------------------------------------------ */
const BANK_KEY = 'fortune_points_bank';
const $ = s => document.querySelector(s);
const fmt = n => Number(n||0).toLocaleString('ko-KR');
const bankEl = $('#bank'), betEl = $('#bet'), winEl = $('#win');

let bank    = +((localStorage.getItem(BANK_KEY) ?? bankEl.textContent.replace(/,/g,'') ) || 0);
let bet     = +(betEl.textContent.replace(/,/g,'') || 100);
let lastWin = 0;

function syncBankUI(){
  bankEl.textContent = fmt(bank);
  try{ localStorage.setItem(BANK_KEY, String(bank)); }catch(e){}
}
function syncBetUI(){ betEl.textContent = fmt(bet); }
function syncWinUI(v){ winEl.textContent = fmt(v|0); }

syncBankUI();
syncBetUI();
syncWinUI(0);

/* ------------------------------------------------------------------
 *  ğŸ’° /api/wallet ì—°ë™ ë¸Œë¦¿ì§€ (today-lucky ì „ìš©)
 *  - ê³µí†µ í›… window.RG_addReward(gameId, payload) í˜¸ì¶œ
 *  - ì´í›„ /api/wallet ë¡œ ì§ì ‘ POST (action='reward')
 *  - user-retro-games.html ìª½ HUD/Wallet ì •ë³´ì™€ ì—°ë™
 * ------------------------------------------------------------------ */
/**
 * payload ì˜ˆì‹œ:
 * {
 *   score: 1200,           // ìŠ¤í•€ ê²°ê³¼ ì ìˆ˜ or ë‹¹ì²¨ì•¡
 *   pointsEarned: 1200,    // í¬ì¸íŠ¸ ì¦ê° (ì—†ìœ¼ë©´ 0)
 *   ticketsEarned: -5,     // í‹°ì¼“ ì¦ê° (ì†Œë¹„ ì‹œ ìŒìˆ˜)
 *   playsIncrement: 1,     // í”Œë ˆì´ ì¹´ìš´íŠ¸ ë³€í™”
 *   meta: { ... }          // bankBefore/After, ticketsBefore/After ë“±
 * }
 */
async function sendGameReward(gameId, payload){
  const safePayload = payload || {};
  const game = gameId || "today-lucky";

  // 1) ì „ì—­ í›… ë¨¼ì € í˜¸ì¶œ (í—ˆë¸Œì—ì„œ HUD/ì§€ê°‘ ë™ê¸°í™”)
  try{
    if (typeof window.RG_addReward === "function") {
      // í†µì¼ëœ ì‹œê·¸ë‹ˆì²˜: (gameId, payload)
      window.RG_addReward(game, {
        score:          safePayload.score        || 0,
        pointsEarned:   safePayload.pointsEarned || 0,
        ticketsEarned:  safePayload.ticketsEarned|| 0,
        playsIncrement: safePayload.playsIncrement||0,
        meta:           safePayload.meta || {}
      });
    }
  }catch(e){
    console.warn('[RG][reward] RG_addReward hook error:', e);
  }

  // 2) /api/wallet POST â€“ ì„œë²„ ì§€ê°‘/ê¸°ë¡ ë°˜ì˜
  try{
    const body = {
      game: game,
      action: 'reward',
      score:          safePayload.score        || 0,
      pointsEarned:   safePayload.pointsEarned || 0,
      ticketsEarned:  safePayload.ticketsEarned|| 0,
      playsIncrement: safePayload.playsIncrement||0,
      meta:           safePayload.meta || {}
    };

    const res = await fetch('/api/wallet', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify(body)
    });

    if(!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json().catch(()=>null);
    console.log('[RG][wallet] today-lucky synced:', data);
    return data;
  }catch(err){
    console.warn('[RG][wallet] today-lucky sync failed:', err);
    return null;
  }
}

/* ------------------------------------------------------------------
 *  Spin + Ad ì£¼ê¸° ì¹´ìš´íŠ¸ (3 ìŠ¤í•€ë§ˆë‹¤ ê´‘ê³  1íšŒ)
 * ------------------------------------------------------------------ */
const PLAY_KEY = 'plays_todayLucky';
function incPlaysAndMaybeAd(){
  let p = +(localStorage.getItem(PLAY_KEY)||0);
  p++;
  try{ localStorage.setItem(PLAY_KEY, String(p)); }catch(e){}
  if(p % 3 === 0){
    // 3íšŒ ìŠ¤í•€ë§ˆë‹¤ ì¸í„°ìŠ¤í‹°ì…œ
    showInterstitialAd();
  }
}

/* ------------------------------------------------------------------
 *  Reels Model (ordered strip)
 * ------------------------------------------------------------------ */
const REELS = 5, ROWS = 5;
const ORDER = [
  'ğŸ’','ğŸ‹','ğŸ‡','ğŸ‰','ğŸ””',
  'â­','ğŸ’','ğŸ€','ğŸ”¥','ğŸ²',
  'ğŸ§¿','ğŸª™','ğŸ§','ğŸŒŸ','ğŸ°',
  'ğŸ‘‘','ğŸ’°','â¤ï¸','ğŸ’¼','ğŸŒˆ'
];
const STRIP_LEN = ORDER.length * 4; // repeat ORDER 4x
const rowH = () => c.height/ROWS;
const colW = () => c.width/REELS;

// Build strips by repeating ORDER
let strips = Array.from({length: REELS}, ()=>{
  const arr=[];
  while(arr.length < STRIP_LEN){
    for(const s of ORDER){
      if(arr.length < STRIP_LEN) arr.push(s);
    }
  }
  return arr;
});
const wrap = (n,m)=> ((n%m)+m)%m;
const symAt = (reel, idx)=> strips[reel][wrap(idx, STRIP_LEN)];

/* ------------------------------------------------------------------
 *  Spin state (time-based physics)
 * ------------------------------------------------------------------ */
let spinning = false,
    paidForThisRound = false;

// per-reel arrays
let phase   = new Array(REELS).fill(0);     // px position in vertical cycle
let dir     = new Array(REELS).fill(1);     // +1/-1
let stopIdx = new Array(REELS).fill(0);     // target strip index
let state   = new Array(REELS).fill('idle');// 'idle'|'spin'|'brake'

// speed profile
let speed       = new Array(REELS).fill(0);    // px/sec
let cruiseSpeed = new Array(REELS).fill(0);    // px/sec
let rampT       = new Array(REELS).fill(0);    // 0..1 accel progress
let rampDur     = new Array(REELS).fill(0.25); // seconds to reach cruise

// brake profile
let brakeT    = new Array(REELS).fill(0);      // 0..1 brake progress
let brakeDur  = new Array(REELS).fill(1.2);    // seconds (randomized per reel)
let startP    = new Array(REELS).fill(0);      // phase at brake start
let deltaP    = new Array(REELS).fill(0);      // shortest wrapped delta to target

// easing
const easeOutCubic = t => 1 - Math.pow(1-t, 3);
const easeOutQuint = t => 1 - Math.pow(1-t, 5);

// visuals
let dashPhase = 0,
    inited    = false;

/* ------------------------------------------------------------------
 *  Visual helpers
 * ------------------------------------------------------------------ */
function drawCenterFrame(){
  const h = rowH(), w = c.width, H = c.height, y = (H - h)/2;
  dashPhase = (dashPhase + 3) % 40;
  const pulse = 0.7 + 0.3*Math.sin(performance.now()/280);

  g.save();
  g.shadowColor = `rgba(255,220,120,${pulse})`;
  g.shadowBlur  = 22 + 14*pulse;
  g.strokeStyle = 'rgba(255,230,140,0.95)';
  g.lineWidth   = 4;
  g.strokeRect(8, y+6, w-16, h-12);
  g.restore();

  g.save();
  g.setLineDash([12,8]);
  g.lineDashOffset = -dashPhase;
  g.strokeStyle = 'rgba(255,255,255,0.9)';
  g.lineWidth   = 2;
  g.strokeRect(16, y+12, w-32, h-24);
  g.restore();
}
function drawColumnShading(x,w){
  const grd = g.createLinearGradient(x,0,x+w,0);
  grd.addColorStop(0,'rgba(0,0,0,0.55)');
  grd.addColorStop(0.5,'rgba(0,0,0,0.45)');
  grd.addColorStop(1,'rgba(0,0,0,0.55)');
  g.fillStyle = grd;
  g.fillRect(x,6,w,c.height-12);
}

/* ------------------------------------------------------------------
 *  Spin control
 * ------------------------------------------------------------------ */
function startSpin(){
  if(!paidForThisRound){
    alert('ì°¸ì—¬í•˜ê¸°ë¥¼ ë¨¼ì € ëˆŒëŸ¬ í‹°ì¼“ 5ì¥ì„ ì‚¬ìš©í•´ ì£¼ì„¸ìš”.');
    return;
  }
  if(spinning) return;

  spinning = true;
  syncWinUI(0);
  lastWin = 0;

  for(let r=0;r<REELS;r++){
    state[r] = 'spin';
    dir[r]   = (Math.random()<0.5 ? 1 : -1);

    // ê³ ì† í¬ë£¨ì¦ˆ: ìº”ë²„ìŠ¤ ë†’ì´ì— ë¹„ë¡€
    const rh    = rowH();
    const cycle = rh*ROWS;
    cruiseSpeed[r] = cycle / (0.18 + Math.random()*0.06); // 0.18~0.24ì´ˆ per íšŒì „

    // ê°€ì† ì¤€ë¹„
    speed[r]   = 0;
    rampT[r]   = 0;
    rampDur[r] = 0.22 + Math.random()*0.10; // 0.22~0.32s

    // ì •ì§€ ëª©í‘œ ì¸ë±ìŠ¤(ì¤‘ì•™ ë¼ì¸ì— ì˜¤ë„ë¡)
    stopIdx[r] = (Math.random()*STRIP_LEN)|0;

    // ë¸Œë ˆì´í¬ íŒŒë¼ë¯¸í„°ëŠ” stopSpinì—ì„œ ì„¤ì •
  }
}

function stopSpin(){
  if(!spinning) return;
  const rh    = rowH();
  const cycle = rh*ROWS;

  for(let r=0;r<REELS;r++){
    if(state[r]==='brake') continue;

    state[r]   = 'brake';
    brakeT[r]  = 0;
    brakeDur[r] = 0.9 + Math.random()*0.7 + r*0.08; // ë¦´ë³„ ë”œë ˆì´

    startP[r] = wrap(phase[r], cycle);

    // ì¤‘ì•™ ì¤„ì— stopIdxê°€ ìœ„ì¹˜í•˜ë„ë¡ íƒ€ê¹ƒ phase
    const baseTargetIdx = wrap(stopIdx[r]-2, STRIP_LEN);
    const targetPhase   = (baseTargetIdx * rh) % cycle;

    // ê°€ì¥ ì§§ì€ ë©í•‘ ê²½ë¡œ + ì—¬ë¶„ íšŒì „(1~3ë°”í€´)
    let d = targetPhase - startP[r];
    if(d >  cycle/2) d -= cycle;
    if(d < -cycle/2) d += cycle;

    const extraTurns = (1 + Math.random()*2) * Math.sign(dir[r]||1);
    d += extraTurns * cycle;

    deltaP[r] = d;
  }
}

/* ------------------------------------------------------------------
 *  ê²°ê³¼ íŒì •/ì •ì‚°
 * ------------------------------------------------------------------ */
const PAYTABLE = {
  // 3/4/5 of a kind ë©€í‹°í”Œë¼ì´ì–´(ë°°íŒ…ì•¡ * ê³„ìˆ˜)
  'ğŸ’':[2,5,12],   'ğŸ‹':[2,5,12],
  'ğŸ‡':[3,8,18],   'ğŸ‰':[3,8,18],
  'ğŸ””':[4,10,24],  'â­':[5,12,28],
  'ğŸ’':[8,20,50],  'ğŸ€':[6,16,36],
  'ğŸ”¥':[4,10,24],  'ğŸ²':[4,10,24],
  'ğŸ§¿':[5,12,28],  'ğŸª™':[5,12,28],
  'ğŸ§':[3,7,16],   'ğŸŒŸ':[6,16,36],
  'ğŸ°':[7,18,42],  'ğŸ‘‘':[9,22,60],
  'ğŸ’°':[8,20,55],  'â¤ï¸':[3,7,16],
  'ğŸ’¼':[4,10,24],  'ğŸŒˆ':[7,18,42]
};

function evalCenterRow(){
  // stopSpinì—ì„œ ìŠ¤ëƒ…í•œ ê¸°ì¤€: baseTargetIdx = stopIdx-2ê°€ ìœ—ì¤„, ì¤‘ì•™ì€ +2
  const result = [];
  for(let r=0;r<REELS;r++){
    const baseTargetIdx = wrap(stopIdx[r]-2, STRIP_LEN);
    result.push(symAt(r, baseTargetIdx+2));
  }

  // ì™¼â†’ì˜¤ ì—°ì† ë§¤ì¹­ ê¸¸ì´
  let runSym = result[0],
      runLen = 1,
      best   = {sym:runSym,len:1};

  for(let i=1;i<REELS;i++){
    if(result[i] === runSym){
      runLen++;
    }else{
      if(runLen > best.len) best = {sym:runSym,len:runLen};
      runSym = result[i];
      runLen = 1;
    }
  }
  if(runLen > best.len) best = {sym:runSym,len:runLen};

  let payout = 0;
  if(best.len >= 3){
    const table = PAYTABLE[best.sym] || [2,5,12];
    const idx   = best.len===3 ? 0 : best.len===4 ? 1 : 2;
    payout = bet * table[idx];
  }
  return {symbols:result, best, payout};
}

/* ------------------------------------------------------------------
 *  Loop (time-based)
 * ------------------------------------------------------------------ */
let lastTs = performance.now();

function update(dt){
  const rh    = rowH();
  const cycle = rh*ROWS;

  for(let r=0;r<REELS;r++){
    if(state[r]==='spin'){
      // ê°€ì† â†’ í¬ë£¨ì¦ˆ
      rampT[r] = Math.min(1, rampT[r] + dt / rampDur[r]);
      const k  = easeOutQuint(rampT[r]);
      speed[r] = cruiseSpeed[r] * k;
      phase[r] = wrap(phase[r] + dir[r]*speed[r]*dt, cycle);

    }else if(state[r]==='brake'){
      brakeT[r] = Math.min(1, brakeT[r] + dt / brakeDur[r]);
      const t   = easeOutCubic(brakeT[r]);
      phase[r]  = wrap(startP[r] + deltaP[r]*t, cycle);

      if(brakeT[r] >= 1){
        // ìµœì¢… ìŠ¤ëƒ…
        const baseTargetIdx = wrap(stopIdx[r]-2, STRIP_LEN);
        phase[r] = (baseTargetIdx * rh) % cycle;
        speed[r] = 0;
        state[r] = 'idle';
      }
    }
  }

  // ëª¨ë“  ë¦´ ì •ì§€ â†’ íŒì •/ì •ì‚° + ì„œë²„ ë³´ìƒ ì—°ë™
  if(spinning && state.every(s=>s==='idle')){
    spinning         = false;
    paidForThisRound = false;

    const bankBefore = bank;
    const {payout}   = evalCenterRow();
    lastWin = payout|0;
    if(lastWin > 0){
      bank += lastWin;
    }
    syncWinUI(lastWin);
    syncBankUI();
    const bankAfter = bank;

    // ğŸ’° ìŠ¤í•€ ê²°ê³¼ ë³´ìƒ/ì§€ê°‘ ì—°ë™
    sendGameReward('today-lucky', {
      score:         lastWin|0,
      pointsEarned:  lastWin|0,
      ticketsEarned: 0,
      playsIncrement:1,
      meta: {
        kind:          'spinResult',
        bankBefore,
        bankAfter,
        ticketsBefore: getTickets(),
        ticketsAfter:  getTickets()
      }
    });

    // ìŠ¤í•€ ì¹´ìš´íŠ¸ + ê´‘ê³  ì£¼ê¸°
    incPlaysAndMaybeAd();

    // ì„¸ì…˜ ì¢…ë£Œ ì•Œë¦¼
    notifyFinish(lastWin);
  }
}

function draw(){
  // ì´ˆê¸° ì¤‘ì•™ ì •ë ¬
  if(!inited){
    const rh    = rowH();
    const cycle = rh*ROWS;
    for(let r=0;r<REELS;r++){
      const baseTarget = wrap(0-2, STRIP_LEN);
      phase[r] = (baseTarget*rh) % cycle;
    }
    inited = true;
  }

  g.clearRect(0,0,c.width,c.height);
  const W = c.width, H = c.height, cw = colW(), rh = rowH();

  for(let r=0;r<REELS;r++){
    const x    = r*cw;
    const base = Math.floor(phase[r]/rh);
    const off  = phase[r]%rh;

    for(let y=-1;y<ROWS+2;y++){
      const idx = base + y;
      const sym = symAt(r,idx);
      const cx  = x + cw/2;
      const cy  = y*rh - off + rh/2;
      const dist  = Math.abs((cy - H/2)/rh);
      const scale = 1 + (0.24 - 0.12*dist);

      g.save();
      g.translate(cx,cy);
      g.scale(scale,scale);
      const tilt = 0.09 * (r-2);
      g.rotate(tilt);
      g.font         = `${Math.floor(rh*0.66)}px 'Apple Color Emoji','Segoe UI Emoji','Noto Color Emoji'`;
      g.textAlign    = 'center';
      g.textBaseline = 'middle';
      g.shadowColor  = 'rgba(255,255,255,0.35)';
      g.shadowBlur   = 4;
      g.lineWidth    = 2;
      g.strokeStyle  = (dist<0.6)?'rgba(255,255,255,0.75)':'rgba(255,255,255,0.45)';
      g.strokeText(sym,0,2);
      g.fillStyle = '#fff';
      g.fillText(sym,0,2);
      g.restore();
    }

    drawColumnShading(x,cw);
    g.fillStyle = 'rgba(0,120,255,0.22)';
    g.fillRect(Math.round(x-1)+1,6,2,H-12);
  }

  drawCenterFrame();
}

function loop(ts){
  const dt = Math.min(0.033, (ts - lastTs)/1000);
  lastTs = ts;
  update(dt);
  draw();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* ------------------------------------------------------------------
 *  UI
 * ------------------------------------------------------------------ */
const betBtn  = document.getElementById('betBtn');
const spinBtn = document.getElementById('spinBtn');
const stopBtn = document.getElementById('stopBtn');
const homeBtn = document.getElementById('homeBtn');

spinBtn.onclick = () => startSpin();
stopBtn.onclick = () => stopSpin();

// âœ… HOME ë²„íŠ¼: ìœ ì € ê³„ì • ì¸ì‹ í›„ ë©”ì¸ í—ˆë¸Œë¡œ ì´ë™
async function goRetroHome(){
  try{
    const res = await fetch(AUTH_API_BASE + "/me", {
      method: "GET",
      credentials: "include",
      headers: {
        "Accept": "application/json",
        "Cache-Control": "no-store"
      }
    });
    if(res.ok){
      let data = null;
      try{ data = await res.json(); }catch(_){}
      if(data && data.ok && data.user){
        // ë¡œê·¸ì¸ ì„¸ì…˜ ì¡´ì¬ â†’ ê³§ë°”ë¡œ ë©”ì¸ í—ˆë¸Œë¡œ
        window.location.href = BASE + "user-retro-games.html";
        return;
      }
    }
  }catch(e){
    console.warn("[RG][today-lucky] auth check failed on HOME:", e);
  }
  // ì„¸ì…˜ ì—†ìŒ/ì˜¤ë¥˜ â†’ ë¡œê·¸ì¸ í›„ ë©”ì¸ í—ˆë¸Œë¡œ ë³µê·€
  try{
    const next = encodeURIComponent(BASE + "user-retro-games.html");
    window.location.href = BASE + "login.html?next=" + next;
  }catch(e){
    window.location.href = BASE + "login.html";
  }
}
homeBtn.onclick = () => { goRetroHome(); };

// "ì°¸ì—¬í•˜ê¸°" = í‹°ì¼“ 5ì¥ ê²°ì œ (ë¼ìš´ë“œë‹¹ 1íšŒ)
betBtn.onclick = () => {
  if(paidForThisRound){
    alert('ì´ë¯¸ ì´ë²ˆ ë¼ìš´ë“œ ì°¸ì—¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. "í–‰ìš´ì˜ ë£°ë ›"ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”!');
    return;
  }
  const beforeTickets = getTickets();
  if(beforeTickets < TICKETS_PER_ENTRY){
    alert(`í‹°ì¼“ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.\ní•„ìš”: ${TICKETS_PER_ENTRY}ì¥, ë³´ìœ : ${beforeTickets}ì¥`);
    return;
  }
  const afterTickets = beforeTickets - TICKETS_PER_ENTRY;
  setTickets(afterTickets);
  paidForThisRound = true;
  alert(`ì°¸ì—¬ ì™„ë£Œ! í‹°ì¼“ ${TICKETS_PER_ENTRY}ì¥ì„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.\në‚¨ì€ í‹°ì¼“: ${afterTickets}ì¥\nì´ì œ "í–‰ìš´ì˜ ë£°ë ›"ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.`);

  // ğŸ’° í‹°ì¼“ ì†Œë¹„ ì´ë²¤íŠ¸ë¥¼ ì§€ê°‘ ì„œë²„ì— ë°˜ì˜
  sendGameReward('today-lucky', {
    score:          0,
    pointsEarned:   0,
    ticketsEarned: -TICKETS_PER_ENTRY,
    playsIncrement: 0,
    meta: {
      kind:          'entry',
      bankBefore:    bank,
      bankAfter:     bank,
      ticketsBefore: beforeTickets,
      ticketsAfter:  afterTickets
    }
  });
};

// ì ‘ê·¼ì„±: í‚¤ë³´ë“œ ë‹¨ì¶•
document.addEventListener('keydown', (e)=>{
  if(e.code==='Enter'){ betBtn.click(); }
  if(e.code==='Space'){
    e.preventDefault();
    if(spinning) stopBtn.click();
    else spinBtn.click();
  }
});

/* ------------------------------------------------------------------
 *  ì´ˆê¸° ê²€ì¦ ë¡œê·¸
 * ------------------------------------------------------------------ */
(function tests(){
  console.assert(ORDER.length === 20, 'ORDER should have 20 symbols');
  for(let r=0;r<REELS;r++){
    for(let i=0;i<STRIP_LEN;i++){
      console.assert(strips[r][i] === ORDER[i % ORDER.length], 'strip follows ORDER');
    }
  }
  console.log('[Today Lucky] ready.');
})();

/* ------------------------------------------------------------------
 *  ì„¸ì…˜ í›… & ê°€ì‹œì„±
 *  - gameStart / gameFinish : í—ˆë¸Œ/analyticsì™€ í†µí•©
 * ------------------------------------------------------------------ */
function notifyStart(){
  try{
    if(typeof window.gameStart === 'function') window.gameStart('today-lucky');
  }catch(e){}
}
function notifyFinish(finalScore){
  try{
    if(typeof window.gameFinish === 'function') window.gameFinish('today-lucky', finalScore|0);
  }catch(e){}
}

// í˜ì´ì§€ ì§„ì… ì‹œ ì„¸ì…˜ ì‹œì‘
notifyStart();

// íƒ­ ë¹„ê°€ì‹œ ìƒíƒœì—ì„œë„ ê²Œì„ì€ ê·¸ëŒ€ë¡œ ìœ ì§€ (ìë™ ì •ì§€ ë°©ì§€)
document.addEventListener('visibilitychange', ()=>{ /* í•„ìš” ì‹œ ë¡œê¹…ë§Œ */ });
</script>

  <div id="cookieBanner" class="cookie-banner" role="dialog" aria-live="polite" aria-label="Analytics consent">
    <div>ì„œë¹„ìŠ¤ í’ˆì§ˆ í–¥ìƒì„ ìœ„í•œ ë¶„ì„(ì¿ í‚¤) ì‚¬ìš©ì— ë™ì˜í•˜ì‹œë‚˜ìš”?</div>
    <div class="spacer"></div>
    <button class="deny" type="button">ê±°ë¶€</button>
    <button class="agree" type="button">ë™ì˜</button>
  </div>

  <script>
  (function(){
    try{
      var KEY='rg_analytics_consent';
      function init(){ if(typeof window.analyticsInit==='function') window.analyticsInit(); }
      var v=null; try{ v=localStorage.getItem(KEY); }catch(e){}
      var el=document.getElementById('cookieBanner');
      if(v==='yes'){ init(); if(el) el.style.display='none'; return; }
      if(!el){ return; } // no banner -> do not init
      el.style.display='flex';
      var agree=el.querySelector('.agree'), deny=el.querySelector('.deny');
      if(agree) agree.addEventListener('click', function(){
        try{ localStorage.setItem(KEY,'yes'); }catch(e){}
        el.style.display='none'; init();
      });
      if(deny) deny.addEventListener('click', function(){
        try{ localStorage.setItem(KEY,'no'); }catch(e){}
        el.style.display='none';
      });
    }catch(e){ /* no-op */ }
  })();
  </script>

  <div id="site-footer"></div>
</body>
</html>
