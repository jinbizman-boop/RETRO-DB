<!DOCTYPE html>
<html lang="ko" data-env="production" data-analytics="on">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<!-- Google AdSense ì†Œìœ ê¶Œ í™•ì¸ ë©”íƒ€ íƒœê·¸ -->
<meta name="google-adsense-account" content="ca-pub-6713974265397310" />
<title>RETRO TETRIS â€“ Arcade Cabinet</title>

<!-- === Common SEO/A11y (auto-inserted) === -->
<link rel="icon" href="/assets/favicon.ico">
<link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/icon-180.png">
<link rel="manifest" href="/site.webmanifest">
<meta name="theme-color" content="#0e1b34">
<meta name="description" content="RETRO TETRIS â€“ Arcade Cabinet | ë ˆíŠ¸ë¡œ ê°ì„± ë¯¸ë‹ˆê²Œì„ì„ ì¦ê¸°ëŠ” RETRO GAMES">
<meta name="robots" content="index,follow">
<meta property="og:site_name" content="RETRO GAMES">
<meta property="og:title" content="RETRO TETRIS â€“ Arcade Cabinet">
<meta property="og:description" content="RETRO TETRIS â€“ Arcade Cabinet | ë ˆíŠ¸ë¡œ ê°ì„± ë¯¸ë‹ˆê²Œì„ì„ ì¦ê¸°ëŠ” RETRO GAMES">
<meta property="og:type" content="website">
<meta property="og:image" content="/assets/og/retro-games-card.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="RETRO TETRIS â€“ Arcade Cabinet">
<meta name="twitter:description" content="RETRO TETRIS â€“ Arcade Cabinet | ë ˆíŠ¸ë¡œ ê°ì„± ë¯¸ë‹ˆê²Œì„ì„ ì¦ê¸°ëŠ” RETRO GAMES">
<meta name="twitter:image" content="/assets/og/retro-games-card.png">
<script>
  // fixed environment flags for analytics/runtime
  (function(d){
    d.documentElement.dataset.env = 'production';
    d.documentElement.dataset.analytics = 'on';
    window.__ENV__ = 'production';
    window.__ANALYTICS_ON__ = true;
  })(document);
</script>
<!-- === /Common SEO/A11y === -->

<!-- AdSense ìŠ¤ë‹ˆí«(ìš”ì²­ ê·¸ëŒ€ë¡œ, ì‹¤ì œ í´ë¼ì´ì–¸íŠ¸ ID ì ìš©) -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6713974265397310"
     crossorigin="anonymous"></script>
  
<style>
  :root{
    --cabinet:#071933; --cabinet2:#0b2a57; --bezel:#0c1e3f; --glow:#0ea5ff; --side:#f4be09;
    --btn:#133262; --btnBorder:#285dd1; --btnFg:#e9f1ff;
    --board:#121a2f; --tile0:#e9eef6; --ink:#111;
    --t2:#e7f4ff; --t4:#d6eaff; --t8:#ffe7c2; --t16:#ffd6a6; --t32:#ffc8a6; --t64:#ffb79c;
    --t128:#fff3a8; --t256:#fff09a; --t512:#ffeb8a; --t1024:#eaff9c; --t2048:#caffb0; --t4096:#b6ffd2; --t8192:#b2fff0;
  }
  *{box-sizing:border-box}
  html,body{
    height:100%;margin:0;color:#fff;font-family:'Pretendard',ui-sans-serif,system-ui,"Segoe UI",Roboto,"Apple SD Gothic Neo";overflow:hidden;
    background:#0b001e radial-gradient(circle at 40% -10%, #320076, #0b001e 70%) no-repeat;
    background-size:cover;
  }
  #fx{position:fixed;inset:0;pointer-events:none;z-index:0;opacity:.75}
  .shell{min-height:100vh;display:grid;place-items:center;padding:20px;position:relative;z-index:1;padding-bottom:calc(20px + env(safe-area-inset-bottom,0))}

  /* ===== ì „ì²´ ë ˆì´ì•„ì›ƒ(ê²Œì„ + ì¢Œìš° ì„¸ë¡œ ê´‘ê³ ) ===== */
  .games-page{
    width:100%;
    max-width:1400px;
    display:grid;
    grid-template-columns:minmax(0,1fr) minmax(0,1200px) minmax(0,1fr);
    gap:16px;
    align-items:flex-start;
  }
  .ad-rail{
    display:flex;
    justify-content:center;
    align-items:center;
  }
  .ad-rail-inner{
    width:120px;
    max-width:100%;
    min-height:600px;
    border-radius:16px;
    border:1px solid #283a73;
    box-shadow:0 10px 30px rgba(0,0,0,.6), inset 0 0 24px rgba(46,74,163,.45);
    padding:8px;
    background:radial-gradient(circle at 20% 0%,#233a72,#06091a 70%);
    display:flex;
    justify-content:center;
    align-items:center;
  }
  .ad-rail .adsbygoogle{
    display:inline-block;
    width:120px;
    height:600px;
  }
  .ad-fallback{
    font-size:11px;
    text-align:center;
    opacity:.75;
    line-height:1.4;
  }
  .ad-fallback strong{
    display:block;
    margin-bottom:4px;
    font-size:12px;
  }

  /* Cabinet */
  .cabinet{position:relative;width:min(1200px,96vw);background:#0e1b34;border-radius:18px;box-shadow:0 12px 40px rgba(0,0,0,.65),inset 0 0 0 2px #0a1a33;transform-origin:top center}
  .cabinet:before,.cabinet:after{content:"";position:absolute;top:12px;bottom:12px;width:18px;filter:drop-shadow(0 0 12px rgba(255,190,0,.55));
    background:linear-gradient(180deg,#ffd34a,#f0b400 60%,#d99a00)}
  .cabinet:before{left:12px;border-radius:9px}
  .cabinet:after{right:12px;border-radius:9px}

  .marquee{padding:18px;border-radius:18px 18px 0 0;border-bottom:1px solid #0c2b59;box-shadow:inset 0 -6px 26px rgba(0,0,0,.35);
    background:linear-gradient(180deg,#173763,#0b2548)}
  .title{display:flex;align-items:center;justify-content:center;gap:12px;flex-wrap:wrap}
  .title h1{margin:0;font-weight:900;letter-spacing:2px;color:#eaf3ff;text-shadow:0 0 12px rgba(62,142,255,.55);font-size:clamp(18px,4.4vw,28px)}
  .subtitle{opacity:.75;letter-spacing:.2em;font-size:clamp(10px,2.7vw,12px);text-align:center}

  /* HUD */
  .hud{display:flex;gap:12px;padding:12px;justify-content:center;flex-wrap:wrap}
  .chip,.pill,.hud .btnMini{position:relative;min-width:128px;height:46px;padding:0 16px;border-radius:14px;border:1px solid #1e63ff;color:#fff;font-weight:900;display:inline-flex;align-items:center;justify-content:center;letter-spacing:.3px;box-shadow:0 12px 18px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.5), inset 0 -8px 14px rgba(0,0,0,.28);
    background:linear-gradient(180deg,#8fe0ff 0%,#49a8ff 26%,#2f84ff 58%,#1560f2 100%),radial-gradient(140% 120% at 20% -40%,rgba(255,255,255,.65),rgba(255,255,255,0) 55%)}
  .chip b{color:#fff;font-weight:900;padding-left:6px;text-shadow:0 1px 0 rgba(0,0,0,.25)}
  .pill{min-width:260px;gap:12px}
  .pill .icon{width:28px;height:28px;display:grid;place-items:center;border-radius:50%;color:#0b2a57;box-shadow:inset 0 -4px 8px rgba(0,0,0,.25), 0 0 10px rgba(255,255,255,.65);
    background:radial-gradient(circle at 30% 30%,#ffffff,#d8f1ff)}
  .points .bar,.tickets .bar{height:8px;border-radius:999px;background:#1a2548;overflow:hidden;border:1px solid #2b3f8f;width:120px}
  .points .bar>span,.tickets .bar>span{display:block;height:100%;width:0%;box-shadow:0 0 10px #8ad7ff; background:linear-gradient(90deg,#b86cff,#6af0ff)}
  .points .nums,.tickets .nums{display:flex;align-items:baseline;gap:8px;font-weight:900}
  .points .nums .big,.tickets .nums .big{font-size:18px;color:#ffe9a3;text-shadow:0 0 8px #ffd86a}
  .points .nums .cap,.tickets .nums .cap{opacity:.8;font-size:12px}
  .playCount{font-size:12px;opacity:.85;margin-left:6px}

  /* Screen */
  .play{position:relative;margin:10px 18px;border-radius:16px;box-shadow:inset 0 0 0 1px #0b2a57,inset 0 0 60px rgba(0,0,0,.65);
    background:linear-gradient(180deg,#0a1530,#031125)}
  .screen{aspect-ratio:16/9;display:grid;place-items:center;padding:18px}
  .bezel{width:100%;height:100%;border-radius:14px;box-shadow:inset 0 0 0 1px #132a59,inset 0 0 60px rgba(0,0,0,.65);display:grid;place-items:center;position:relative;overflow:hidden;
    background:radial-gradient(120% 200% at 50% -60%,rgba(255,255,255,.07),rgba(255,255,255,0) 40%),linear-gradient(180deg,#0a1c39,#0a1326)}
  .canvasWrap{width:min(92%,980px);max-height:85%;display:grid;place-items:center}
  canvas#game{
    display:block;max-width:100%;max-height:100%;
    width:100%;height:100%;
    background:#000;border-radius:18px;border:1px solid #1b2b45;box-shadow:inset 0 0 40px rgba(0,0,0,.25)
  }

  /* Overlay */
  .overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(5,0,20,.55);backdrop-filter:blur(2px);z-index:5}
  .overlay .msg{font-weight:900;letter-spacing:.2em;text-align:center;filter:drop-shadow(0 6px 20px rgba(0,0,0,.6));
    font-size:clamp(28px,5vw,68px);color:#ffe166;text-shadow:0 0 16px rgba(255,225,102,.45),0 0 40px rgba(14,165,255,.25)}
  .overlay .sub{margin-top:10px;font-size:clamp(12px,2.2vw,16px);opacity:.9;color:#dfe9ff;text-align:center}

  /* Deck */
  .deck{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;padding:14px 18px 22px;border-top:1px solid #0a2b57;
    background:linear-gradient(180deg,#0b1f40,#0a1730)}
  .deck .btn,.deck select,.deck input[type=range]{font-weight:900;color:#dff1ff;border:1px solid #224aa8;border-radius:12px;padding:10px 14px;box-shadow:0 10px 18px rgba(0,0,0,.45),inset 0 0 18px rgba(255,255,255,.05);cursor:pointer;
    background:linear-gradient(180deg,#1b3a7a,#102a66)}
  .deck .btn:hover,.deck select:hover{filter:brightness(1.06)}
  .deck label{display:flex;align-items:center;gap:8px}
  .deck input[type=range]{width:140px;height:12px;accent-color:#5fb0ff}

  /* Records Modal */
  #recModal{display:none;position:fixed;inset:0;background:rgba(5,0,20,.55);backdrop-filter:blur(4px);align-items:center;justify-content:center;z-index:999}
  /* Ad Modal */
  #adModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.65);backdrop-filter:blur(2px);align-items:center;justify-content:center;z-index:1000}
  #adBox{width:min(680px,92vw);min-height:280px;border:2px solid #3e2b7b;border-radius:20px;box-shadow:0 30px 60px #000a,inset 0 0 24px #2a0085;padding:18px;display:flex;flex-direction:column;gap:10px;
    background:radial-gradient(circle at 50% -60%,#1f0d48,#0c0626 70%)}
  #adHead{display:flex;justify-content:space-between;align-items:center}
  #adClose{border:0;background:#1b2b7a;color:#fff;border-radius:10px;padding:6px 10px;cursor:pointer}
  .adPlaceholder{display:grid;place-items:center;height:220px;border-radius:14px;border:1px dashed #3952c3;
    background:linear-gradient(135deg,#18224a,#0e1636)}

  /* ===== Mobile tweaks ===== */
  @media (max-width: 1200px){
    .games-page{
      grid-template-columns:minmax(0,1fr);
    }
    .ad-rail{
      display:none;
    }
  }

  @media (max-width: 980px){
    .shell{padding:12px;padding-bottom:calc(12px + env(safe-area-inset-bottom,0))}
    .cabinet{width:100vw;border-radius:0}
    .marquee{padding:12px;border-radius:0}
    .play{margin:8px 12px}
    .screen{padding:10px}
    .hud{gap:8px;padding:10px}
    .chip,.pill,.hud .btnMini{min-width:112px;height:42px;padding:0 12px}
    .pill{min-width:220px}
    .deck{gap:8px;padding:10px 12px 16px}
    .deck .btn,.deck select,.deck input[type=range]{padding:10px 12px}
  }
  @media (max-width: 640px){
    .chip,.pill,.hud .btnMini{height:40px}
    .points .bar,.tickets .bar{width:96px}
    .deck{justify-content:flex-start;overflow:auto;-webkit-overflow-scrolling:touch}
    .deck>*{flex:0 0 auto}
  }

  .cookie-banner{position:fixed;left:12px;right:12px;bottom:12px;
    display:none;align-items:center;gap:10px;padding:10px 12px;border-radius:12px;
    border:1px solid #2b3f8f;background:linear-gradient(180deg,#0b1f40,#0a1730);
    box-shadow:0 10px 18px rgba(0,0,0,.45),inset 0 0 18px rgba(255,255,255,.05);
    z-index:10000;font-size:12px}
  .cookie-banner .spacer{flex:1}
  .cookie-banner button{padding:8px 12px;border-radius:10px;border:1px solid #2d3690;
    background:linear-gradient(180deg,#1a2b7a,#0a1a64);font-weight:800;color:#e9f0ff;cursor:pointer}
  .cookie-banner .agree{background:linear-gradient(180deg,#ffdf6e,#ffb84d);color:#3a2400;border-color:#7a5600}

</style>
</head>

<!-- ê²½ë¡œë¥¼ ì ˆëŒ€ê²½ë¡œë¡œ ê³ ì •: /public/games/ ì—ì„œë„ ê³µí†µ JSê°€ ì•ˆì „í•˜ê²Œ ë¡œë“œë˜ë„ë¡ ìˆ˜ì • -->
<script defer src="/assets/js/app.js"></script>
<script defer src="/assets/js/analytics.js"></script>

<body>
  <div id="site-header"></div>
  <canvas id="fx"></canvas>
  <div class="shell">
    <div class="games-page">
      <!-- ì¢Œì¸¡ ì„¸ë¡œí˜• ê´‘ê³  ë°°ë„ˆ -->
      <aside class="ad-rail ad-rail-left" aria-label="left vertical ad">
        <div class="ad-rail-inner">
          <div>
            <ins class="adsbygoogle side-ad-slot"
                 style="display:inline-block;width:120px;height:600px"
                 data-ad-client="ca-pub-6713974265397310"
                 data-ad-slot="">
            </ins>
            <div class="ad-fallback">
              <strong>ê´‘ê³  ì˜ì—­</strong>
              AdSense ì„¤ì • í›„<br>120Ã—600 ì„¸ë¡œ ë°°ë„ˆê°€<br>ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
            </div>
          </div>
        </div>
      </aside>

      <!-- ë©”ì¸ ì•„ì¼€ì´ë“œ ìºë¹„ë‹› -->
      <section class="cabinet" aria-label="retro arcade cabinet">
        <header class="marquee">
          <div class="title">
            <h1>RETRO TETRIS</h1>
            <div class="subtitle">Enter/N: ì‹œì‘ Â· Space/U: ì¼ì‹œì •ì§€ Â· â†â†’â†“ ì´ë™ Â· â†‘ í•˜ë“œë“œë¡­ Â· Z/X íšŒì „ Â· C í™€ë“œ</div>
          </div>
        </header>

        <!-- HUD -->
        <div class="hud">
          <div class="chip">ì ìˆ˜ <b id="score">0</b></div>
          <div class="chip">ìµœê³  <b id="best">0</b></div>
          <div class="chip">ì´ë™ <b id="moves">0</b></div>

          <div class="pill points" aria-label="ì‚¬ìš©ì í¬ì¸íŠ¸">
            <div class="icon">ğŸ…</div>
            <div>
              <div class="nums"><span class="big" id="pointsAmt">0</span><span class="cap">/ <span id="pointsCap">5,000</span></span></div>
              <div class="bar"><span id="pointsBar"></span></div>
            </div>
          </div>

          <div class="pill tickets" aria-label="í‹°ì¼“ ì§„í–‰">
            <div class="icon">ğŸŸï¸</div>
            <div>
              <div class="nums"><span class="big" id="ticketsAmt">0</span><span class="cap">í‹°ì¼“</span></div>
              <div class="bar"><span id="ticketsBar"></span></div>
            </div>
            <div class="playCount" id="ticketsCap">0 / 10</div>
          </div>

          <button class="btnMini" id="recordsBtn" aria-label="ë‚´ ê²Œì„ ê¸°ë¡">MY RECORDS</button>
        </div>

        <main class="play">
          <div class="screen">
            <div class="bezel">
              <div class="canvasWrap" id="canvasWrap">
                <canvas id="game"></canvas>
              </div>
              <div id="gameOver" class="overlay" aria-live="polite" role="alert">
                <div>
                  <div class="msg">GAME OVER</div>
                  <div class="sub">Enter/N: ìƒˆ ê²Œì„ Â· Space/U: ì¼ì‹œì •ì§€/ì¬ê°œ</div>
                </div>
              </div>
            </div>
          </div>
        </main>

        <!-- Control deck -->
        <div class="deck">
          <button class="btn" id="homeBtn">HOME</button>
          <button class="btn" id="newBtn">ìƒˆ ê²Œì„ (N / Enter)</button>
          <button class="btn" id="undoBtn">ì¼ì‹œì •ì§€/ì¬ê°œ (U / Space)</button>
          <label>ëª¨ë“œ
            <select id="tier">
              <option value="beginner">ì´ˆê¸‰ (1â€“10)</option>
              <option value="intermediate">ì¤‘ê¸‰ (11â€“20)</option>
              <option value="advanced">ê³ ê¸‰ (21â€“30)</option>
              <option value="hell">ì§€ì˜¥ (40)</option>
              <option value="doom">íŒŒë©¸ (50)</option>
              <option value="insane">ê·¹ì•…ë¬´ë„ (100)</option>
            </select>
          </label>
          <label>ë ˆë²¨ <input id="lvlRange" type="range" min="1" max="100" value="1" step="1"></label>
          <label>ë³´ë“œ
            <select id="sizeSel" disabled>
              <option value="12" selected>ê³ ì •</option>
            </select>
          </label>
          <button class="btn" id="endBtn">ê²Œì„ ì¢…ë£Œ</button>
        </div>
      </section>

      <!-- ìš°ì¸¡ ì„¸ë¡œí˜• ê´‘ê³  ë°°ë„ˆ -->
      <aside class="ad-rail ad-rail-right" aria-label="right vertical ad">
        <div class="ad-rail-inner">
          <div>
            <ins class="adsbygoogle side-ad-slot"
                 style="display:inline-block;width:120px;height:600px"
                 data-ad-client="ca-pub-6713974265397310"
                 data-ad-slot="">
            </ins>
            <div class="ad-fallback">
              <strong>ê´‘ê³  ì˜ì—­</strong>
              AdSense ì„¤ì • í›„<br>120Ã—600 ì„¸ë¡œ ë°°ë„ˆê°€<br>ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
            </div>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <!-- Records Modal -->
  <div id="recModal">
    <div style="width:min(640px,94vw);border:2px solid #3e2b7b;border-radius:20px;box-shadow:0 30px 60px #000a,inset 0 0 24px #2a0085;padding:22px; background:radial-gradient(circle at 50% -60%,#1f0d48,#0c0626 70%);">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><h3 style="margin:0;color:#ffdf6e">ë‚´ ê²Œì„ ê¸°ë¡</h3><button id="recClose" style="border:0;background:transparent;color:#fff;font-size:22px;cursor:pointer">Ã—</button></div>
      <div id="recBody" style="max-height:60vh;overflow:auto;border:1px solid #2a3a89;border-radius:12px;padding:8px"></div>
    </div>
  </div>

  <!-- Ad Modal -->
  <div id="adModal" role="dialog" aria-modal="true" aria-labelledby="adTitle">
    <div id="adBox">
      <div id="adHead">
        <h3 id="adTitle" style="margin:0;color:#ffdf6e">ê´‘ê³ </h3>
        <button id="adClose">ë‹«ê¸°</button>
      </div>
      <div id="adContainer" class="adPlaceholder">
        <div style="text-align:center;opacity:.9">
          <div style="font-weight:900;margin-bottom:6px">ì—¬ê¸°ì— ê´‘ê³ ê°€ í‘œì‹œë©ë‹ˆë‹¤</div>
          <div style="font-size:12px;opacity:.8">ê°œë°œ/í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œëŠ” í”Œë ˆì´ìŠ¤í™€ë”ê°€ ë³´ì…ë‹ˆë‹¤</div>
        </div>
      </div>
    </div>
  </div>

<script>
/***** AdSense ì—°ë™ *****/
const AD_CLIENT = 'ca-pub-6713974265397310'; // âœ… ë©”íƒ€/ìŠ¤ë‹ˆí«ê³¼ ë™ì¼
const AD_SLOT   = ''; // TODO: ì‹¤ì œ ì• ë“œì„¼ìŠ¤ ê´‘ê³  ìœ ë‹› slot IDë¡œ êµì²´í•˜ë©´ ê°œë³„ ê´‘ê³  ë…¸ì¶œ ê°€ëŠ¥

function fallbackAdHTML(){
  return '<div class="adPlaceholder" style="height:220px;display:grid;place-items:center"><div style="text-align:center"><div style="font-weight:900;margin-bottom:6px">Ad Placeholder</div><div style="font-size:12px;opacity:.8">AdSense ì„¤ì • í›„ ì‹¤ì œ ê´‘ê³ ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div></div></div>';
}

function showInterstitialAd(){
  const box=document.getElementById('adContainer');
  if(!box) return;
  box.innerHTML='';
  const ins=document.createElement('ins');
  ins.className='adsbygoogle';
  ins.style.display='block';
  ins.setAttribute('data-ad-client', AD_CLIENT);
  if(AD_SLOT) ins.setAttribute('data-ad-slot', AD_SLOT);
  ins.setAttribute('data-ad-format','auto');
  ins.setAttribute('data-full-width-responsive','true');
  box.appendChild(ins);
  try{ (window.adsbygoogle=window.adsbygoogle||[]).push({}); }
  catch(e){ console.warn(e); box.innerHTML = fallbackAdHTML(); }
  document.getElementById('adModal').style.display='flex';
}
let _afterAd=null;
function showAdThen(fn){ _afterAd = (typeof fn==='function') ? fn : null; showInterstitialAd(); }
document.getElementById('adClose').addEventListener('click',()=>{
  document.getElementById('adModal').style.display='none';
  const f=_afterAd; _afterAd=null; if(f) try{ f(); }catch(e){ console.error(e); }
});

/* ì¢Œìš° ì„¸ë¡œí˜• ë°°ë„ˆ ì´ˆê¸°í™” */
function initSideAds(){
  const slots=document.querySelectorAll('.side-ad-slot');
  if(!slots.length) return;
  slots.forEach(function(slot){
    try{
      (window.adsbygoogle=window.adsbygoogle||[]).push({});
    }catch(e){
      console.warn('side ad init error', e);
    }
  });
}
if(document.readyState === 'complete'){
  initSideAds();
}else{
  window.addEventListener('load', initSideAds);
}

/***** Neon FX *****/
(function(){
  const c=document.getElementById('fx'); if(!c) return;
  const g=c.getContext('2d');
  function fit(){ const d=window.devicePixelRatio||1; c.width=innerWidth*d; c.height=innerHeight*d; g.setTransform(d,0,0,d,0,0); }
  fit(); addEventListener('resize',fit,{passive:true});
  const N=80; const pts=new Array(N).fill(0).map(()=>({x:Math.random()*innerWidth,y:Math.random()*innerHeight*0.9,r:Math.random()*2+0.5,s:Math.random()*0.6+0.2,ph:Math.random()*6.283}));
  function loop(t){
    g.clearRect(0,0,c.width,c.height);
    for(const p of pts){
      g.beginPath(); g.arc(p.x,p.y,p.r,0,Math.PI*2);
      const a=0.3+Math.sin(t*0.002+p.ph)*0.25; g.fillStyle='rgba(43,123,255,'+a+')'; g.fill();
      p.y+=p.s; if(p.y>innerHeight){ p.y=-10; p.x=Math.random()*innerWidth; }
    }
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);
})();

/***** Helpers & Storage *****/
const $=sel=>document.querySelector(sel);
const DPR=()=>Math.min(2, window.devicePixelRatio||1);
const clamp=(n,a,b)=>Math.max(a, Math.min(b,n));
const fmt=n=>n.toLocaleString('ko-KR');

/* âœ… Tetris ì „ìš© í‚¤ */
const LS_KEYS={plays:'plays_tetris',tickets:'tickets_tetris',records:'records_tetris',best:'best_tetris'};

function loadJSON(k,def){try{const v=localStorage.getItem(k); return v? JSON.parse(v): def;}catch(e){ return def; }}
function saveJSON(k,v){localStorage.setItem(k, JSON.stringify(v));}

function updateTicketUI(){
  const plays= +localStorage.getItem(LS_KEYS.plays)||0;
  const tickets= +localStorage.getItem(LS_KEYS.tickets)||0;
  $('#ticketsAmt').textContent=tickets;
  $('#ticketsCap').textContent=(plays%10)+' / 10';
  $('#ticketsBar').style.width = (((plays%10)/10*100).toFixed(1))+'%';
}

/***** í”Œë ˆì´/í‹°ì¼“ ì¹´ìš´íŠ¸ & ê´‘ê³  ì£¼ê¸° (3íšŒë‹¹ 1íšŒ) *****/
function addPlay(){
  let plays= +localStorage.getItem(LS_KEYS.plays)||0; plays++;
  let tickets= +localStorage.getItem(LS_KEYS.tickets)||0;
  if(plays%10===0) tickets++;
  localStorage.setItem(LS_KEYS.plays, String(plays));
  localStorage.setItem(LS_KEYS.tickets, String(tickets));
  updateTicketUI();
  /* ğŸ” 3íšŒ í”Œë ˆì´ë§ˆë‹¤ ì¸í„°ìŠ¤í‹°ì…œ ê´‘ê³  ë…¸ì¶œ */
  if(plays % 3 === 0){ showInterstitialAd(); }
}

function addRecord(score, points){
  const recs=loadJSON(LS_KEYS.records,[]); const now=new Date();
  recs.unshift({ts:now.toISOString(), score, points});
  saveJSON(LS_KEYS.records,recs.slice(0,200));
}
function showRecords(){
  const recs=loadJSON(LS_KEYS.records,[]);
  const rows = recs.map(r=>{
    const d=new Date(r.ts); const date=d.toLocaleString('ko-KR');
    return `<tr>
      <td style="padding:6px 8px;border-bottom:1px solid #233077">${date}</td>
      <td style="padding:6px 8px;text-align:right;border-bottom:1px solid #233077">${fmt(r.score||0)}</td>
      <td style="padding:6px 8px;text-align:right;border-bottom:1px solid #233077">${fmt(r.points||0)}</td>
    </tr>`;
  }).join('');
  $('#recBody').innerHTML = `<table style="width:100%;border-collapse:collapse;font-size:13px">
    <thead><tr><th style='text-align:left;padding:8px;border-bottom:1px solid #314099'>ë‚ ì§œ/ì‹œê°„</th><th style='text-align:right;padding:8px;border-bottom:1px solid #314099'>ì ìˆ˜</th><th style='text-align:right;padding:8px;border-bottom:1px solid #314099'>í¬ì¸íŠ¸</th></tr></thead>
    <tbody>${rows}</tbody></table>`;
  $('#recModal').style.display='flex';
}

/***** ë‚œì´ë„ ë°°ìœ¨ *****/
function difficultyMult(){
  const v=$('#tier')?.value||'beginner';
  return {beginner:1.00, intermediate:1.15, advanced:1.30, hell:1.50, doom:1.65, insane:1.85}[v]||1.0;
}

/***** ğŸ”— RG Wallet ê³µí†µ í—ˆë¸Œ ì—°ë™ (í†µí•© í‹°ì¼“/í¬ì¸íŠ¸/í”Œë ˆì´ ìˆ˜) *****/
/**
 * /api/wallet ìŠ¤í™ (ê²Œì„ ê³µí†µ í—ˆë¸Œ)
 * 1) SYNC
 *   POST /api/wallet
 *   { "action": "SYNC", "gameId": "tetris" }
 *   -> { ok, balance, tickets, playCount }
 *
 * 2) ADD_REWARD
 *   POST /api/wallet
 *   {
 *     "action": "ADD_REWARD",
 *     "gameId": "tetris",
 *     "score": number,
 *     "reward": number,       // ì´ë²ˆ ê²Œì„ì—ì„œ ì ë¦½í•  í¬ì¸íŠ¸
 *     "reason": "GAME_CLEAR", // í˜¹ì€ "MISSION_BONUS" ë“±
 *     "meta": { ... }         // tier/level/í´ë¼ì´ì–¸íŠ¸ ë“±
 *   }
 *   -> { ok, balance, tickets, playCount, message? }
 */
const RG_WALLET_ENDPOINT = '/api/wallet';
const RG_GAME_ID         = 'tetris';

async function RG_safeFetch(url, options){
  try{
    const res = await fetch(url, {
      method: (options && options.method) || 'POST',
      headers: {
        'Content-Type':'application/json',
        'Accept':'application/json',
        ...(options && options.headers || {})
      },
      body: options && options.body || undefined,
      credentials: 'include' // ì„¸ì…˜ ë¡œê·¸ì¸ ê¸°ë°˜
    });
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json().catch(()=>null);
    return { ok:true, data };
  }catch(err){
    console.warn('[RG][wallet] fetch error:', err);
    return { ok:false, error:err };
  }
}

/** ì„œë²„ ê¸°ì¤€ ì›”ë › ìƒíƒœë¡œ HUD ë™ê¸°í™” (í¬ì¸íŠ¸/í‹°ì¼“/í”Œë ˆì´ ìˆ˜) */
async function RG_syncWalletHUD(){
  try{
    const result = await RG_safeFetch(RG_WALLET_ENDPOINT, {
      method:'POST',
      body: JSON.stringify({ action:'SYNC', gameId: RG_GAME_ID })
    });
    if(!result.ok || !result.data) return;
    const res = result.data;
    if(res.ok === false) return;

    const cap = 5000;
    if(typeof res.balance === 'number'){
      $('#pointsAmt').textContent = res.balance.toLocaleString('ko-KR');
      $('#pointsBar').style.width = Math.min(100, (res.balance/cap*100)).toFixed(1)+'%';
    }
    if(typeof res.tickets === 'number'){
      $('#ticketsAmt').textContent = res.tickets;
    }
    if(typeof res.playCount === 'number'){
      const m = res.playCount % 10;
      $('#ticketsCap').textContent = m + ' / 10';
      $('#ticketsBar').style.width = ((m/10)*100).toFixed(1)+'%';
      // í•„ìš”í•˜ë‹¤ë©´ 'ì´ë™' ì¹© ë“±ì— í”Œë ˆì´ ìˆ˜ë¥¼ ë§¤í•‘í•˜ëŠ” ê²ƒë„ ê°€ëŠ¥
      // $('#moves').textContent = res.playCount;
    }
  }catch(e){
    console.warn('[RG][wallet] sync HUD failed:', e);
  }
}

/** ê²Œì„ ì¢…ë£Œ ì‹œ ë³´ìƒ ì ë¦½ Helper */
async function RG_addReward(payload){
  try{
    const base = {
      action: 'ADD_REWARD',
      gameId: RG_GAME_ID
    };
    const result = await RG_safeFetch(RG_WALLET_ENDPOINT, {
      method:'POST',
      body: JSON.stringify({ ...base, ...(payload || {}) })
    });
    if(result.ok && result.data){
      const res = result.data;
      const cap = 5000;
      if(typeof res.balance === 'number'){
        $('#pointsAmt').textContent = res.balance.toLocaleString('ko-KR');
        $('#pointsBar').style.width = Math.min(100, (res.balance/cap*100)).toFixed(1)+'%';
      }
      if(typeof res.tickets === 'number'){
        $('#ticketsAmt').textContent = res.tickets;
      }
      if(typeof res.playCount === 'number'){
        const m = res.playCount % 10;
        $('#ticketsCap').textContent = m + ' / 10';
        $('#ticketsBar').style.width = ((m/10)*100).toFixed(1)+'%';
      }
      if(res.message){
        console.log('[RG][wallet] reward message:', res.message);
      }
    }
    return result;
  }catch(e){
    console.warn('[RG][wallet] addReward failed:', e);
    return { ok:false, error:e };
  }
}

/***** Canvas Tetris *****/
(function(){
  const COLS=10, ROWS=22, VISIBLE_ROWS=20;
  const COLORS = { I:'#7ad7ff', O:'#ffe17a', T:'#caa5ff', S:'#92ff9a', Z:'#ff9aa6', J:'#9ab4ff', L:'#ffc38e', G:'#3b466f' };
  const SHAPES = {
    I:[[0,1],[1,1],[2,1],[3,1]], O:[[1,0],[2,0],[1,1],[2,1]], T:[[1,0],[0,1],[1,1],[2,1]],
    S:[[1,0],[2,0],[0,1],[1,1]], Z:[[0,0],[1,0],[1,1],[2,1]], J:[[0,0],[0,1],[1,1],[2,1]], L:[[2,0],[0,1],[1,1],[2,1]]
  };
  const KICKS = [
    [ {x:0,y:0},{x:1,y:0},{x:-1,y:0},{x:0,y:-1} ],
    [ {x:0,y:0},{x:-1,y:0},{x:1,y:0},{x:0,y:-1} ]
  ];
  const bag7 = ()=>{ const pool=['I','O','T','S','Z','J','L']; for(let i=pool.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[pool[i],pool[j]]=[pool[j],pool[i]]} return pool; };

  function levelParams(lv){
    const g = Math.max(30, Math.round(1000 * Math.pow(0.92, lv-1))); // ms per row
    const lock = Math.max(60, 600 - lv*8);
    let garbageSec=null;
    if(lv>=40 && lv<50) garbageSec=10; else if(lv>=50 && lv<80) garbageSec=6; else if(lv>=80) garbageSec=3;
    return {gravity:g,lockDelay:lock,garbageEverySec:garbageSec};
  }

  class Piece{
    constructor(type){ this.type=type; this.blocks=SHAPES[type].map(p=>({x:p[0],y:p[1]})); this.x=3; this.y=0; this.rot=0; }
    clone(){ const p=new Piece(this.type); p.blocks=this.blocks.map(b=>({...b})); p.x=this.x; p.y=this.y; p.rot=this.rot; return p; }
  }

  class Tetris{
    constructor(canvas){
      this.c=canvas; this.ctx=canvas.getContext('2d');
      this.grid=Array.from({length:ROWS},()=>Array(COLS).fill(null));
      this.queue=[]; while(this.queue.length<5){ this.queue.push(...bag7()); }
      this.hold=null; this.holdUsed=false;

      this.score=0; this.lines=0; this.level=1; this.params=levelParams(1);
      this.best= +(localStorage.getItem(LS_KEYS.best)||0);
      this.running=false; this.paused=false;
      this.last=0; this.dropAcc=0; this.lockAcc=0; this.garbageTimer=0;

      /* í¬ì¸íŠ¸ ìƒíƒœ */
      this.points=0; this.combo=0; this.lastB2BEligible=false; this.lastRotate=false; this.usedKick=false;

      /* âœ… ì†Œí”„íŠ¸ë“œë¡­ ìƒíƒœ */
      this.softDrop=false; this.softAcc=0; this.softInterval=0.02;

      this.resize(); this.bindDeck(); this.bindKeys();
      this.spawn(); this.uiSync(); this.updatePointsUI();
      requestAnimationFrame(t=>this.loop(t));
      window.addEventListener('resize',()=>this.resize(),{passive:true});

      /* âœ… ì„¸ì…˜ ì‹œì‘ */
      notifyStart();
    }

    /* ---------- Layout / UI ---------- */
    resize(){
      const wrap=document.getElementById('canvasWrap');
      const d=DPR(); const r=wrap.getBoundingClientRect();
      const targetH=Math.min(r.height, r.width*2); const targetW=targetH/2;
      this.c.style.width=targetW+'px'; this.c.style.height=targetH+'px';
      this.c.width=Math.floor(targetW*d); this.c.height=Math.floor(targetH*d);
      this.cell=Math.floor((this.c.height)/(VISIBLE_ROWS));
      this.offsetX=Math.floor((this.c.width - (COLS*this.cell))/2);
      this.offsetY=Math.floor((this.c.height - (VISIBLE_ROWS*this.cell))/2);
    }
    uiSync(){ $('#score').textContent=this.score; $('#best').textContent=this.best; $('#moves').textContent=this.level; updateTicketUI(); }
    updatePointsUI(){ const cap=5000; $('#pointsAmt').textContent=this.points; $('#pointsBar').style.width=Math.min(100,(this.points/cap*100)).toFixed(1)+'%'; }
    setLevel(lv){ this.level=lv; this.params=levelParams(lv); this.uiSync(); }

    bindDeck(){
      $('#newBtn').addEventListener('click',()=>{ this.running=true; this.paused=false; this.reset(); });
      $('#undoBtn').addEventListener('click',()=>{ if(this.running) this.paused=!this.paused; });
      $('#endBtn').addEventListener('click',()=> showAdThen(()=> this.gameOver()));

      /* HOME: ê´‘ê³  í›„ ë©”ì¸ í—ˆë¸Œ(ë¡œê·¸ì¸ ì´í›„)ë¡œ ì´ë™ (ì ˆëŒ€ê²½ë¡œë¡œ ìˆ˜ì •) */
      $('#homeBtn').addEventListener('click',()=> showAdThen(()=>{ window.location.href = '/user-retro-games.html'; }));

      const tier=$('#tier'), lvl=$('#lvlRange');
      const applyTier=t=>{ let lv={beginner:1,intermediate:11,advanced:21,hell:40,doom:50,insane:100}[t]||1; lvl.value=lv; this.setLevel(lv); };
      tier.addEventListener('change',()=> applyTier(tier.value));
      lvl.addEventListener('input',()=> this.setLevel(+lvl.value));
      applyTier(tier.value);
    }

    bindKeys(){
      let dasTimer=null, arrTimer=null, heldKey=null;
      const moveRepeat=(dir)=>{ if(!this.running||this.paused) return; this.move(dir,0); };
      const startDas=(dir)=>{ if(dasTimer) clearTimeout(dasTimer); if(arrTimer) clearInterval(arrTimer); this.move(dir,0); dasTimer=setTimeout(()=>{ arrTimer=setInterval(()=>moveRepeat(dir), 30); }, 140); };
      const stopDas=()=>{ if(dasTimer) clearTimeout(dasTimer); if(arrTimer) clearInterval(arrTimer); dasTimer=null; arrTimer=null; };

      document.addEventListener('keydown',(e)=>{
        if(e.repeat) return;
        if(e.code==='Enter' || e.code==='KeyN'){ this.running=true; this.paused=false; this.reset(); return; }
        if(e.code==='Space' || e.code==='KeyU'){ if(this.running){ this.paused=!this.paused; e.preventDefault(); } return; }
        if(!this.running||this.paused) return;
        this.lastRotate=false;
        switch(e.code){
          case 'ArrowLeft': heldKey='ArrowLeft'; startDas(-1); break;
          case 'ArrowRight': heldKey='ArrowRight'; startDas(1); break;
          case 'ArrowDown': 
            this.softDrop = true;
            this.move(0,1);
            break;
          case 'ArrowUp': this.hardDrop(); break;
          case 'KeyZ': this.rotate(0); break;
          case 'KeyX': this.rotate(1); break;
          case 'KeyC': this.holdSwap(); break;
        }
      });
      document.addEventListener('keyup',(e)=>{
        if(e.code===heldKey){ stopDas(); heldKey=null; }
        if(e.code==='ArrowDown'){ this.softDrop=false; this.softAcc=0; }
      });
    }

    /* ---------- Core ---------- */
    reset(){
      this.grid=Array.from({length:ROWS},()=>Array(COLS).fill(null));
      this.queue=[]; while(this.queue.length<7){ this.queue.push(...bag7()); }
      this.hold=null; this.holdUsed=false;
      this.score=0; this.lines=0; this.dropAcc=0; this.lockAcc=0; this.garbageTimer=0;
      this.points=0; this.combo=0; this.lastB2BEligible=false;
      this.lastRotate=false; this.usedKick=false;
      this.softDrop=false; this.softAcc=0;
      $('#gameOver').style.display='none';
      this.spawn(); this.uiSync(); this.updatePointsUI();
    }

    spawn(){
      if(this.queue.length<7) this.queue.push(...bag7());
      this.current = new Piece(this.queue.shift());
      this.current.x=3; this.current.y=0; this.holdUsed=false; this.lockAcc=0; this.dropAcc=0;
      if(!this.valid(this.current)){ this.gameOver(); }
    }

    valid(p){
      for(const b of p.blocks){
        const x=p.x+b.x, y=p.y+b.y;
        if(x<0||x>=COLS||y<0||y>=ROWS) return false;
        if(this.grid[y][x]) return false;
      }
      return true;
    }

    rotate(dir){
      if(!this.running||this.paused) return;
      const base = this.current.clone();
      this.usedKick=false;
      for(const blk of this.current.blocks){ const t=blk.x; blk.x = dir? -blk.y : blk.y; blk.y = dir? t : -t; }
      this.current.rot = (this.current.rot + (dir?1:3))%4;
      for(const k of KICKS[dir?0:1]){
        const test=this.current.clone(); test.x+=k.x; test.y+=k.y;
        if(this.valid(test)){ this.current=test; this.usedKick = (k.x!==0||k.y!==0); this.lastRotate=true; return; }
      }
      this.current=base; this.lastRotate=true;
    }

    move(dx,dy){
      const t=this.current.clone(); t.x+=dx; t.y+=dy;
      if(this.valid(t)){ this.current=t; if(dy>0){ this.dropAcc=0; } return true; }
      return false;
    }

    hardDrop(){
      let dropped=0; while(this.move(0,1)) dropped++;
      this.score+=2*dropped;
      this.uiSync();
      this.lock();
    }

    lock(){
      for(const b of this.current.blocks){
        const x=this.current.x+b.x, y=this.current.y+b.y;
        if(y>=0&&y<ROWS) this.grid[y][x]=this.current.type;
      }
      const cleared = this.clearLines();
      this.score += [0,100,300,500,800][cleared] || 0;
      if(this.score>this.best){ this.best=this.score; localStorage.setItem(LS_KEYS.best, String(this.best)); }

      // ---- í¬ì¸íŠ¸ ëª¨ë¸ ----
      const mult = difficultyMult();
      const tInfo = this.detectTSpin(cleared);
      let baseP = 0, eligible=false;

      if(tInfo.is){
        if(tInfo.mini) baseP = 15;
        else if(cleared===1) baseP=30;
        else if(cleared===2) baseP=60;
        else if(cleared>=3) baseP=100;
        eligible = true;
      }else{
        if(cleared===1) baseP=10;
        else if(cleared===2) baseP=25;
        else if(cleared===3) baseP=45;
        else if(cleared===4){ baseP=70; eligible=true; }
      }

      let plus = Math.floor(baseP * mult);
      if(plus>0 && this.lastB2BEligible) plus += Math.floor(20 * mult);
      if(cleared>0){
        this.combo++;
        if(this.combo>=2){
          const comboBase = Math.min(40, this.combo * 4);
          plus += Math.floor(comboBase * mult);
        }
      }else{
        this.combo = 0;
      }
      this.lastB2BEligible = eligible && cleared>0;

      if(plus>0){
        this.points = Math.min(5000, this.points + plus);
        this.updatePointsUI();
      }

      this.uiSync();
      this.spawn();
      this.lastRotate=false; this.usedKick=false;
    }

    clearLines(){
      let removed=0;
      for(let y=ROWS-1;y>=0;y--){
        if(this.grid[y].every(v=>v)){ this.grid.splice(y,1); this.grid.unshift(Array(COLS).fill(null)); removed++; y++; }
      }
      return removed;
    }

    holdSwap(){
      if(this.holdUsed||!this.running||this.paused) return;
      if(this.hold){ const t=this.hold; this.hold=this.current.type; this.current=new Piece(t); this.current.x=3; this.current.y=0; }
      else { this.hold=this.current.type; this.spawn(); }
      this.holdUsed=true; if(!this.valid(this.current)) this.gameOver();
    }

    addGarbageRow(){
      const hole = Math.floor(Math.random()*COLS);
      this.grid.shift();
      const row = Array.from({length:COLS}, (_,x)=> x===hole? null : 'G');
      this.grid.push(row);
      if(!this.valid(this.current)){
        this.current.y-=1; if(!this.valid(this.current)) this.gameOver();
      }
    }

    // --- ê°„ì´ T-Spin íŒì • (êµ¬ë¬¸ ì˜¤ë¥˜ ìˆ˜ì • ì™„ë£Œ) ---
    detectTSpin(linesCleared){
      if(this.current.type!=='T') return {is:false, mini:false};
      if(!this.lastRotate) return {is:false, mini:false};
      const pivot = {x:this.current.x+1, y:this.current.y+1};
      const corners = [
        {x:pivot.x-1,y:pivot.y-1},
        {x:pivot.x+1,y:pivot.y-1},
        {x:pivot.x-1,y:pivot.y+1},
        {x:pivot.x+1,y:pivot.y+1}
      ];
      let occupied=0;
      for(const c of corners){
        if(c.x<0||c.x>=COLS||c.y<0||c.y>=ROWS) { occupied++; continue; }
        if(this.grid[c.y][c.x]) occupied++;
      }
      const is = occupied>=3;
      if(!is) return {is:false, mini:false};
      const mini = (linesCleared<=1) && !this.usedKick;
      return {is:true, mini};
    }

    gameOver(){
      this.running=false; this.paused=false;

      // ê¸°ë¡/í‹°ì¼“ ë¡œì»¬ ì²˜ë¦¬
      addRecord(this.score, this.points);
      addPlay();

      // ğŸ”— ì„œë²„ í†µí•© ì§€ê°‘ì— ë³´ìƒ ì ë¦½ (í¬ì¸íŠ¸/í‹°ì¼“/í”Œë ˆì´ ìˆ˜)
      const finalScore = this.score|0;
      const earnedPoints = this.points|0;

      try{
        RG_addReward({
          score: finalScore,
          reward: earnedPoints,
          reason: 'GAME_CLEAR',
          meta: {
            tier: $('#tier')?.value || 'beginner',
            level: this.level|0,
            client: 'retro-tetris'
          }
        });
      }catch(e){
        console.warn('[RG][wallet] RG_addReward call error:', e);
      }

      const ov=document.getElementById('gameOver'); 
      if(ov) ov.style.display='flex';

      /* âœ… ì„¸ì…˜ ì¢…ë£Œ */
      notifyFinish(this.score|0);
    }

    loop(ts){
      const dt = (ts - (this.last||ts))/1000; this.last=ts;
      if(this.running && !this.paused){
        const gsec = this.params.gravity/1000;
        this.dropAcc += dt;
        this.lockAcc += dt*1000;

        // ê¸°ë³¸ ì¤‘ë ¥ ë‚™í•˜
        if(this.dropAcc >= gsec){
          if(!this.move(0,1)){
            if(this.lockAcc >= this.params.lockDelay){ this.lock(); }
          }else{
            this.lockAcc=0;
          }
          this.dropAcc = 0;
        }

        // âœ… ì†Œí”„íŠ¸ë“œë¡­: â†“ ëˆ„ë¥´ëŠ” ë™ì•ˆ ë¹ ë¥´ê²Œ ì—°ì† í•˜ê°•
        if(this.softDrop){
          this.softAcc += dt;
          while(this.softAcc >= this.softInterval){
            if(!this.move(0,1)){
              break;
            }else{
              this.lockAcc=0;
            }
            this.softAcc -= this.softInterval;
          }
        }

        if(this.params.garbageEverySec){
          this.garbageTimer += dt;
          if(this.garbageTimer >= this.params.garbageEverySec){ this.addGarbageRow(); this.garbageTimer=0; }
        }
      }
      this.draw();
      requestAnimationFrame(t=>this.loop(t));
    }

    draw(){
      const ctx=this.ctx; const cell=this.cell;
      ctx.clearRect(0,0,this.c.width,this.c.height);
      ctx.fillStyle='#000'; ctx.fillRect(0,0,this.c.width,this.c.height);
      ctx.fillStyle='#0c122b'; ctx.fillRect(this.offsetX, this.offsetY, COLS*cell, VISIBLE_ROWS*cell);

      // grid lines
      ctx.save(); ctx.globalAlpha=0.15; ctx.strokeStyle='#6f7cff';
      for(let x=0;x<=COLS;x++){ ctx.beginPath(); ctx.moveTo(this.offsetX+x*cell,this.offsetY); ctx.lineTo(this.offsetX+x*cell,this.offsetY+VISIBLE_ROWS*cell); ctx.stroke(); }
      for(let y=0;y<=VISIBLE_ROWS;y++){ ctx.beginPath(); ctx.moveTo(this.offsetX,this.offsetY+y*cell); ctx.lineTo(this.offsetX+COLS*cell,this.offsetY+y*cell); ctx.stroke(); }
      ctx.restore();

      // placed blocks
      for(let y=2;y<ROWS;y++){
        for(let x=0;x<COLS;x++){
          const t=this.grid[y][x]; if(!t) continue; this.drawCell(x,y-2,t);
        }
      }
      // current piece
      if(this.current){
        for(const b of this.current.blocks){
          const x=this.current.x+b.x, y=this.current.y+b.y;
          if(y>=2) this.drawCell(x,y-2,this.current.type);
        }
      }

      // CRT scanlines
      ctx.globalAlpha=0.12; ctx.fillStyle='#000';
      for(let yy=0; yy<this.c.height; yy+=2){ ctx.fillRect(0,yy,this.c.width,1); }
      ctx.globalAlpha=1;
    }

    drawCell(x,y,type){
      const ctx=this.ctx; const cell=this.cell;
      const px=this.offsetX + x*cell, py=this.offsetY + y*cell;
      const c=COLORS[type]||'#8aa0ff';
      ctx.fillStyle=c; ctx.fillRect(px+1,py+1,cell-2,cell-2);
      ctx.fillStyle='#ffffff40'; ctx.fillRect(px+1,py+1,cell-2,3); ctx.fillRect(px+1,py+1,3,cell-2);
      ctx.fillStyle='#00000040'; ctx.fillRect(px+1,py+cell-4,cell-2,3); ctx.fillRect(px+cell-4,py+1,3,cell-2);
      ctx.fillStyle='#00000030'; ctx.fillRect(px+5,py+5,cell-10,cell-10);
    }
  }

  const game=new Tetris(document.getElementById('game'));
  updateTicketUI();
  // âœ… í˜ì´ì§€ ì§„ì… ì‹œ ì„œë²„ ê¸°ì¤€ í†µí•© ì§€ê°‘ ìƒíƒœ ë™ê¸°í™”
  RG_syncWalletHUD();
})();

/***** Cabinet fit (debounced) *****/
function fitCabinet(){
  const cab = document.querySelector('.cabinet'); if(!cab) return;
  const margin = 16;
  cab.style.transform='none';
  const w=cab.offsetWidth, h=cab.offsetHeight;
  const scale = Math.min(1, (window.innerWidth - margin*2)/w, (window.innerHeight - margin*2)/h);
  cab.style.transform = 'scale('+scale+')';
}
window.addEventListener('resize', ()=>requestAnimationFrame(fitCabinet), {passive:true});
window.addEventListener('orientationchange', ()=>requestAnimationFrame(fitCabinet), {passive:true});
setTimeout(fitCabinet, 0);

/***** Records Modal bindings *****/
document.getElementById('recordsBtn').addEventListener('click',showRecords);
document.getElementById('recClose').addEventListener('click',()=>$('#recModal').style.display='none');
document.getElementById('recModal').addEventListener('click',e=>{ if(e.target.id==='recModal') $('#recModal').style.display='none'; });

/***** âœ… ì„¸ì…˜ í›…: ESM ì—†ì´ ì•ˆì „ í˜¸ì¶œ *****/
function notifyStart(){ try{ if (typeof window.gameStart === 'function') window.gameStart('tetris'); }catch(e){} }
function notifyFinish(finalScore){ try{ if (typeof window.gameFinish === 'function') window.gameFinish('tetris', finalScore|0); }catch(e){} }

/***** ê°€ì‹œì„± í›…: íƒ­ ì´íƒˆ ì‹œ ì¼ì‹œì •ì§€ ë“± ì—°ê²° ì§€ì  *****/
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    // í•„ìš” ì‹œ ì¶”ê°€ ë¡œê¹…/ê¸°ë¡ ì²˜ë¦¬
  }
});
</script>

  <div id="cookieBanner" class="cookie-banner" role="dialog" aria-live="polite" aria-label="Analytics consent">
    <div>ì„œë¹„ìŠ¤ í’ˆì§ˆ í–¥ìƒì„ ìœ„í•œ ë¶„ì„(ì¿ í‚¤) ì‚¬ìš©ì— ë™ì˜í•˜ì‹œë‚˜ìš”?</div>
    <div class="spacer"></div>
    <button class="deny" type="button">ê±°ë¶€</button>
    <button class="agree" type="button">ë™ì˜</button>
  </div>


  <script>
  (function(){
    try{
      var KEY='rg_analytics_consent';
      function init(){ if(typeof window.analyticsInit==='function') window.analyticsInit(); }
      var v=null; try{ v=localStorage.getItem(KEY); }catch(e){}
      var el=document.getElementById('cookieBanner');
      if(v==='yes'){ init(); if(el) el.style.display='none'; return; }
      if(!el){ return; } // no banner -> do not init
      el.style.display='flex';
      var agree=el.querySelector('.agree'), deny=el.querySelector('.deny');
      if(agree) agree.addEventListener('click', function(){
        try{ localStorage.setItem(KEY,'yes'); }catch(e){}
        el.style.display='none'; init();
      });
      if(deny) deny.addEventListener('click', function(){
        try{ localStorage.setItem(KEY,'no'); }catch(e){}
        el.style.display='none';
      });
    }catch(e){ /* no-op */ }
  })();
  </script>

  
  <div id="site-footer"></div>
</body>
</html>
