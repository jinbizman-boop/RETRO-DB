<!DOCTYPE html>
<html lang="ko" data-env="production" data-analytics="on">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>RETRO GAMES ‚Äì BRICK MATCH</title>

<!-- === Common SEO/A11y (auto-inserted) === -->
<link rel="icon" href="/assets/favicon.ico">
<link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/icon-180.png">
<link rel="manifest" href="/site.webmanifest">
<meta name="theme-color" content="#0e1b34">
<meta name="description" content="RETRO MATCH-3 ‚Äì Arcade Cabinet (Fixed) | Î†àÌä∏Î°ú Í∞êÏÑ± ÎØ∏ÎãàÍ≤åÏûÑÏùÑ Ï¶êÍ∏∞Îäî RETRO GAMES">
<meta name="robots" content="index,follow">
<meta property="og:site_name" content="RETRO GAMES">
<meta property="og:title" content="RETRO MATCH-3 ‚Äì Arcade Cabinet (Fixed)">
<meta property="og:description" content="RETRO MATCH-3 ‚Äì Arcade Cabinet (Fixed) | Î†àÌä∏Î°ú Í∞êÏÑ± ÎØ∏ÎãàÍ≤åÏûÑÏùÑ Ï¶êÍ∏∞Îäî RETRO GAMES">
<meta property="og:type" content="website">
<meta property="og:image" content="/assets/og/retro-games-card.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="RETRO MATCH-3 ‚Äì Arcade Cabinet (Fixed)">
<meta name="twitter:description" content="RETRO MATCH-3 ‚Äì Arcade Cabinet (Fixed) | Î†àÌä∏Î°ú Í∞êÏÑ± ÎØ∏ÎãàÍ≤åÏûÑÏùÑ Ï¶êÍ∏∞Îäî RETRO GAMES">
<meta name="twitter:image" content="/assets/og/retro-games-card.png">
<script>
  // fixed environment flags for analytics/runtime
  (function(d){
    d.documentElement.dataset.env = 'production';
    d.documentElement.dataset.analytics = 'on';
    window.__ENV__ = 'production';
    window.__ANALYTICS_ON__ = true;
  })(document);
</script>
<!-- === /Common SEO/A11y === -->

<!-- AdSense Ïä§ÎãàÌé´: ÏöîÏ≤≠Í∞í Í∑∏ÎåÄÎ°ú -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6713974265397310" crossorigin="anonymous"></script>

<style>
  :root{
    --cabinet:#071933; --cabinet2:#0b2a57; --bezel:#0c1e3f; --glow:#0ea5ff; --side:#f4be09;
    --btn:#133262; --btnBorder:#285dd1; --btnFg:#e9f1ff;
    --board:#121a2f; --tile0:#e9eef6; --ink:#111;
    --t2:#e7f4ff; --t4:#d6eaff; --t8:#ffe7c2; --t16:#ffd6a6; --t32:#ffc8a6; --t64:#ffb79c;
    --t128:#fff3a8; --t256:#fff09a; --t512:#ffeb8a; --t1024:#eaff9c; --t2048:#caffb0; --t4096:#b6ffd2; --t8192:#b2fff0;
  }
  *{box-sizing:border-box}
  html,body{
    height:100%;margin:0;color:#fff;font-family:'Pretendard',ui-sans-serif,system-ui,"Segoe UI",Roboto,"Apple SD Gothic Neo";overflow:hidden;
    background:#0b001e radial-gradient(circle at 40% -10%, #320076, #0b001e 70%) no-repeat;background-size:cover;
  }
  #fx{position:fixed;inset:0;pointer-events:none;z-index:0;opacity:.75}
  .shell{min-height:100vh;display:grid;place-items:center;padding:20px;position:relative;z-index:1;padding-bottom:calc(20px + env(safe-area-inset-bottom,0))}
  .cabinet{position:relative;width:min(1200px,96vw);background:#0e1b34;border-radius:18px;box-shadow:0 12px 40px rgba(0,0,0,.65),inset 0 0 0 2px #0a1a33;transform-origin:top center}
  .cabinet:before,.cabinet:after{content:"";position:absolute;top:12px;bottom:12px;width:18px;filter:drop-shadow(0 0 12px rgba(255,190,0,.55));background:linear-gradient(180deg,#ffd34a,#f0b400 60%,#d99a00)}
  .cabinet:before{left:12px;border-radius:9px}
  .cabinet:after{right:12px;border-radius:9px}
  .marquee{padding:18px;border-radius:18px 18px 0 0;border-bottom:1px solid #0c2b59;box-shadow:inset 0 -6px 26px rgba(0,0,0,.35);background:linear-gradient(180deg,#173763,#0b2548)}
  .title{display:flex;align-items:center;justify-content:center;gap:12px;flex-wrap:wrap}
  .title h1{margin:0;font-weight:900;letter-spacing:2px;color:#eaf3ff;text-shadow:0 0 12px rgba(62,142,255,.55);font-size:clamp(18px,4.4vw,28px)}
  .subtitle{opacity:.75;letter-spacing:.2em;text-align:center;font-size:clamp(10px,2.7vw,12px)}
  .hud{display:flex;gap:12px;padding:12px;justify-content:center;flex-wrap:wrap}
  .chip,.pill,.hud .btnMini{position:relative;min-width:128px;height:46px;padding:0 16px;border-radius:14px;border:1px solid #1e63ff;color:#fff;font-weight:900;display:inline-flex;align-items:center;justify-content:center;letter-spacing:.3px;box-shadow:0 12px 18px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.5), inset 0 -8px 14px rgba(0,0,0,.28);background:linear-gradient(180deg,#8fe0ff 0%,#49a8ff 26%,#2f84ff 58%,#1560f2 100%),radial-gradient(140% 120% at 20% -40%,rgba(255,255,255,.65),rgba(255,255,255,0) 55%)}
  .chip b{color:#fff;font-weight:900;padding-left:6px;text-shadow:0 1px 0 rgba(0,0,0,.25)}
  .pill{min-width:260px;gap:12px}
  .pill .icon{width:28px;height:28px;display:grid;place-items:center;border-radius:50%;color:#0b2a57;box-shadow:inset 0 -4px 8px rgba(0,0,0,.25), 0 0 10px rgba(255,255,255,.65);background:radial-gradient(circle at 30% 30%,#ffffff,#d8f1ff)}
  .points .bar,.tickets .bar{height:8px;border-radius:999px;background:#1a2548;overflow:hidden;border:1px solid #2b3f8f;width:120px}
  .points .bar>span,.tickets .bar>span{display:block;height:100%;width:0%;box-shadow:0 0 10px #8ad7ff;background:linear-gradient(90deg,#b86cff,#6af0ff)}
  .points .nums,.tickets .nums{display:flex;align-items:baseline;gap:8px;font-weight:900}
  .points .nums .big,.tickets .nums .big{font-size:18px;color:#ffe9a3;text-shadow:0 0 8px #ffd86a}
  .points .nums .cap,.tickets .nums .cap{opacity:.8;font-size:12px}
  .play{position:relative;margin:10px 18px;border-radius:16px;box-shadow:inset 0 0 0 1px #0b2a57,inset 0 0 60px rgba(0,0,0,.65);background:linear-gradient(180deg,#0a1530,#031125)}
  .screen{aspect-ratio:16/9;display:grid;place-items:center;padding:18px}
  .bezel{width:100%;height:100%;border-radius:14px;box-shadow:inset 0 0 0 1px #132a59,inset 0 0 60px rgba(0,0,0,.65);display:grid;place-items:center;position:relative;overflow:hidden;background:radial-gradient(120% 200% at 50% -60%,rgba(255,255,255,.07),rgba(255,255,255,0) 40%),linear-gradient(180deg,#0a1c39,#0a1326)}
  .canvasWrap{width:min(92%,980px);max-height:85%;display:grid;place-items:center}
  canvas#game{display:block;max-width:100%;max-height:100%;width:100%;height:100%;background:#000;border-radius:18px;border:1px solid #1b2b45;box-shadow:inset 0 0 40px rgba(0,0,0,.25)}
  .overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(5,0,20,.55);backdrop-filter:blur(2px);z-index:5}
  .overlay .msg{font-weight:900;letter-spacing:.2em;text-align:center;filter:drop-shadow(0 6px 20px rgba(0,0,0,.6));font-size:clamp(28px,5vw,68px);color:#ffe166;text-shadow:0 0 16px rgba(255,225,102,.45),0 0 40px rgba(14,165,255,.25)}
  .overlay .sub{margin-top:10px;font-size:clamp(12px,2.2vw,16px);opacity:.9;color:#dfe9ff;text-align:center}
  .deck{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;padding:14px 18px 22px;border-top:1px solid #0a2b57;background:linear-gradient(180deg,#0b1f40,#0a1730)}
  .deck .btn,.deck select,.deck input[type=range]{font-weight:900;color:#dff1ff;border:1px solid #224aa8;border-radius:12px;padding:10px 14px;box-shadow:0 10px 18px rgba(0,0,0,.45),inset 0 0 18px rgba(255,255,255,.05);cursor:pointer;background:linear-gradient(180deg,#1b3a7a,#102a66)}
  .deck .btn:hover,.deck select:hover{filter:brightness(1.06)}
  .deck label{display:flex;align-items:center;gap:8px}
  .deck input[type=range]{width:140px;height:12px;accent-color:#5fb0ff}
  #recModal{display:none;position:fixed;inset:0;background:rgba(5,0,20,.55);backdrop-filter:blur(4px);align-items:center;justify-content:center;z-index:999}
  @media (max-width: 980px){
    .shell{padding:12px;padding-bottom:calc(12px + env(safe-area-inset-bottom,0))}
    .cabinet{width:100vw;border-radius:0}
    .marquee{padding:12px;border-radius:0}
    .play{margin:8px 12px}
    .screen{padding:10px}
    .hud{gap:8px;padding:10px}
    .chip,.pill,.hud .btnMini{min-width:112px;height:42px;padding:0 12px}
    .pill{min-width:220px}
    .deck{gap:8px;padding:10px 12px 16px}
    .deck .btn,.deck select,.deck input[type=range]{padding:10px 12px}
  }
  @media (max-width: 640px){
    .chip,.pill,.hud .btnMini{height:40px}
    .points .bar,.tickets .bar{width:96px}
    .deck{justify-content:flex-start;overflow:auto;-webkit-overflow-scrolling:touch}
    .deck>*{flex:0 0 auto}
  }

  .cookie-banner{position:fixed;left:12px;right:12px;bottom:12px;
    display:none;align-items:center;gap:10px;padding:10px 12px;border-radius:12px;
    border:1px solid #2b3f8f;background:linear-gradient(180deg,#0b1f40,#0a1730);
    box-shadow:0 10px 18px rgba(0,0,0,.45),inset 0 0 18px rgba(255,255,255,.05);
    z-index:10000;font-size:12px}
  .cookie-banner .spacer{flex:1}
  .cookie-banner button{padding:8px 12px;border-radius:10px;border:1px solid #2d3690;
    background:linear-gradient(180deg,#1a2b7a,#0a1a64);font-weight:800;color:#e9f0ff;cursor:pointer}
  .cookie-banner .agree{background:linear-gradient(180deg,#ffdf6e,#ffb84d);color:#3a2400;border-color:#7a5600}

  /* ==============================
     ‚úÖ AdSense Ï¢å/Ïö∞ Î∞∞ÎÑà (Ï∫êÎπÑÎãõ Ï¢åÏö∞Ïóê Îî± Î∂ôÍ≤å)
     - Í≤åÏûÑ UI/UX(Ï∫êÎπÑÎãõ/Ï∫îÎ≤ÑÏä§/Îç±)ÏóêÎäî ÏòÅÌñ• 0
     - ÌôîÎ©¥Ïóê fixed overlayÎ°úÎßå Î∞∞Ïπò
  ============================== */
  :root{
    --rg-cabW: min(1200px,96vw); /* .cabinet widthÏôÄ ÎèôÏùº */
    --rg-adW: 160px;
    --rg-adGap: 16px;
  }
  .sideAd{
    position: fixed;
    top: 50%;
    transform: translateY(-50%);
    width: var(--rg-adW);
    min-height: 600px;
    z-index: 120;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: auto;
  }
  .sideAd.left{
    left: calc(50% - (var(--rg-cabW) * 0.5) - var(--rg-adW) - var(--rg-adGap));
  }
  .sideAd.right{
    right: calc(50% - (var(--rg-cabW) * 0.5) - var(--rg-adW) - var(--rg-adGap));
  }
  .sideAdInner{
    width: 100%;
    min-height: 600px;
    border-radius: 16px;
    border: 1px solid #2b3f8f;
    background: linear-gradient(180deg,#0b1f40,#050814);
    box-shadow: 0 10px 24px rgba(0,0,0,.65), inset 0 0 18px rgba(62,142,255,.35);
    overflow: hidden;
  }
  .sideAd ins.adsbygoogle{
    display: block;
    width: 100%;
    height: 100%;
  }
  /* Î™®Î∞îÏùº/Ï¢ÅÏùÄ ÌôîÎ©¥ÏóêÏÑúÎäî Í≤åÏûÑ ÌôîÎ©¥ Î≥¥Ìò∏ (UI/UX Ïú†ÏßÄ) */
  @media (max-width: 1100px){
    .sideAd{ display:none; }
  }
</style>
</head>

<script defer src="/assets/js/app.js"></script>
<script defer src="/assets/js/analytics.js"></script>

<body>
  <div id="site-header"></div>
  <canvas id="fx"></canvas>

  <!-- ‚úÖ Ï¢å/Ïö∞ AdSense Î∞∞ÎÑà: Ï∫êÎπÑÎãõ(Í≤åÏûÑÍ∏∞) Ï¢åÏö∞ Í≥†Ï†ï (UI/UX/ÌîåÎ†àÏù¥ Î°úÏßÅ Î¨¥ÏÜêÏÉÅ) -->
  <aside class="sideAd left" aria-label="left ad">
    <div class="sideAdInner">
      <ins class="adsbygoogle"
        data-ad-client="ca-pub-6713974265397310"
        data-ad-slot="4514999077"
        data-ad-format="auto"
        data-full-width-responsive="true"></ins>
    </div>
  </aside>

  <aside class="sideAd right" aria-label="right ad">
    <div class="sideAdInner">
      <ins class="adsbygoogle"
        data-ad-client="ca-pub-6713974265397310"
        data-ad-slot="4514999077"
        data-ad-format="auto"
        data-full-width-responsive="true"></ins>
    </div>
  </aside>

  <script>
    // ‚úÖ Î∞∞ÎÑà Í¥ëÍ≥† Ï¥àÍ∏∞Ìôî (Î°úÎçîÎäî headÏóêÏÑú async Î°úÎìúÎê®)
    try { (window.adsbygoogle = window.adsbygoogle || []).push({}); } catch(e){}
    try { (window.adsbygoogle = window.adsbygoogle || []).push({}); } catch(e){}
  </script>

  <div class="shell">
    <section class="cabinet" aria-label="retro arcade cabinet">
      <header class="marquee">
        <div class="title">
          <h1>RETRO BRICK MATCH</h1>
          <div class="subtitle">SWIPE ¬∑ ARROWS ¬∑ WASD</div>
        </div>
      </header>

      <!-- HUD -->
      <div class="hud">
        <div class="chip">SCORE <b id="score">0</b></div>
        <div class="chip">BEST <b id="best">0</b></div>
        <div class="chip">MOVES <b id="moves">0</b></div>

        <div class="pill points" aria-label="ÏÇ¨Ïö©Ïûê Ìè¨Ïù∏Ìä∏">
          <div class="icon">üèÖ</div>
          <div>
            <div class="nums"><span class="big" id="pointsAmt">0</span><span class="cap">/ <span id="pointsCap">5,000</span></span></div>
            <div class="bar"><span id="pointsBar"></span></div>
          </div>
        </div>

        <div class="pill tickets" aria-label="Ìã∞Ïºì ÏßÑÌñâ">
          <div class="icon">üéüÔ∏è</div>
          <div>
            <div class="nums"><span class="big" id="ticketsAmt">0</span><span class="cap">TICKET</span></div>
            <div class="bar"><span id="ticketsBar"></span></div>
          </div>
          <div class="playCount" id="ticketsCap">0 / 10</div>
        </div>

        <button class="btnMini" id="recordsBtn" aria-label="Game rules">GAME RULE</button>
      </div>

      <main class="play">
        <div class="screen">
          <div class="bezel">
            <div class="canvasWrap" id="canvasWrap">
              <canvas id="game"></canvas>
            </div>
            <div id="gameOver" class="overlay" aria-live="polite" role="alert">
              <div>
                <div class="msg">GAME OVER</div>
                <div class="sub">N/Enter: NEW GAME ¬∑ Space/U: Pause/Resume</div>
              </div>
            </div>
          </div>
        </div>
      </main>

      <!-- Control deck -->
      <div class="deck">
        <button class="btn" id="homeBtn">HOME</button>
        <button class="btn" id="newBtn">NEW GAME (N)</button>
        <button class="btn" id="undoBtn">RETURN (U)</button>
        <label>MODE
          <select id="tier">
            <option value="beginner">Beginner (1‚Äì10)</option>
            <option value="intermediate">Intermediate (11‚Äì20)</option>
            <option value="advanced">High quality (21‚Äì30)</option>
            <option value="hell">Hell (40)</option>
            <option value="doom">Ruin (50)</option>
            <option value="insane">Heinous crime (100)</option>
          </select>
        </label>
        <label>LEVEL <input id="lvlRange" type="range" min="1" max="100" value="1" step="1"></label>
        <label>BOARD
          <select id="sizeSel" disabled>
            <option value="12" selected>Fixation</option>
          </select>
        </label>
        <button class="btn" id="endBtn">GAME OVER</button>
      </div>
    </section>
  </div>

  <!-- Game Rule Modal -->
  <div id="recModal">
    <div style="width:min(720px,94vw);background:radial-gradient(circle at 50% -60%,#1f0d48,#0c0626 70%);border:2px solid #3e2b7b;border-radius:20px;box-shadow:0 30px 60px #000a,inset 0 0 24px #2a0085;padding:22px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3 style="margin:0;color:#ffdf6e">GAME RULE</h3>
        <button id="recClose" style="border:0;background:transparent;color:#fff;font-size:22px;cursor:pointer" aria-label="Close">√ó</button>
      </div>

      <div id="recBody" style="max-height:60vh;overflow:auto;border:1px solid #2a3a89;border-radius:12px;padding:14px">
        <div style="color:rgba(234,243,255,.78);font-size:13px;line-height:1.65">

          <div style="margin-bottom:12px;padding:10px 12px;border-radius:12px;background:rgba(0,0,0,.18);border:1px solid rgba(255,255,255,.10)">
            RETRO Brick Breaker is an arcade action game. Bounce the ball with your paddle, break all bricks, and survive as long as possible.
          </div>

          <h4 style="margin:12px 0 6px;color:#eaf3ff;font-size:13px">Controls</h4>
          <ul style="margin:6px 0 0;padding-left:18px">
            <li>Mouse / Touch: Move the paddle left and right</li>
            <li>Keyboard: Arrow Keys (left/right) for paddle movement</li>
            <li>New Game: N ¬∑ Pause/Resume: U (or Space) ¬∑ Restart: Enter</li>
          </ul>

          <h4 style="margin:12px 0 6px;color:#eaf3ff;font-size:13px">Scoring</h4>
          <ul style="margin:6px 0 0;padding-left:18px">
            <li>Breaking bricks increases your score (combo boosts points).</li>
            <li>Power-ups can help you clear faster (some may be risky).</li>
            <li>Your <b>Best</b> score is saved locally in your browser.</li>
          </ul>

          <h4 style="margin:12px 0 6px;color:#eaf3ff;font-size:13px">Tips</h4>
          <ul style="margin:6px 0 0;padding-left:18px">
            <li>Hit the ball with the paddle edge to change the bounce angle.</li>
            <li>Prioritize clearing pathways to reach deeper bricks.</li>
            <li>Save your lives‚Äîavoid letting the ball drop.</li>
            <li>Use Pause if you need a break (especially on higher levels).</li>
          </ul>

          <h4 style="margin:12px 0 6px;color:#eaf3ff;font-size:13px">Version</h4>
          <p style="margin:6px 0">RETRO GAMES ‚Ä¢ Web Mini Games ‚Ä¢ v1.0</p>

          <h4 style="margin:12px 0 6px;color:#eaf3ff;font-size:13px">Contact</h4>
          <p style="margin:6px 0">
            Business / support: <a href="mailto:jinbizman@gmail.com" style="color:rgba(255,223,110,.95);text-decoration:none;border-bottom:1px dotted rgba(255,223,110,.55)">jinbizman@gmail.com</a>
          </p>

          <div style="margin-top:12px;font-size:12px;color:rgba(234,243,255,.72);border-left:3px solid rgba(255,223,110,.55);padding:10px 12px;background:rgba(0,0,0,.18);border-radius:12px">
            Ads may be served by Google AdSense. Depending on your region and browser settings,
            ads may be personalized or shown in a non-personalized form.
          </div>

        </div>
      </div>
    </div>
  </div>

<script>

/***** Neon FX (background stars) *****/
(function(){
  const c=document.getElementById('fx'); if(!c) return;
  const g=c.getContext('2d');
  function fit(){ const d=window.devicePixelRatio||1; c.width=innerWidth*d; c.height=innerHeight*d; g.setTransform(d,0,0,d,0,0); }
  fit(); addEventListener('resize',fit,{passive:true});
  const N=80;
  const pts=new Array(N).fill(0).map(()=>({x:Math.random()*innerWidth,y:Math.random()*innerHeight*0.9,r:Math.random()*2+0.5,s:Math.random()*0.6+0.2,ph:Math.random()*6.283}));
  function loop(t){
    g.clearRect(0,0,c.width,c.height);
    for(const p of pts){
      g.beginPath(); g.arc(p.x,p.y,p.r,0,Math.PI*2);
      const a=0.3+Math.sin(t*0.002+p.ph)*0.25; g.fillStyle='rgba(43,123,255,'+a+')'; g.fill();
      p.y+=p.s; if(p.y>innerHeight){ p.y=-10; p.x=Math.random()*innerWidth; }
    }
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);
})();

/***** Helpers & Storage *****/
const $=sel=>document.querySelector(sel);
const DPR=()=>Math.min(2, window.devicePixelRatio||1);
const clamp=(n,a,b)=>Math.max(a, Math.min(b,n));
const fmt=n=>n.toLocaleString('ko-KR');

/* Match-3 Ï†ÑÏö© ÌÇ§ */
const LS_KEYS={plays:'plays_match',tickets:'tickets_match',records:'records_match',best:'best_match'};

function loadJSON(k,def){try{const v=localStorage.getItem(k); return v? JSON.parse(v): def;}catch(e){ return def; }}
function saveJSON(k,v){localStorage.setItem(k, JSON.stringify(v));}
function updateTicketUI(){
  const plays= +localStorage.getItem(LS_KEYS.plays)||0;
  const tickets= +localStorage.getItem(LS_KEYS.tickets)||0;
  $('#ticketsAmt').textContent=tickets;
  $('#ticketsCap').textContent=(plays%10)+' / 10';
  $('#ticketsBar').style.width = (((plays%10)/10*100).toFixed(1))+'%';
}
function addPlay(){
  let plays= +localStorage.getItem(LS_KEYS.plays)||0; plays++;
  let tickets= +localStorage.getItem(LS_KEYS.tickets)||0;
  if(plays%10===0) tickets++;
  localStorage.setItem(LS_KEYS.plays, String(plays));
  localStorage.setItem(LS_KEYS.tickets, String(tickets));
  updateTicketUI();
}
function addRecord(score, points){
  const recs=loadJSON(LS_KEYS.records,[]); const now=new Date();
  recs.unshift({ts:now.toISOString(), score, points});
  saveJSON(LS_KEYS.records,recs.slice(0,200));
}
function openGameRule(){
  $('#recModal').style.display='flex';
}
document.getElementById('recordsBtn').addEventListener('click', openGameRule);

function closeGameRule(){
  $('#recModal').style.display='none';
}
document.getElementById('recClose').addEventListener('click', closeGameRule);

document.getElementById('recModal').addEventListener('click', e=>{
  if(e.target && e.target.id === 'recModal') closeGameRule();
});

window.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape' && document.getElementById('recModal').style.display === 'flex') closeGameRule();
});

/***** ÎÇúÏù¥ÎèÑ Î∞∞Ïú® *****/
function difficultyMult(){
  const v=$('#tier')?.value||'beginner';
  return {beginner:1.00, intermediate:1.15, advanced:1.30, hell:1.50, doom:1.65, insane:1.85}[v]||1.0;
}

/***** Match-3 Game (ÏõêÎ≥∏ Ïú†ÏßÄ + Ï¢åÌëú Îß§Ìïë ÌîΩÏä§) *****/
(function(){
  const EMPTY=0, NORMAL=1, ROCK=2, ICE=3, STRIPE_H=4, STRIPE_V=5, BOMB=6, RAINBOW=7;

  function paramsForLevel(lv){
    const colors = lv<8?5: lv<15?6: lv<25?7: lv<40?7: lv<50?8: 8;
    const timeLimit = lv<10? 70: lv<20? 60: lv<30? 55: lv<40? 45: lv<50? 40: lv<80?35: 28;
    const rockRate = lv>=20? (lv<40?0.03: lv<50?0.05: lv<80?0.07: 0.10): 0;
    const iceRate = lv>=15? (lv<40?0.05: lv<50?0.08: lv<80?0.10: 0.12): 0;
    const bombRate = lv>=40? (lv<50?0.04: lv<80?0.06: 0.08): 0;
    const goalScore = 800 + lv*25;
    return { colors, timeLimit, rockRate, iceRate, bombRate, goalScore, shuffleOnStall:true };
  }

  class Match3{
    constructor(canvas){
      this.c=canvas; this.ctx=canvas.getContext('2d');
      this.N=8; this.level=1; this.params=paramsForLevel(1);
      this.state='idle'; this.score=0; this.best= +(localStorage.getItem(LS_KEYS.best)||0);
      this.timeLeft=60; this.grid=[]; this.sel=null; this.paused=false;
      this.combo=1; this.points=0; this.chainLv=0; this.goalAwarded=false;
      this.swapAnim=null; this.fx=[]; this.last=0; this.ox=0; this.oy=0; this.step=0;

      this.resize(); this.bind(); this.newGame(1);
      requestAnimationFrame((t)=>this.run(t));
      notifyStart();
    }

    DPR(){ return Math.min(2, window.devicePixelRatio||1); }
    rnd(n){ return Math.floor(Math.random()*n); }
    btype(v){ return Math.floor(v/10)===0? NORMAL: Math.floor(v/10); }
    bval(v){ return Math.floor(v/10)===0? v: v%10; }
    inBounds(x,y){ return x>=0&&x<this.N&&y>=0&&y<this.N; }

    bind(){
      // ‚úÖ transform(scale)Í≥º DPRÏùÑ Î™®Îëê Î¨¥ÏãúÌïòÍ≥†, ÌôîÎ©¥Ïóê Î≥¥Ïù¥Îäî Ïã§Ï†ú ÌÅ¨Í∏∞Îßå ÏÇ¨Ïö©
      const map = (ev)=>{
        const r=this.c.getBoundingClientRect();
        const side=Math.min(r.width, r.height);
        const left=r.left+(r.width - side)/2;
        const top =r.top +(r.height- side)/2;
        const x=ev.clientX-left, y=ev.clientY-top; // ÌòÑÏû¨ ÌôîÎ©¥Ï¢åÌëú(Ïä§ÏºÄÏùº Î∞òÏòÅÎê®)
        return {x,y,side};
      };
      let down=false,sx=0,sy=0;

      this.c.addEventListener('mousedown',(e)=>{
        if(this.paused||this.state==='over'||this.swapAnim) return;
        down=true; const p=map(e);
        if(p.x<0||p.y<0||p.x>p.side||p.y>p.side) return;
        // ‚úÖ ÎπÑÏú® Í∏∞Î∞ò Ïù∏Îç±Ïã± (DPR/Ïä§ÏºÄÏùº Î¨¥Í¥Ä)
        this.select(Math.floor((p.x/p.side)*this.N), Math.floor((p.y/p.side)*this.N));
        sx=p.x; sy=p.y;
      });
      window.addEventListener('mouseup',()=> down=false,{passive:true});
      this.c.addEventListener('mousemove',(e)=>{
        if(!down||!this.sel||this.swapAnim) return;
        const p=map(e); const dx=p.x-sx, dy=p.y-sy; let dir=null;
        if(Math.abs(dx)>Math.abs(dy) && Math.abs(dx)>10) dir= dx>0?'r':'l';
        else if(Math.abs(dy)>10) dir= dy>0?'d':'u';
        if(dir){ this.trySwap(dir); down=false; }
      });

      this.c.addEventListener('touchstart',(e)=>{
        if(this.paused||this.state==='over'||this.swapAnim) return;
        const t=e.touches[0]; const p=map(t);
        if(p.x<0||p.y<0||p.x>p.side||p.y>p.side) return;
        // ‚úÖ ÎπÑÏú® Í∏∞Î∞ò Ïù∏Îç±Ïã±
        this.select(Math.floor((p.x/p.side)*this.N), Math.floor((p.y/p.side)*this.N));
        sx=p.x; sy=p.y;
      },{passive:true});
      this.c.addEventListener('touchmove',(e)=>{
        if(!this.sel||this.swapAnim) return; const t=e.touches[0]; const p=map(t);
        const dx=p.x-sx, dy=p.y-sy; let dir=null;
        if(Math.abs(dx)>Math.abs(dy) && Math.abs(dx)>12) dir= dx>0?'r':'l';
        else if(Math.abs(dy)>12) dir= dy>0?'d':'u';
        if(dir){ this.trySwap(dir); }
      },{passive:true});

      // Deck / Keys
      document.getElementById('newBtn').addEventListener('click',()=> this.newGame(this.level));
      document.getElementById('undoBtn').addEventListener('click',()=>{ if(this.state!=='over') this.paused=!this.paused; });
      document.getElementById('endBtn').addEventListener('click',()=>{ window.location.href = '/index.html'; });
      document.getElementById('homeBtn').addEventListener('click',()=>{ window.location.href = '/index.html'; });

      const tier=$('#tier'), lvl=$('#lvlRange');
      const applyTier=(t)=>{ let lv={beginner:1,intermediate:11,advanced:21,hell:40,doom:50,insane:100}[t]||1; lvl.value=lv; this.setLevel(lv); };
      tier.addEventListener('change',()=> applyTier(tier.value));
      lvl.addEventListener('input',()=> this.setLevel(+lvl.value));

      document.addEventListener('keydown',(e)=>{
        if(e.code==='Enter' || e.code==='KeyN'){ this.newGame(this.level); }
        if(e.code==='Space' || e.code==='KeyU'){ if(this.state!=='over'){ this.paused=!this.paused; e.preventDefault(); } }
      });

      window.addEventListener('resize',()=> this.resize(),{passive:true});
    }

    /* Ï∫îÎ≤ÑÏä§ ÌÅ¨Í∏∞ Í≥ÑÏÇ∞ */
    resize(){
      const wrap=document.getElementById('canvasWrap');
      const d=this.DPR();
      const r=wrap.getBoundingClientRect();
      const side=Math.floor(Math.min(r.width, r.height));
      this.c.style.width = side+'px';
      this.c.style.height= side+'px';
      this.c.width = Math.floor(side*d);
      this.c.height= Math.floor(side*d);
      const s=Math.min(this.c.width,this.c.height);
      this.step=s/this.N; this.ox=(this.c.width - s)/2; this.oy=(this.c.height- s)/2;
    }

    setLevel(lv){ this.level=lv; this.params=paramsForLevel(lv); this.updateHUD(); }

    updateHUD(){
      $('#score').textContent=this.score|0;
      if(this.score>this.best){ this.best=this.score|0; localStorage.setItem(LS_KEYS.best, String(this.best)); }
      $('#best').textContent=this.best|0;
      $('#moves').textContent=(Math.max(0,this.level-1))|0;
      $('#pointsAmt').textContent=fmt(this.points|0);
      const cap=5000; $('#pointsBar').style.width=Math.min(100,(this.points/cap*100)).toFixed(1)+'%';
      updateTicketUI();
    }

    newGame(lv){
      this.level=lv; this.params=paramsForLevel(lv);
      this.score=0; this.combo=1; this.timeLeft=this.params.timeLimit;
      this.points=0; this.chainLv=0; this.goalAwarded=false;
      this.state='playing'; this.paused=false; this.sel=null;
      this.fx.length=0; this.swapAnim=null;
      const ov=document.getElementById('gameOver'); if(ov) ov.style.display='none';

      this.grid=[]; for(let i=0;i<this.N;i++){ this.grid[i]=[]; for(let j=0;j<this.N;j++){ this.grid[i][j]=this.randomTile(i,j); } }
      this.addBlockers();

      let guard=0; while(!this.hasAnyMatchMove() && guard<50){ this.shuffle(); guard++; }
      this.updateHUD();
    }

    randomTile(i,j){
      let col = 1 + this.rnd(this.params.colors);
      if(i>=2 && this.grid[i-1] && this.grid[i-2]){
        if(this.grid[i-1][j]===this.grid[i-2][j] && this.grid[i-1][j]!==ROCK && this.grid[i-1][j]!==ICE){
          col = (this.grid[i-1][j]%this.params.colors)+1;
        }
      }
      if(j>=2){
        if(this.grid[i][j-1]===this.grid[i][j-2] && this.grid[i][j-1]!==ROCK && this.grid[i][j-1]!==ICE){
          col = (this.grid[i][j-1]%this.params.colors)+1;
        }
      }
      return col;
    }
    addBlockers(){
      for(let i=0;i<this.N;i++) for(let j=0;j<this.N;j++){
        if(Math.random()<this.params.rockRate) this.grid[i][j]=ROCK;
        else if(Math.random()<this.params.iceRate) this.grid[i][j]=ICE*10 + this.grid[i][j];
        else if(Math.random()<this.params.bombRate) this.grid[i][j]=BOMB*10 + (3 + (this.level>=80?1:0));
      }
    }

    select(x,y){ if(this.inBounds(x,y)) this.sel={x,y}; }

    trySwap(dir){
      if(!this.sel || this.swapAnim) return;
      let dx=0,dy=0; if(dir==='l')dx=-1; if(dir==='r')dx=1; if(dir==='u')dy=-1; if(dir==='d')dy=1;
      const x=this.sel.x, y=this.sel.y, nx=x+dx, ny=y+dy; if(!this.inBounds(nx,ny)) return;

      const animateSwap=(x1,y1,x2,y2,reverse=false)=> new Promise(res=>{
        const dur=140; const t0=performance.now();
        this.swapAnim={x1,y1,x2,y2,reverse,t0,dur,done:res};
      });

      animateSwap(x,y,nx,ny,false).then(()=>{
        this.swap(x,y,nx,ny);
        const found=this.findMatches().length>0;
        if(!found){
          animateSwap(x,y,nx,ny,true).then(()=>{ this.swap(x,y,nx,ny); if(this.level>=50) this.timeLeft=Math.max(0,this.timeLeft-1.5); });
        }else{
          this.sel=null; this.processCascade();
        }
      });
    }
    swap(x1,y1,x2,y2){ const t=this.grid[x1][y1]; this.grid[x1][y1]=this.grid[x2][y2]; this.grid[x2][y2]=t; }

    findMatches(){
      const res=[]; let i,j,cnt,val,prev,vType,pType,vCol,pCol,lastCol;
      for(j=0;j<this.N;j++){
        cnt=1;
        for(i=1;i<this.N;i++){
          val=this.grid[i][j]; prev=this.grid[i-1][j];
          vType=this.btype(val)===NORMAL? NORMAL: this.btype(val);
          pType=this.btype(prev)===NORMAL? NORMAL: this.btype(prev);
          vCol=this.bval(val); pCol=this.bval(prev);
          const eq=(vType===NORMAL && pType===NORMAL && vCol===pCol);
          if(eq) cnt++;
          else { if (cnt >= 3) { res.push({ dir: 'h', y: j, x: i - cnt, len: cnt, col: pCol }); } cnt = 1; }
        }
        if (cnt>=3){ lastCol=this.bval(this.grid[this.N-1][j]); res.push({dir:'h', y:j, x:this.N-cnt, len:cnt, col:lastCol}); }
      }
      for(i=0;i<this.N;i++){
        cnt=1;
        for(j=1;j<this.N;j++){
          val=this.grid[i][j]; prev=this.grid[i][j-1];
          vType=this.btype(val)===NORMAL? NORMAL: this.btype(val);
          pType=this.btype(prev)===NORMAL? NORMAL: this.btype(prev);
          vCol=this.bval(val); pCol=this.bval(prev);
          const eq=(vType===NORMAL && pType===NORMAL && vCol===pCol);
          if(eq) cnt++;
          else { if (cnt >= 3) { res.push({ dir: 'v', x: i, y: j - cnt, len: cnt, col: pCol }); }cnt = 1; }
        }
        if(cnt>=3){ lastCol=this.bval(this.grid[i][this.N-1]); res.push({dir:'v', x:i, y:this.N-cnt, len:cnt, col:lastCol}); }
      }
      return res;
    }

    resolveMatches(chainLv){
      const matches=this.findMatches(); if(matches.length===0) return {found:false};
      let cleared=0; const specials=[]; let basePoint=0;

      for(const m of matches){
        const sp=this.createSpecialFromMatch(m);
        const cx=m.dir==='h'? m.x+Math.floor(m.len/2): m.x;
        const cy=m.dir==='h'? m.y: m.y+Math.floor(m.len/2);
        if(sp) specials.push({ x: cx, y: cy, val: sp });

        const per = (m.len>=5)?24 : (m.len===4?14:8);
        basePoint += per;

        if(m.dir==='h'){
          for(let j=0;j<m.len;j++){
            const gx=m.x+j, gy=m.y;
            if(this.btype(this.grid[gx][gy])!==ROCK){
              this.spawnPop(gx,gy,this.bval(this.grid[gx][gy]));
              this.grid[gx][gy]=EMPTY; cleared++;
            }
          }
        } else {
          for(let j=0;j<m.len;j++){
            const gx=m.x, gy=m.y+j;
            if(this.btype(this.grid[gx][gy])!==ROCK){
              this.spawnPop(gx,gy,this.bval(this.grid[gx][gy]));
              this.grid[gx][gy]=EMPTY; cleared++;
            }
          }
        }
      }
      for(const s of specials){ this.grid[s.x][s.y]=s.val; }

      this.score += cleared*10*this.combo; this.combo++;
      const chainBonus = Math.min(0.6, Math.max(0, (chainLv-1)*0.2));
      const mult = difficultyMult();
      const earned = Math.floor(basePoint * (1+chainBonus) * mult);
      if(earned>0) this.addPoints(earned);

      if(!this.goalAwarded && this.score >= this.params.goalScore){
        this.goalAwarded = true;
        this.addPoints(Math.floor(100 * mult));
      }

      this.timeLeft = Math.min(this.params.timeLimit, this.timeLeft + Math.min(2, cleared*0.05));
      this.dropAndFill();
      return {found:true};
    }

    addPoints(p){
      this.points = Math.min(5000, this.points + p);
      this.updateHUD();
    }

    createSpecialFromMatch(m){
      if(m.len>=5) return RAINBOW*10 + m.col;
      if(m.len===4) return (m.dir==='h'? STRIPE_H: STRIPE_V)*10 + m.col;
      return 0;
    }

    processCascade(){
      this.chainLv=1;
      while(true){
        const r=this.resolveMatches(this.chainLv);
        if(!r.found) break;
        this.chainLv++;
      }
      this.chainLv=0;
    }

    dropAndFill(){
      for(let i=0;i<this.N;i++){
        for(let j=this.N-1;j>=0;j--){
          if(this.grid[i][j]===EMPTY){
            for(let k=j-1;k>=0;k--){ if(this.grid[i][k]!==EMPTY){ this.grid[i][j]=this.grid[i][k]; this.grid[i][k]=EMPTY; break; } }
            if(this.grid[i][j]===EMPTY){ this.grid[i][j]=this.randomTile(i,j); }
          }
        }
      }
      for(let i=0;i<this.N;i++) for(let j=0;j<this.N;j++){
        const v=this.grid[i][j];
        if(Math.floor(v/10)===BOMB){
          let n=v%10; n--;
          if(n<=0){ this.explodeAt(i,j); this.grid[i][j]=EMPTY; }
          else { this.grid[i][j]=BOMB*10+n; }
        }
      }
      if(!this.hasAnyMatchMove()) this.shuffle();
    }

    explodeAt(cx,cy){
      for(let i=cx-1;i<=cx+1;i++) for(let j=cy-1;j<=cy+1;j++)
        if(this.inBounds(i,j)){ if(this.btype(this.grid[i][j])!==ROCK){ this.spawnPop(i,j,this.bval(this.grid[i][j])); this.grid[i][j]=EMPTY; this.score+=5; } }
    }

    hasAnyMatchMove(){
      for(let x=0;x<this.N;x++) for(let y=0;y<this.N;y++){
        if(x+1<this.N){ this.swap(x,y,x+1,y); if(this.findMatches().length>0){ this.swap(x,y,x+1,y); return true; } this.swap(x,y,x+1,y); }
        if(y+1<this.N){ this.swap(x,y,x,y+1); if(this.findMatches().length>0){ this.swap(x,y,x,y+1); return true; } this.swap(x,y,x,y+1); }
      }
      return false;
    }
    shuffle(){
      const flat=[]; for(let i=0;i<this.N;i++) for(let j=0;j<this.N;j++) if(this.grid[i][j]!==ROCK) flat.push(this.grid[i][j]);
      for(let i=flat.length-1;i>0;i--){ const r=this.rnd(i+1); [flat[i],flat[r]]=[flat[r],flat[i]]; }
      let idx=0; for(let i=0;i<this.N;i++) for(let j=0;j<this.N;j++) if(this.grid[i][j]!==ROCK) this.grid[i][j]=flat[idx++];
    }

    spawnPop(gx,gy,colIdx){
      const pal=['#ffd166','#70ffa8','#8ea3ff','#ff6b6b','#f7a6ff','#9bf6ff','#ffe66d','#caffbf'];
      const col=pal[(Math.max(1,colIdx)-1)%pal.length];
      this.fx.push({gx,gy,tStart:this.last||performance.now(), col});
    }
    drawPops(ctx){
      const now=this.last||performance.now(); const DURATION=220;
      const keep=[]; for(const fx of this.fx){
        const k=(now-fx.tStart)/DURATION; if(k>=1) continue;
        const x=this.ox+(fx.gx+0.5)*this.step, y=this.oy+(fx.gy+0.5)*this.step;
        const r=this.step*0.45*(0.25+0.75*k);
        ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2);
        const v=parseInt(fx.col.slice(1),16), rr=(v>>16)&255, gg=(v>>8)&255, bb=v&255;
        ctx.fillStyle=`rgba(${rr},${gg},${bb},${(1-k)*0.6})`; ctx.fill();
        keep.push(fx);
      }
      this.fx=keep;
    }

    update(dt){
      if(this.paused||this.state==='over') return;
      this.timeLeft -= dt; if(this.timeLeft<=0){ this.timeLeft=0; this.gameOver(); }
      this.updateHUD();
    }

    draw(){
      const ctx=this.ctx, d=this.DPR();
      ctx.clearRect(0,0,this.c.width,this.c.height);

      const g=ctx.createLinearGradient(0,0,0,this.c.height);
      g.addColorStop(0,'#0b1440'); g.addColorStop(1,'#070c22');
      ctx.fillStyle=g; ctx.fillRect(0,0,this.c.width,this.c.height);

      const s=Math.min(this.c.width,this.c.height); const x0=this.ox, y0=this.oy; this.step=s/this.N;

      for(let i=0;i<this.N;i++) for(let j=0;j<this.N;j++){
        const v=this.grid[i][j]; const bt=this.btype(v); const val=this.bval(v);
        let x=x0+i*this.step, y=y0+j*this.step;

        if(this.swapAnim){
          const a=this.swapAnim, now=performance.now();
          let t=(now-a.t0)/a.dur; t=Math.max(0,Math.min(1,t));
          const dirX=a.x2-a.x1, dirY=a.y2-a.y1;
          const off = (i===a.x1&&j===a.y1)? (a.reverse?1-t:t) : (i===a.x2&&j===a.y2? (a.reverse?1-t:t)*-1 : 0);
          if(off!==0){ x += off*dirX*this.step; y += off*dirY*this.step; }
          if(t>=1){ const done=a.done; this.swapAnim=null; if(done) done(); }
        }

        ctx.strokeStyle='#283273'; ctx.strokeRect(x,y,this.step,this.step);
        if(v===EMPTY) continue;
        const pal=['#ffd166','#70ffa8','#8ea3ff','#ff6b6b','#f7a6ff','#9bf6ff','#ffe66d','#caffbf'];
        const col=pal[(val-1)%pal.length];
        ctx.fillStyle= bt===ROCK? '#444a66' : bt===ICE? '#a7d8ff' : bt===STRIPE_H||bt===STRIPE_V? '#fff2' : bt===BOMB? '#ff9aa6' : bt===RAINBOW? '#ffffff' : col;
        ctx.fillRect(x+4,y+4,this.step-8,this.step-8);
        ctx.strokeStyle='#0006'; ctx.strokeRect(x+4,y+4,this.step-8,this.step-8);
        ctx.fillStyle='#001'; ctx.font=(12*d)+'px ui-sans-serif'; ctx.textAlign='center'; ctx.textBaseline='middle';
        if(bt===STRIPE_H) ctx.fillText('\u2014', x+this.step/2, y+this.step/2);
        else if(bt===STRIPE_V) ctx.fillText('|', x+this.step/2, y+this.step/2);
        else if(bt===BOMB) ctx.fillText(String(v%10), x+this.step/2, y+this.step/2);
        else if(bt===RAINBOW) ctx.fillText('*', x+this.step/2, y+this.step/2);
        else if(bt===ICE) ctx.fillText('\u2744', x+this.step/2, y+this.step/2);
        else if(bt===ROCK) ctx.fillText('\u25A0', x+this.step/2, y+this.step/2);
        if(this.sel && this.sel.x===i && this.sel.y===j && !this.swapAnim){
          ctx.strokeStyle='#8ea3ff'; ctx.lineWidth=3; ctx.strokeRect(x+3,y+3,this.step-6,this.step-6); ctx.lineWidth=1;
        }
      }

      this.drawPops(ctx);

      ctx.globalAlpha=0.12; ctx.fillStyle='#000';
      for(let yy=0; yy<this.c.height; yy+=2*d){ ctx.fillRect(0,yy,this.c.width,1*d); }
      ctx.globalAlpha=1;
    }

    run(ts){ const dt=(ts-(this.last||ts))/1000; this.last=ts; this.update(Math.min(dt,0.033)); this.draw(); requestAnimationFrame((t)=>this.run(t)); }

    gameOver(manual=false){
      this.state='over';
      if(this.score>this.best){ this.best=this.score; localStorage.setItem(LS_KEYS.best, String(this.best)); }
      addRecord(this.score, this.points); addPlay();
      const ov=document.getElementById('gameOver'); if(ov) ov.style.display='flex';
      notifyFinish(this.score|0);
    }
  }

  const m3=new Match3(document.getElementById('game'));
  (function initUI(){
    const tier=$('#tier'), lvl=$('#lvlRange');
    const applyTier=(t)=>{ let lv={beginner:1,intermediate:11,advanced:21,hell:40,doom:50,insane:100}[t]||1; lvl.value=lv; m3.setLevel(lv); };
    applyTier(tier.value);
    lvl.addEventListener('input',()=> m3.setLevel(+lvl.value));
    updateTicketUI();
  })();
})();

/***** Cabinet fit *****/
function fitCabinet(){
  const cab = document.querySelector('.cabinet'); if(!cab) return;
  const margin = 16;
  cab.style.transform='none';
  const w=cab.offsetWidth, h=cab.offsetHeight;
  const scale = Math.min(1, (window.innerWidth - margin*2)/w, (window.innerHeight - margin*2)/h);
  cab.style.transform = 'scale('+scale+')';
}
window.addEventListener('resize', ()=>requestAnimationFrame(fitCabinet), {passive:true});
window.addEventListener('orientationchange', ()=>requestAnimationFrame(fitCabinet), {passive:true});
setTimeout(fitCabinet, 0);

/***** ÏÑ∏ÏÖò ÌõÖ(ÏïàÏ†Ñ ÎûòÌçº) *****/
function notifyStart(){ try{ if (typeof window.gameStart === 'function') window.gameStart('match-3'); }catch(e){} }
function notifyFinish(finalScore){ try{ if (typeof window.gameFinish === 'function') window.gameFinish('match-3', finalScore|0); }catch(e){} }

/***** Í∞ÄÏãúÏÑ± ÌõÖ *****/
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    // ÌïÑÏöî Ïãú ÏùºÏãúÏ†ïÏßÄ, Î°úÍπÖ Îì± Ïó∞Í≤∞ ÏßÄÏ†ê
  }
});
</script>

  <div id="cookieBanner" class="cookie-banner" role="dialog" aria-live="polite" aria-label="Analytics consent">
    <div>Do you agree with the use of analysis (cookie) to improve service quality?</div>
    <div class="spacer"></div>
    <button class="deny" type="button">Refusal</button>
    <button class="agree" type="button">Consent</button>
  </div>


  <script>
  (function(){
    try{
      var KEY='rg_analytics_consent';
      function init(){ if(typeof window.analyticsInit==='function') window.analyticsInit(); }
      var v=null; try{ v=localStorage.getItem(KEY); }catch(e){}
      var el=document.getElementById('cookieBanner');
      if(v==='yes'){ init(); if(el) el.style.display='none'; return; }
      if(!el){ return; } // no banner -> do not init
      el.style.display='flex';
      var agree=el.querySelector('.agree'), deny=el.querySelector('.deny');
      if(agree) agree.addEventListener('click', function(){
        try{ localStorage.setItem(KEY,'yes'); }catch(e){}
        el.style.display='none'; init();
      });
      if(deny) deny.addEventListener('click', function(){
        try{ localStorage.setItem(KEY,'no'); }catch(e){}
        el.style.display='none';
      });
    }catch(e){ /* no-op */ }
  })();
  </script>

  
  <div id="site-footer"></div>
</body>
</html>
